/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var pe=Object.defineProperty;var Qe=Object.getOwnPropertyDescriptor;var Ge=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Ze=(o,n)=>()=>(o&&(n=o(o=0)),n);var ve=(o,n)=>{for(var e in n)pe(o,e,{get:n[e],enumerable:!0})},Ke=(o,n,e,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of Ge(n))!Ye.call(o,t)&&t!==e&&pe(o,t,{get:()=>n[t],enumerable:!(s=Qe(n,t))||s.enumerable});return o};var we=o=>Ke(pe({},"__esModule",{value:!0}),o);var Pe={};ve(Pe,{getCMSViewOptions:()=>Je,readCMSSettings:()=>A});function A(o,n){var e,s,t,i,a,r,l,c,p,u,d,h,v,b,E,f;return{titleProperty:o.get("titleProperty")||"",descriptionProperty:o.get("descriptionProperty")||"",imageProperty:o.get("imageProperty")||"",showTitle:(e=o.get("showTitle"))!=null?e:!0,showDate:(s=o.get("showDate"))!=null?s:!1,dateProperty:o.get("dateProperty")||"",showTextPreview:(t=o.get("showTextPreview"))!=null?t:!0,fallbackToContent:(i=o.get("fallbackToContent"))!=null?i:!0,fallbackToEmbeds:(a=o.get("fallbackToEmbeds"))!=null?a:!1,propertyDisplay1:o.get("propertyDisplay1")||"",propertyDisplay2:o.get("propertyDisplay2")||"",propertyDisplay3:o.get("propertyDisplay3")||"",propertyDisplay4:o.get("propertyDisplay4")||"",propertyLayout12SideBySide:(r=o.get("propertyLayout12SideBySide"))!=null?r:!1,propertyLayout34SideBySide:(l=o.get("propertyLayout34SideBySide"))!=null?l:!1,imageFormat:o.get("imageFormat")||"thumbnail",propertyLabels:o.get("propertyLabels")||"hide",showDraftStatus:(c=o.get("showDraftStatus"))!=null?c:!1,draftStatusProperty:o.get("draftStatusProperty")||"",draftStatusReverse:(p=o.get("draftStatusReverse"))!=null?p:!1,draftStatusUseFilenamePrefix:(u=o.get("draftStatusUseFilenamePrefix"))!=null?u:!1,showTags:(d=o.get("showTags"))!=null?d:!1,tagsProperty:o.get("tagsProperty")||"",maxTagsToShow:(h=o.get("maxTagsToShow"))!=null?h:3,customizeNewButton:(v=o.get("customizeNewButton"))!=null?v:!1,newNoteLocation:o.get("newNoteLocation")||"",hideQuickEditIcon:(b=o.get("hideQuickEditIcon"))!=null?b:!1,cardSize:(E=o.get("cardSize"))!=null?E:250,imageAspectRatio:(f=o.get("imageAspectRatio"))!=null?f:.55}}function Je(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Filename underscore prefix as draft indicator",key:"draftStatusUseFilenamePrefix",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"slider",displayName:"Maximum tags to show",key:"maxTagsToShow",min:1,max:50,step:1,default:3,showWhen:{key:"showTags",value:!0}},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""},{type:"toggle",displayName:"Hide quick edit icon",key:"hideQuickEditIcon",default:!1}]}var K=Ze(()=>{"use strict"});var ft={};ve(ft,{default:()=>le});module.exports=we(ft);var We=require("obsidian");var x=require("obsidian");var Ee=require("obsidian"),Y=class extends Ee.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){let e=this.app.commands,s=new Map;if(e&&typeof e.listCommands=="function")try{let i=e.listCommands();for(let a of i)a&&a.id&&a.name&&!s.has(a.id)&&s.set(a.id,{id:a.id,name:a.name})}catch(i){console.warn("[Bases CMS] Error getting commands via listCommands():",i)}try{let i=e.commands;if(i&&typeof i=="object"){let a=Object.values(i);for(let r of a)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via registry:",i)}try{let i=e.commandRegistry;if(i&&typeof i=="object"){let a=Object.values(i);for(let r of a)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via internal registry:",i)}let t=Array.from(s.values());return t.sort((i,a)=>i.name.localeCompare(a.name)),t}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.createDiv({cls:"suggestion-title",text:t.name})}};var Z=class extends x.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}refreshActiveToolbars(){this.plugin&&typeof this.plugin.refreshAllToolbars=="function"&&this.plugin.refreshAllToolbars()}display(){let{containerEl:e}=this;e.empty(),new x.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations").addToggle(i=>i.setValue(this.plugin.settings.confirmBulkOperations).onChange(async a=>{this.plugin.settings.confirmBulkOperations=a,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Toolbar buttons"}),new x.Setting(e).setName("Show select all button").setDesc("Display the select all button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarSelectAll).onChange(async a=>{this.plugin.settings.showToolbarSelectAll=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show clear button").setDesc("Display the clear selection button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarClear).onChange(async a=>{this.plugin.settings.showToolbarClear=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show publish button").setDesc("Display the publish button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarPublish).onChange(async a=>{this.plugin.settings.showToolbarPublish=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show draft button").setDesc("Display the draft button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarDraft).onChange(async a=>{this.plugin.settings.showToolbarDraft=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show tags button").setDesc("Display the tags button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarTags).onChange(async a=>{this.plugin.settings.showToolbarTags=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show set button").setDesc("Display the set property button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarSet).onChange(async a=>{this.plugin.settings.showToolbarSet=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show remove button").setDesc("Display the remove property button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarRemove).onChange(async a=>{this.plugin.settings.showToolbarRemove=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),new x.Setting(e).setName("Show delete button").setDesc("Display the delete button in the CMS toolbar").addToggle(i=>i.setValue(this.plugin.settings.showToolbarDelete).onChange(async a=>{this.plugin.settings.showToolbarDelete=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()})),e.createEl("h3",{text:"Deletions"}),new x.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder and all its contents if the note filename matches the specified name").addToggle(i=>i.setValue(this.plugin.settings.deleteParentFolder).onChange(async a=>{this.plugin.settings.deleteParentFolder=a,await this.plugin.saveData(this.plugin.settings)})),new x.Setting(e).setName("Folder deletion filename").setDesc('Filename that triggers parent folder deletion (e.g., "index")').addText(i=>i.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(async a=>{this.plugin.settings.deleteParentFolderFilename=a,await this.plugin.saveData(this.plugin.settings)})).setDisabled(!this.plugin.settings.deleteParentFolder),new x.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(i=>i.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(async a=>{this.plugin.settings.deleteUniqueAttachments=a,await this.plugin.saveData(this.plugin.settings)})),new x.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files").addToggle(i=>i.setValue(this.plugin.settings.confirmDeletions).onChange(async a=>{this.plugin.settings.confirmDeletions=a,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Appearance"}),new x.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(i=>i.setValue(this.plugin.settings.useHomeIcon).onChange(async a=>{this.plugin.settings.useHomeIcon=a,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Quick edit"});let s=new x.Setting(e).setName("Enable quick edit").setDesc("Show a pencil icon on card titles that launches a command when clicked").addToggle(i=>i.setValue(this.plugin.settings.enableQuickEdit).onChange(async a=>{this.plugin.settings.enableQuickEdit=a,await this.plugin.saveData(this.plugin.settings),t.settingEl.style.display=a?"":"none"})),t=new x.Setting(e).setName("Quick edit command").setDesc("The Obsidian command to execute when clicking the quick edit icon on a card title").addButton(i=>{var r;let a=this.plugin.settings.quickEditCommandName||(this.plugin.settings.quickEditCommand?"Select command...":"No command selected");if(i.setButtonText(a).onClick(()=>{new Y(this.app,async c=>{let p=this.app.commands,u="";if(p){if(typeof p.listCommands=="function"){let h=p.listCommands().find(v=>v.id===c);h&&(u=h.name)}if(!u){let d=p.commands;d&&d[c]&&(u=d[c].name||"")}}this.plugin.settings.quickEditCommand=c,this.plugin.settings.quickEditCommandName=u,await this.plugin.saveData(this.plugin.settings),this.display()}).open()}),this.plugin.settings.quickEditCommand){let l=(r=i.buttonEl.parentElement)==null?void 0:r.createEl("button",{text:"Clear",attr:{style:"margin-left: 8px;"}});l==null||l.addEventListener("click",async()=>{this.plugin.settings.quickEditCommand="",this.plugin.settings.quickEditCommandName="",await this.plugin.saveData(this.plugin.settings),this.display()})}});t.settingEl.style.display=this.plugin.settings.enableQuickEdit?"":"none"}};var Te={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,enableQuickEdit:!1,quickEditCommand:"",quickEditCommandName:"",showToolbarSelectAll:!0,showToolbarClear:!0,showToolbarDraft:!0,showToolbarPublish:!0,showToolbarTags:!0,showToolbarSet:!0,showToolbarRemove:!0,showToolbarDelete:!0};var H=require("obsidian");function M(o,n){if(!n||!n.trim())return null;let e=n.split(",").map(s=>s.trim()).filter(s=>s);for(let s of e){let t=o.getValue(s),i=t;if(i&&("date"in i&&i.date instanceof Date||"data"in i))return t}return null}function Se(o,n){if(!n||!n.trim())return[];let e=n.split(",")[0].trim();if(!e)return[];let s=o.getValue(e);if(!s||!("data"in s))return[];let t=s.data,i=[];if(Array.isArray(t)){for(let a of t)if(typeof a=="string"||typeof a=="number"){let r=String(a);if(r&&r.trim()){i.push(r);break}}}else if(t!=null&&t!==""&&(typeof t=="string"||typeof t=="number")){let a=String(t);a.trim()&&i.push(a)}return i}function Ce(o,n,e,s){if(!o||o==="")return"";if(e&&typeof e.getDisplayName=="function")try{let t=e.getDisplayName(o);if(t&&typeof t=="string"&&t.trim()!=="")return t}catch(t){}return o}function Xe(o,n,e,s,t,i,a){let r=o.file.basename||o.file.name,l=M(o,n.titleProperty),c=l==null?void 0:l.data,p=c!=null&&c!==""&&(typeof c=="string"||typeof c=="number")?String(c):r,u=o.file.path,d=u.split("/").slice(0,-1).join("/"),h=o.getValue("note.tags"),v=[];if(h&&h.data!=null){let y=h.data;v=(Array.isArray(y)?y.map(g=>g&&typeof g=="object"&&"data"in g?String(g.data):typeof g=="string"||typeof g=="number"?String(g):"").filter(g=>g):typeof y=="string"||typeof y=="number"?[String(y)]:[]).map(g=>g.replace(/^#/,""))}let b=o.getValue("file.tags"),E=[];if(b&&b.data!=null){let y=b.data;E=(Array.isArray(y)?y.map(g=>g&&typeof g=="object"&&g!==null&&"data"in g?String(g.data):typeof g=="string"||typeof g=="number"?String(g):"").filter(g=>typeof g=="string"&&g.length>0):typeof y=="string"||typeof y=="number"?[String(y)]:[]).map(g=>g.replace(/^#/,""))}let f=o.file.stat.ctime,m=o.file.stat.mtime,T=[];if(n.showTags&&n.tagsProperty){let y=M(o,n.tagsProperty);if(y&&y.data!=null){let k=y.data;Array.isArray(k)?T=k.map(g=>g&&typeof g=="object"&&"data"in g?String(g.data):typeof g=="string"||typeof g=="number"?String(g):"").filter(g=>typeof g=="string"&&g.length>0):(typeof k=="string"||typeof k=="number")&&(T=[String(k)])}}let S={path:u,name:r,title:p,tags:E,yamlTags:v,ctime:f,mtime:m,folderPath:d,snippet:t,imageUrl:i,hasImageAvailable:a||!1,displayTags:T.length>0?T:void 0},C=[n.propertyDisplay1,n.propertyDisplay2,n.propertyDisplay3,n.propertyDisplay4],F=new Set,w=C.map(y=>!y||y===""||F.has(y)?"":(F.add(y),y));return S.propertyName1=w[0]||void 0,S.propertyName2=w[1]||void 0,S.propertyName3=w[2]||void 0,S.propertyName4=w[3]||void 0,S.property1=w[0]?q(w[0],o,S,n):null,S.property2=w[1]?q(w[1],o,S,n):null,S.property3=w[2]?q(w[2],o,S,n):null,S.property4=w[3]?q(w[3],o,S,n):null,S}function ke(o,n,e,s,t,i,a){return o.map(r=>Xe(r,n,e,s,t[r.file.path],i[r.file.path],a[r.file.path]))}function q(o,n,e,s){if(!o||o==="")return null;if(o==="file.path"||o==="file path")return e.folderPath||null;if(o==="tags"||o==="note.tags")return e.yamlTags.length>0?"tags":null;if(o==="file.tags"||o==="file tags")return e.tags.length>0?"tags":null;if(o==="file.ctime"||o==="created time")return new Date(e.ctime).toLocaleDateString();if(o==="file.mtime"||o==="modified time")return new Date(e.mtime).toLocaleDateString();let t=M(n,o);if(!t)return null;let i=t;if(!i)return null;if("date"in i&&i.date instanceof Date)return i.date.toLocaleDateString();let a=i.data;return a==null||a===""?null:Array.isArray(a)?a.length===0?null:a.map(r=>r&&typeof r=="object"&&"data"in r?String(r.data):String(r)).filter(r=>r&&r.trim()!=="").join(", "):typeof a=="string"||typeof a=="number"||typeof a=="boolean"?String(a):null}K();function xe(o){return/^https?:\/\//i.test(o)}function he(o){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(o)}function De(o){return new Promise(n=>{let e=new Image;e.onload=()=>n(!0),e.onerror=()=>n(!1),setTimeout(()=>n(!1),5e3),e.src=o})}function et(o){let n=o.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return n?n[1].trim():o}async function Fe(o){let n=[],e=[];for(let a of o){let r=et(a);r.length!==0&&(xe(r)?(he(r)||!r.includes("."))&&e.push(r):he(r)&&n.push(r))}let s=e.map(a=>De(a).then(r=>r?a:null)),i=(await Promise.all(s)).filter(a=>a!==null);return{internalPaths:n,externalUrls:i}}function Ae(o,n,e){let s=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],t=[];for(let i of o){let a=e.metadataCache.getFirstLinkpathDest(i,n);if(a&&s.includes(a.extension)){let r=e.vault.getResourcePath(a);t.push(r)}}return t}async function de(o,n){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=n.metadataCache.getFileCache(o);if(!(s!=null&&s.embeds))return[];let t=[],i=[];for(let c of s.embeds){let p=c.link;if(xe(p))(he(p)||!p.includes("."))&&i.push(p);else{let u=n.metadataCache.getFirstLinkpathDest(p,o.path);if(u&&e.includes(u.extension)){let d=n.vault.getResourcePath(u);t.push(d)}}}let a=i.map(c=>De(c).then(p=>p?c:null)),l=(await Promise.all(a)).filter(c=>c!==null);return[...t,...l]}var tt=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function st(o){let n=new Map,e=0;return{text:o.replace(/\\(.)/g,(t,i)=>{let a=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return n.set(a,i),e++,a}),map:n}}function it(o,n){let e=o;return n.forEach((s,t)=>{e=e.split(t).join(s)}),e}function at(o){let n=o,e=!0;for(;e;){e=!1;let s=n.match(/^([`~]{3,})/m);if(!s)break;let t=s[1][0],i=s[1].length,a=s.index,r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`^${r}{${i}}\\s*$`,"m"),p=n.substring(a+s[1].length).match(l);if(p){let d=a+s[1].length+p.index+p[0].length;n=n.substring(0,a)+n.substring(d),e=!0}else{let u=n.indexOf(`
`,a);u===-1?n=n.substring(0,a):n=n.substring(0,a)+n.substring(u+1),e=!0}}return n}function nt(o){if(!o||o.trim().length===0)return"";o=o.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),o=o.replace(/^>\s?/gm,"");let{text:n,map:e}=st(o),s=at(n);return tt.forEach(t=>{s=s.replace(t,(i,...a)=>{if(i.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return a[1]||"";if(a.length>0&&a[0]!==void 0){for(let r=0;r<a.length-2;r++)if(typeof a[r]=="string")return a[r]}return""})}),s=it(s,e),s}function ot(o,n=!1,e,s){let t=o.replace(/^---[\s\S]*?---/,"").trim(),i=nt(t),a=i.indexOf(`
`),r=(a!==-1?i.substring(0,a):i).trim();(n||e&&r===e||s&&r===s)&&(i=a!==-1?i.substring(a+1).trim():"");let l=i.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(u=>u).join(" ").trim().replace(/\.{2,}/g,u=>u.replace(/\./g,"\u2024")),c=l.length>500,p=l.substring(0,500);return c&&(p+="\u2026"),p}async function Me(o,n,e,s,t,i){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(s.fallbackToContent){let r=await n.vault.cachedRead(o);return ot(r,s.omitFirstLine,t,i)}return""}async function rt(o,n,e,s,t,i,a){if(!(o in i))try{let{internalPaths:r,externalUrls:l}=await Fe(s),c=[...Ae(r,o,e),...l];c.length===0&&t&&(c=await de(n,e)),c.length>0&&(i[o]=c.length>1?c:c[0],a[o]=!0)}catch(r){console.error(`Failed to load image for ${o}:`,r)}}async function ue(o,n,e,s,t){let i=o.filter(r=>!(r.path in s)),a=50;for(let r=0;r<i.length;r+=a){let l=i.slice(r,r+a);await Promise.all(l.map(async c=>{await rt(c.path,c.file,e,c.imagePropertyValues,n,s,t)}))}}async function Le(o,n,e,s){await Promise.all(o.map(async t=>{if(!(t.path in e||s[t.path]))try{let i=await de(t.file,n);i.length>0&&(e[t.path]=i.length>1?i:i[0],s[t.path]=!0)}catch(i){console.error(`Failed to load embed images for ${t.path}:`,i)}}))}async function Be(o,n,e,s,t){await Promise.all(o.map(async i=>{if(!(i.path in t))try{i.file.extension==="md"?t[i.path]=await Me(i.file,s,i.descriptionData,{fallbackToContent:n,omitFirstLine:e},i.fileName,i.titleString):t[i.path]=""}catch(a){console.error(`Failed to load snippet for ${i.path}:`,a),t[i.path]=""}}))}var j=require("obsidian");function lt(o,n){let e=null,s=!1;if(n.draftStatusUseFilenamePrefix&&o.file&&o.file.name)e=o.file.name.startsWith("_"),s=n.draftStatusReverse?!e:e;else if(n.draftStatusProperty){let t=M(o,n.draftStatusProperty);if(t){let i=t;i&&"data"in i&&typeof i.data=="boolean"&&(e=i.data,s=n.draftStatusReverse?!e:e)}}return{booleanValue:e,isDraft:s}}function X(o,n,e,s,t){if(!s.showDraftStatus)return;let{booleanValue:i,isDraft:a}=lt(n,s);if(i!==null){let r=o.createDiv("card-status-badge");a?(r.addClass("status-draft"),r.appendText("Draft")):(r.addClass("status-published"),r.appendText("Published")),t&&(r.style.cursor="pointer",r.addEventListener("click",async l=>{l.stopPropagation(),await t(e,"draft",!i)}))}}var J=require("obsidian");function Ie(o,n,e,s,t,i){if(!n.settings.enableQuickEdit||!n.settings.quickEditCommand||n.settings.quickEditCommand===""||i.hideQuickEditIcon)return;let a=e.createSpan("bases-cms-quick-edit-icon");a.style.cursor="default",(0,J.setIcon)(a,"pencil-line"),e.addEventListener("click",r=>{a.contains(r.target)&&(r.stopPropagation(),r.stopImmediatePropagation())},!0),s.addEventListener("click",async r=>{var p,u,d;let l=r.target;if(!a.contains(l)&&!l.closest(".bases-cms-quick-edit-icon"))return;r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault();let c=o.vault.getAbstractFileByPath(t);if(c instanceof J.TFile){let h=n.settings.quickEditCommand,v=!1;try{let b=null,E=h;if(h.includes(":")){let f=h.split(":");b=f[0],E=f.slice(1).join(":")}else{let f=o.commands,m=(p=f==null?void 0:f.commands)==null?void 0:p[h];if(m){let T=m.plugin||m.sourcePlugin;T&&(b=((u=T.manifest)==null?void 0:u.id)||T.pluginId)}}if(b){let f=o.plugins,m=(d=f==null?void 0:f.plugins)==null?void 0:d[b];if(m){let T=E.split("-").map((S,C)=>C===0?S:S.charAt(0).toUpperCase()+S.slice(1)).join("")+"ByPath";if(typeof m[T]=="function"){await m[T](t),v=!0;return}}}}catch(b){}if(!v)try{await o.commands.executeCommandById(n.settings.quickEditCommand);return}catch(b){let E=o.workspace.getLeaf(!1);await E.openFile(c);let f=()=>{let m=E.view;m&&"editor"in m&&m.editor?setTimeout(async()=>{try{await o.commands.executeCommandById(n.settings.quickEditCommand)}catch(T){}},100):setTimeout(f,50)};f()}}},!0),a.addEventListener("mousedown",r=>{r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault()},!0)}var ee=class{constructor(n,e,s,t,i,a){this.app=n;this.plugin=e;this.propertyObservers=s;this.updateLayoutRef=t;this.basesConfig=i,this.basesController=a}renderCard(n,e,s,t,i,a,r,l){let c=n.createDiv("card bases-cms-card");t.imageFormat==="cover"?c.classList.add("image-format-cover"):t.imageFormat==="thumbnail"&&c.classList.add("image-format-thumbnail"),c.setAttribute("data-path",e.path),c.setAttribute("data-href",e.path),c.style.cursor="pointer";let p=c.createDiv("bases-cms-select-checkbox"),u=p.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(u.checked=a,u.addEventListener("change",d=>{d.stopPropagation(),d.stopImmediatePropagation(),r(e.path,u.checked)}),u.addEventListener("click",d=>{d.stopPropagation(),d.stopImmediatePropagation()}),t.showDraftStatus&&t.imageFormat!=="cover"&&X(c,s,e.path,t,l),c.addEventListener("click",d=>{let h=d.target;if(h.closest(".bases-cms-quick-edit-icon")){d.stopPropagation(),d.stopImmediatePropagation(),d.preventDefault();return}if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge"))return;let b=d.metaKey||d.ctrlKey;this.app.workspace.openLinkText(e.path,"",b)}),c.addEventListener("contextmenu",d=>{let h=d.target;if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge")||h.closest(".bases-cms-quick-edit-icon"))return;let v=this.app.vault.getAbstractFileByPath(e.path);if(v&&v instanceof j.TFile){d.stopPropagation();let b=new j.Menu;this.app.workspace.trigger("file-menu",b,v,"bases"),b.showAtMouseEvent(d)}}),t.showTitle){let d=c.createDiv("card-title");d.appendText(e.title),Ie(this.app,this.plugin,d,c,e.path,t)}if(t.showDate&&t.dateProperty){let d=M(s,t.dateProperty);if(d){let h=d,v="";if(h&&"date"in h&&h.date instanceof Date)v=h.date.toLocaleDateString();else if(h&&"data"in h&&h.data){let b=h.data;if(b instanceof Date)v=b.toLocaleDateString();else if(typeof b=="string"||typeof b=="number"){let E=new Date(b);isNaN(E.getTime())?v=String(b):v=E.toLocaleDateString()}}v&&c.createDiv("card-date").appendText(v)}}if(t.showTextPreview||t.showTags&&e.displayTags&&e.displayTags.length>0||t.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||t.imageFormat==="cover"){let d=c.createDiv("card-content");if(t.imageFormat==="thumbnail"){let h=d.createDiv("card-text-wrapper");if(t.showTextPreview){let v=h.createDiv("card-text-preview");e.snippet&&v.setText(e.snippet),c.__textPreviewEl=v,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let v=h.createDiv("card-tags"),b=t.maxTagsToShow,E=e.displayTags.slice(0,b),f=e.displayTags.length-b;E.forEach(m=>{v.createSpan("card-tag").appendText(m)}),f>0&&v.createSpan("card-tag-more").appendText(`+${f} more`)}}else{if(t.showTextPreview){let h=d.createDiv("card-text-preview");e.snippet&&h.setText(e.snippet),c.__textPreviewEl=h,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let h=d.createDiv("card-tags"),v=t.maxTagsToShow,b=e.displayTags.slice(0,v),E=e.displayTags.length-v;b.forEach(f=>{h.createSpan("card-tag").appendText(f)}),E>0&&h.createSpan("card-tag-more").appendText(`+${E} more`)}}if(t.imageFormat!=="none"&&e.imageUrl){let v=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(f=>f&&typeof f=="string"&&f.trim().length>0),b=t.imageFormat==="cover"?"card-cover":"card-thumbnail",E=d.createDiv(b);if(v.length>0){let f=E.createDiv("image-embed"),m=f.createEl("img",{attr:{alt:"",decoding:"async",sizes:t.imageFormat==="cover"?"100vw":"80px"}});return f.style.setProperty("--cover-image-url",`url("${v[0]}")`),t.showDraftStatus&&t.imageFormat==="cover"&&X(E,s,e.path,t,l),this.renderProperties(c,e,s,t,l),{img:m,src:v[0]}}}else if(t.imageFormat==="cover"){let h=d.createDiv("card-cover-placeholder");X(h,s,e.path,t,l)}}return this.renderProperties(c,e,s,t,l),null}renderProperties(n,e,s,t,i){let a=[t.propertyDisplay1,t.propertyDisplay2,t.propertyDisplay3,t.propertyDisplay4],r=new Set,l=a.map(h=>!h||h===""||r.has(h)?"":(r.add(h),h)),c=l.map(h=>h?q(h,s,e,t):null),p=l[0]!==""||l[1]!=="",u=l[2]!==""||l[3]!=="";if(!p&&!u)return;let d=n.createDiv("card-properties properties-4field");if(p){let h=d.createDiv("property-row property-row-1");t.propertyLayout12SideBySide&&h.addClass("property-row-side-by-side");let v=h.createDiv("property-field property-field-1");l[0]&&this.renderPropertyContent(v,l[0],c[0],e,s,t,i);let b=h.createDiv("property-field property-field-2");l[1]&&this.renderPropertyContent(b,l[1],c[1],e,s,t,i)}if(u){let h=d.createDiv("property-row property-row-2");t.propertyLayout34SideBySide&&h.addClass("property-row-side-by-side");let v=h.createDiv("property-field property-field-3");l[2]&&this.renderPropertyContent(v,l[2],c[2],e,s,t,i);let b=h.createDiv("property-field property-field-4");l[3]&&this.renderPropertyContent(b,l[3],c[3],e,s,t,i)}}renderPropertyContent(n,e,s,t,i,a,r){if(e===""||!s&&a.propertyLabels==="hide"||a.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&t.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&t.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&t.folderPath.length===0))return;let l=Ce(e,this.app,this.basesConfig,this.basesController),c=l.toLowerCase()!==e.toLowerCase();if(a.propertyLabels==="above"){let d=n.createDiv("property-label");c&&d.addClass("property-label-custom"),d.textContent=l}let p=n.createDiv("property-content");if(a.propertyLabels==="inline"){let d=p.createSpan("property-label-inline");d.textContent=l+": "}if(!s){p.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")p.createSpan().appendText(s);else if((e==="tags"||e==="note.tags")&&t.yamlTags.length>0){let d=p.createDiv("tags-wrapper");t.yamlTags.forEach(h=>{d.createEl("a",{cls:"tag",text:h,href:"#"}).addEventListener("click",b=>{var f,m,T;b.preventDefault();let E=(m=(f=this.app.internalPlugins)==null?void 0:f.plugins)==null?void 0:m["global-search"];(T=E==null?void 0:E.instance)!=null&&T.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+h)})})}else if((e==="file.tags"||e==="file tags")&&t.tags.length>0){let d=p.createDiv("tags-wrapper");t.tags.forEach(h=>{d.createEl("a",{cls:"tag",text:h,href:"#"}).addEventListener("click",b=>{var f,m,T;b.preventDefault();let E=(m=(f=this.app.internalPlugins)==null?void 0:f.plugins)==null?void 0:m["global-search"];(T=E==null?void 0:E.instance)!=null&&T.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+h)})})}else if((e==="file.path"||e==="path"||e==="file path")&&t.path.length>0){let d=p.createDiv("path-wrapper"),h=t.path.split("/").filter(v=>v);h.forEach((v,b)=>{let E=d.createSpan(),f=b===h.length-1,m=f?"path-segment filename-segment":"path-segment file-path-segment";E.createSpan({cls:m,text:v}).addEventListener("click",S=>{if(S.stopPropagation(),f){let C=this.app.vault.getAbstractFileByPath(t.path);C instanceof j.TFile&&this.app.workspace.getLeaf(!1).openFile(C)}}),b<h.length-1&&E.createSpan({cls:"path-separator",text:"/"})})}else{let d=this.app.metadataCache,v=((typeof d.getAllPropertyInfos=="function"?d.getAllPropertyInfos():{})||{})[e.toLowerCase()],b=i.getValue(e);if(((v==null?void 0:v.widget)==="checkbox"||b&&"data"in b&&typeof b.data=="boolean")&&r){let f=p.createEl("input",{type:"checkbox",cls:"checkbox-input"});f.checked=b&&"data"in b?Boolean(b.data):!1;let m=e.startsWith("note.")?e.substring(5):e;p.createSpan({cls:"checkbox-label",text:m}),f.addEventListener("click",T=>{T.stopPropagation()}),f.addEventListener("change",async T=>{T.stopPropagation();try{let S=e.startsWith("note.")?e.substring(5):e;await r(t.path,S,f.checked)}catch(S){console.error("Error toggling property:",S),f.checked=!f.checked}})}else p.createDiv("text-wrapper").appendText(s)}(!p.textContent||p.textContent.trim().length===0)&&p.remove()}};var ze=require("obsidian");var O=require("obsidian");async function ge(o,n,e,s){await o.fileManager.processFrontMatter(n,t=>{for(let[i,a]of e){if(i==="tags"&&!t.hasOwnProperty("tags")&&!Array.isArray(a.data)){t[i]=[a.data];continue}if(!t[i]||s){t[i]=a.data;continue}let r=a.type,l=t[i],c=Array.isArray(l)?"list":typeof l=="number"?"number":typeof l=="boolean"?"checkbox":"text";if(ct(r,c)){if(t[i]===a.data||!a.data)continue;let p=pt(t[i],a.data);t[i]=p;continue}else{t[i]=a.data;continue}}})}async function Ve(o,n,e){await o.fileManager.processFrontMatter(n,s=>{for(let t of e)s[t]=void 0})}function ct(o,n){let e=["number","date","datetime","checkbox"];return!(e.includes(o)||e.includes(n))}function pt(...o){let e=o.map(t=>Array.isArray(t)?t:[t]).flat();return[...new Set(e)]}var L=class{constructor(n){this.app=n}async setDraft(n,e,s){await this.batchProcessFiles(n,async t=>{if(s)if(s.draftStatusUseFilenamePrefix){let i=t.basename,a=i.startsWith("_"),l=t.path.split("/"),c=e;if(s.draftStatusReverse&&(c=!e),c===!0){if(!a){let p=`_${i}${t.extension?`.${t.extension}`:""}`;l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else if(a){let p=i.substring(1)+(t.extension?`.${t.extension}`:"");l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else{let i=s.draftStatusProperty&&s.draftStatusProperty.trim()?s.draftStatusProperty.startsWith("note.")?s.draftStatusProperty.substring(5):s.draftStatusProperty:"draft",a=e;s.draftStatusReverse&&(a=!e),await this.app.fileManager.processFrontMatter(t,r=>{r[i]=a})}else await this.app.fileManager.processFrontMatter(t,i=>{i.draft=e})}),new O.Notice(`Set ${n.length} file${n.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(n,e){let s=new Map;s.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(n,async t=>{await ge(this.app,t,s,!1)}),new O.Notice(`Added tags to ${n.length} file${n.length!==1?"s":""}`)}async removeTags(n,e){await this.batchProcessFiles(n,async s=>{let t=this.app.metadataCache.getFileCache(s),i=t==null?void 0:t.frontmatter;if(i!=null&&i.tags){let r=(Array.isArray(i.tags)?i.tags:[i.tags]).filter(l=>!e.includes(l));await this.app.fileManager.processFrontMatter(s,l=>{r.length>0?l.tags=r:l.tags=void 0})}}),new O.Notice(`Removed tags from ${n.length} file${n.length!==1?"s":""}`)}async setProperty(n,e,s,t="text"){let i=e.startsWith("note.")?e.substring(5):e,a=new Map;a.set(i,{type:t,data:s,overwrite:!0,delimiter:","}),await this.batchProcessFiles(n,async r=>{await ge(this.app,r,a,!0)}),new O.Notice(`Set ${i} on ${n.length} file${n.length!==1?"s":""}`)}async removeProperty(n,e){let s=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(n,async t=>{await Ve(this.app,t,[s])}),new O.Notice(`Removed ${s} from ${n.length} file${n.length!==1?"s":""}`)}async batchProcessFiles(n,e){let s=0,t=n.length;for(let i of n){let a=this.app.vault.getAbstractFileByPath(i);if(a instanceof O.TFile)try{await e(a),s++}catch(r){console.error(`Error processing ${i}:`,r)}}s<t&&new O.Notice(`Processed ${s} of ${t} files`)}};var $=require("obsidian");var te=class extends $.Modal{constructor(e,s){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Manage Tags"}),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new $.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated)").addText(l=>{l.setPlaceholder("tag1, tag2, tag3").onChange(c=>{this.tagsToAdd=c})}),e.createEl("h3",{text:"Remove tags"});let s=e.createDiv(),t=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof $.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;u!=null&&u.tags&&(Array.isArray(u.tags)?u.tags:[u.tags]).forEach(h=>t.add(h))}}for(let l of Array.from(t).sort())new $.Setting(s).setName(l).addToggle(c=>{c.setValue(this.tagsToRemove.has(l)).onChange(p=>{p?this.tagsToRemove.add(l):this.tagsToRemove.delete(l)})});let i=e.createDiv();i.style.display="flex",i.style.gap="0.5rem",i.style.justifyContent="flex-end",i.style.marginTop="1rem";let a=i.createEl("button");a.setText("Cancel"),a.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",async()=>{await this.applyChanges(),this.close()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(s=>s.trim()).filter(s=>s.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var z=require("obsidian");var se=class extends z.Modal{constructor(e,s){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Set Property"}),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new z.Setting(e).setName("Property name").setDesc("Enter the property name to set").addText(a=>{a.setPlaceholder("e.g., status, category, priority").onChange(r=>{this.propertyName=r})}),new z.Setting(e).setName("Property type").setDesc("Select the property type").addDropdown(a=>{a.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(r=>{this.propertyType=r})}),new z.Setting(e).setName("Property value").setDesc("Enter the property value").addText(a=>{a.setPlaceholder("Enter value").onChange(r=>{this.propertyValue=r})});let s=e.createDiv();s.style.display="flex",s.style.gap="0.5rem",s.style.justifyContent="flex-end",s.style.marginTop="1rem";let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let i=s.createEl("button");i.setText("Apply"),i.addClass("mod-cta"),i.addEventListener("click",async()=>{this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close())})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var _=require("obsidian");var ie=class extends _.Modal{constructor(e,s){super(e);this.propertiesToRemove=new Set;this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Remove Property"}),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let s=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof _.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;if(u)for(let d in u)d!=="tags"&&d!=="title"&&s.add(d)}}let t=e.createDiv();for(let l of Array.from(s).sort())new _.Setting(t).setName(l).addToggle(c=>{c.setValue(this.propertiesToRemove.has(l)).onChange(p=>{p?this.propertiesToRemove.add(l):this.propertiesToRemove.delete(l)})});s.size===0&&e.createEl("p",{text:"No properties found in selected files."});let i=e.createDiv();i.style.display="flex",i.style.gap="0.5rem",i.style.justifyContent="flex-end",i.style.marginTop="1rem";let a=i.createEl("button");a.setText("Cancel"),a.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",async()=>{this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close())})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var Ue=require("obsidian");var N=require("obsidian");var U=require("obsidian");function Oe(o,n){let e=[],s=o.vault.getAbstractFileByPath(n.path);if(s instanceof U.TFile){let t=o.metadataCache.getFileCache(s),i=(t==null?void 0:t.embeds)||[];for(let a of i){let r=o.metadataCache.getFirstLinkpathDest(a.link,n.path);r instanceof U.TFile&&e.push(r)}}return e}function Ne(o,n){let e=[];for(let s of n.children)s instanceof U.TFile&&s.extension==="md"?e.push(...Oe(o,s)):s instanceof U.TFolder&&e.push(...Ne(o,s));return e}async function ht(o,n,e,s){let t=o.vault.getMarkdownFiles().filter(l=>l.path!==e.path),i=n.path,a=n.name,r=n.basename;for(let l of t){if(s&&l.path.startsWith(s.path+"/"))continue;let c=await o.vault.read(l);if(c.includes(i)||c.includes(a)||c.includes(r)||c.includes(`![[${a}]]`)||c.includes(`[[${a}]]`)||c.includes(`(${a})`)||c.includes(`(${i})`))return!0}return!1}async function Re(o,n,e){let s=[];s.push(...Oe(o,n)),e&&s.push(...Ne(o,e));let t=Array.from(new Set(s.map(a=>a.path))).map(a=>o.vault.getAbstractFileByPath(a)).filter(a=>a instanceof U.TFile),i=[];for(let a of t)await ht(o,a,n,e)||i.push(a);return i}function dt(o,n){let e=n.deleteParentFolderFilename||"index";return o.basename===e&&o.parent!==null}function $e(o,n){return n.deleteParentFolder&&dt(o,n)}async function fe(o,n,e){let s=[],t=[],i=[];for(let l of n){let c=o.vault.getAbstractFileByPath(l);if(c instanceof N.TFile){if($e(c,e)){let p=c.parent;if(p&&!t.includes(p)){t.push(p);let u=p.children.filter(d=>d instanceof N.TFile);s.push(...u)}}else s.push(c);if(e.deleteUniqueAttachments){let p=$e(c,e)&&c.parent||void 0,u=await Re(o,c,p);i.push(...u)}}}let a=Array.from(new Set(s.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof N.TFile),r=Array.from(new Set(i.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof N.TFile);return{filesToDelete:a,foldersToDelete:Array.from(new Set(t)),attachmentsToDelete:r}}async function ae(o,n){let e=0,s=0;for(let t of n.filesToDelete)try{await o.vault.delete(t),e++}catch(i){console.error(`Error deleting file ${t.path}:`,i),s++}for(let t of n.attachmentsToDelete)try{await o.vault.delete(t),e++}catch(i){console.error(`Error deleting attachment ${t.path}:`,i),s++}for(let t of n.foldersToDelete)try{await o.vault.delete(t,!0),e++}catch(i){console.error(`Error deleting folder ${t.path}:`,i),s++}s>0?new N.Notice(`Deleted ${e} items, ${s} errors occurred`):new N.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var ne=class extends Ue.Modal{constructor(e,s,t){super(e);this.preview=s,this.onConfirm=t}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Confirm Deletion"}),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.filesToDelete.slice(0,20))a.createEl("li").setText(r.path);this.preview.filesToDelete.length>20&&a.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.foldersToDelete)a.createEl("li").setText(r.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.attachmentsToDelete.slice(0,20))a.createEl("li").setText(r.path);this.preview.attachmentsToDelete.length>20&&a.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"\u26A0\uFE0F This action cannot be undone!",cls:"bases-cms-deletion-warning"});let s=e.createDiv();s.style.display="flex",s.style.gap="0.5rem",s.style.justifyContent="flex-end",s.style.marginTop="1rem";let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let i=s.createEl("button");i.setText("Delete"),i.addClass("mod-cta"),i.addClass("destructive"),i.addEventListener("click",async()=>{await ae(this.app,this.preview),this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var qe=require("obsidian"),Q=class extends qe.Modal{constructor(e,s,t,i){super(e);this.files=s,this.operation=t,this.onConfirm=i}onOpen(){let{contentEl:e}=this;e.empty();let s=this.operation==="draft"?"mark as draft":"mark as published";if(e.createEl("h2",{text:`Confirm ${s.charAt(0).toUpperCase()+s.slice(1)}`}),e.createEl("p",{text:`Are you sure you want to ${s} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let r=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let l of this.files.slice(0,20))r.createEl("li").setText(l);this.files.length>20&&r.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let t=e.createDiv();t.style.display="flex",t.style.gap="0.5rem",t.style.justifyContent="flex-end",t.style.marginTop="1rem";let i=t.createEl("button");i.setText("Cancel"),i.addEventListener("click",()=>this.close());let a=t.createEl("button");a.setText("Confirm"),a.addClass("mod-cta"),a.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var oe=class{constructor(n,e,s,t,i,a,r,l){this.app=n;this.plugin=e;this.container=s;this.getSelectedFiles=t;this.clearSelection=i;this.refreshView=a;this.toolbarEl=null;this.countEl=null;this.resizeObserver=null;this.bulkOps=new L(n),this.selectAllCallback=r,this.settings=l,this.createToolbar()}updateSettings(n){this.settings=n}createToolbar(){this.toolbarEl=document.createElement("div"),this.toolbarEl.className="bases-toolbar bases-cms-bulk-toolbar",this.toolbarEl.style.display="none",this.toolbarEl.style.opacity="0",this.toolbarEl.style.transform="translateY(-10px)",this.toolbarEl.style.transition="opacity 0.2s ease, transform 0.2s ease",this.toolbarEl.__bulkToolbarInstance=this,this.createToolbarContent(),this.positionToolbar(),setTimeout(()=>this.positionToolbar(),100)}positionToolbar(){if(!this.toolbarEl)return;let n=this.container.closest(".bases-header");if(!n){let s=this.container.parentElement;for(;s&&!n;){if(s.classList.contains("bases-header")){n=s;break}s=s.parentElement}}if(!n){let s=Array.from(document.querySelectorAll(".bases-header"));for(let t of s)if(t.contains(this.container)){n=t;break}}let e=this.container.closest(".view-content");if(e)this.toolbarEl.parentElement!==e?(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container)):this.toolbarEl.nextSibling!==this.container&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container));else if(n&&n.parentElement)this.toolbarEl.parentElement!==n.parentElement&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),n.parentElement.insertBefore(this.toolbarEl,n.nextSibling));else{let s=this.container.parentElement;s&&(this.toolbarEl.parentElement!==s||this.toolbarEl.nextSibling!==this.container)&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),s.insertBefore(this.toolbarEl,this.container))}}createToolbarContent(){if(!this.toolbarEl)return;let n=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-left"),e=(i,a,r,l,c=!1)=>{let u=l.createDiv("bases-toolbar-item").createDiv("text-icon-button");c&&u.addClass("destructive"),u.setAttribute("tabindex","0");let d=u.createSpan("text-button-icon");return(0,ze.setIcon)(d,i),u.createSpan("text-button-label").setText(a),u.addEventListener("click",r),u};this.plugin.settings.showToolbarSelectAll&&e("copy-check","Select all",()=>this.handleSelectAll(),n),this.plugin.settings.showToolbarClear&&e("square-x","Clear",()=>this.clearSelection(),n);let s=n.createDiv("bases-toolbar-item bases-cms-selected-count");this.countEl=s.createSpan("text-button-label"),this.countEl.setText("0 items selected");let t=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-right");this.plugin.settings.showToolbarPublish&&e("book-check","Publish",()=>this.handlePublish(),t),this.plugin.settings.showToolbarDraft&&e("book-dashed","Draft",()=>this.handleSetDraft(),t),this.plugin.settings.showToolbarTags&&e("tags","Tags",()=>this.handleManageTags(),t),this.plugin.settings.showToolbarSet&&e("list-check","Set",()=>this.handleSetProperty(),t),this.plugin.settings.showToolbarRemove&&e("list-x","Remove",()=>this.handleRemoveProperty(),t),this.plugin.settings.showToolbarDelete&&e("trash-2","Delete",()=>this.handleDelete(),t,!0),this.setupResponsiveBehavior()}setupResponsiveBehavior(){if(!this.toolbarEl)return;setTimeout(()=>{this.updateCollapsedState()},100),this.toolbarEl&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCollapsedState()}),this.resizeObserver.observe(this.toolbarEl));let n=this.container;if(n){let e=new ResizeObserver(()=>{setTimeout(()=>{this.updateCollapsedState()},10)});e.observe(n),this.containerObserver=e}}updateCollapsedState(){if(!this.toolbarEl)return;this.toolbarEl.offsetWidth<680?this.toolbarEl.addClass("collapsed"):this.toolbarEl.removeClass("collapsed")}updateCount(n){this.countEl&&this.countEl.setText(`${n} item${n!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){this.toolbarEl||(console.warn("[Bases CMS] Toolbar element not found, recreating..."),this.createToolbar()),this.toolbarEl?(this.positionToolbar(),this.toolbarEl.parentElement||(console.warn("[Bases CMS] Toolbar not in DOM, repositioning..."),this.positionToolbar()),this.toolbarEl.style.display="flex",this.toolbarEl.style.visibility="visible",this.toolbarEl.offsetHeight,setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.style.opacity="1",this.toolbarEl.style.transform="translateY(0)")},10)):console.error("[Bases CMS] Failed to show toolbar - element is null")}hide(){this.toolbarEl&&(this.toolbarEl.style.opacity="0",this.toolbarEl.style.transform="translateY(-10px)",setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.style.display="none")},200))}async handleSetDraft(){let n=this.getSelectedFiles();n.length!==0&&(this.plugin.settings.confirmBulkOperations?new Q(this.app,n,"draft",async()=>{await this.bulkOps.setDraft(n,!0,this.settings),this.refreshView()}).open():(await this.bulkOps.setDraft(n,!0,this.settings),this.refreshView()))}async handlePublish(){let n=this.getSelectedFiles();n.length!==0&&(this.plugin.settings.confirmBulkOperations?new Q(this.app,n,"publish",async()=>{await this.bulkOps.setDraft(n,!1,this.settings),this.refreshView()}).open():(await this.bulkOps.setDraft(n,!1,this.settings),this.refreshView()))}async handleManageTags(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new te(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleSetProperty(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new se(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleRemoveProperty(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new ie(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleDelete(){let n=this.getSelectedFiles();if(n.length!==0)if(this.plugin.settings.confirmDeletions){let e=await fe(this.app,n,this.plugin.settings);new ne(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await fe(this.app,n,this.plugin.settings);await ae(this.app,e),this.clearSelection(),this.refreshView()}}recreate(){let n=this.toolbarEl&&this.toolbarEl.style.display!=="none"&&this.toolbarEl.style.opacity!=="0",e=0;if(this.countEl&&this.countEl.textContent){let s=this.countEl.textContent.match(/\d+/);s&&(e=parseInt(s[0],10))}this.destroy(),this.createToolbar(),n&&this.toolbarEl&&e>0&&(this.updateCount(e),this.show())}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);let n=this.containerObserver;n&&(n.disconnect(),this.containerObserver=null),this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};K();function _e(o,n,e,s,t){let i=async c=>{var E;let p=c.target,u=p.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!u||p.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;console.log("[CMS View] New button clicked!",u);let d=o.workspace.getLeavesOfType(G).find(f=>{let m=f.view;return m&&m.containerEl===n}),h=o.workspace.activeLeaf;if(!(d&&h&&d===h)){console.log("[CMS View] Not our active view, skipping. Active leaf:",h,"Our leaf:",d);return}let b=A(e,s);if(console.log("[CMS View] Settings:",{customizeNewButton:b.customizeNewButton,newNoteLocation:b.newNoteLocation}),b.customizeNewButton){c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();let f=((E=b.newNoteLocation)==null?void 0:E.trim())||"";if(f===""){console.log("[CMS View] Using Obsidian default new note location");let m=o.vault.config,T=(m==null?void 0:m.newFileLocation)||"folder",S=(m==null?void 0:m.newFileFolderPath)||"";console.log("[CMS View] Obsidian config:",{newFileLocation:T,newFileFolderPath:S});let C="Untitled.md";if(T==="folder"&&S)C=`${S}/Untitled.md`;else if(T==="current"){let w=o.workspace.getActiveFile();w&&w.parent&&(C=`${w.parent.path}/Untitled.md`)}else T==="root"&&(C="Untitled.md");console.log("[CMS View] Creating file at:",C);let F=await o.vault.create(C,"");await o.workspace.openLinkText(F.path,"",!1);return}if(f==="/"||f.replace(/\//g,"")===""){console.log("[CMS View] Creating note in vault root");try{let m=await o.vault.create("Untitled.md","");await o.workspace.openLinkText(m.path,"",!1)}catch(m){console.error("[CMS View] Error creating new note:",m)}return}console.log("[CMS View] Intercepting and creating note in:",f);try{let m=f.replace(/^\/+|\/+$/g,"");console.log("[CMS View] Folder path:",m);let T=o.vault.getAbstractFileByPath(m);if((!T||!("children"in T))&&(console.log("[CMS View] Folder does not exist, creating:",m),await o.vault.createFolder(m),T=o.vault.getAbstractFileByPath(m)),T&&"children"in T){let S=await o.vault.create(`${m}/Untitled.md`,"");console.log("[CMS View] Created new file:",S.path),await o.workspace.openLinkText(S.path,"",!1)}else console.error("[CMS View] Failed to create or access folder:",m)}catch(m){console.error("[CMS View] Error creating new note:",m)}}else console.log("[CMS View] Custom new button not enabled")},a=c=>{let p=c.target,u=p.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!u||p.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let d=o.workspace.activeLeaf,h=d==null?void 0:d.view,v=d==null?void 0:d.containerEl;if(!(h&&(h.containerEl===n||h===n||u.closest(".workspace-leaf")===v)))return;let E=A(e,s);E.customizeNewButton&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation(),(async()=>{var S;let f=((S=E.newNoteLocation)==null?void 0:S.trim())||"";if(f===""){let C=o.vault.config,F=(C==null?void 0:C.newFileLocation)||"folder",w=(C==null?void 0:C.newFileFolderPath)||"";console.log("[CMS View] Obsidian config:",{newFileLocation:F,newFileFolderPath:w});let y="Untitled.md";if(F==="folder"&&w)y=`${w}/Untitled.md`;else if(F==="current"){let g=o.workspace.getActiveFile();g&&g.parent&&(y=`${g.parent.path}/Untitled.md`)}else F==="root"&&(y="Untitled.md");console.log("[CMS View] Creating file at:",y);let k=await o.vault.create(y,"");await o.workspace.openLinkText(k.path,"",!1);return}if(f==="/"||f.replace(/\//g,"")===""){let C=await o.vault.create("Untitled.md","");await o.workspace.openLinkText(C.path,"",!1);return}let m=f.replace(/^\/+|\/+$/g,""),T=o.vault.getAbstractFileByPath(m);if((!T||!("children"in T))&&(await o.vault.createFolder(m),T=o.vault.getAbstractFileByPath(m)),T&&"children"in T){let C=await o.vault.create(`${m}/Untitled.md`,"");await o.workspace.openLinkText(C.path,"",!1)}})())};document.addEventListener("click",a,!0);let r=new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(p=>{p.__cmsIntercepted||(p.__cmsIntercepted=!0,p.addEventListener("click",a,!0))})});r.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(c=>{c.__cmsIntercepted||(c.__cmsIntercepted=!0,c.addEventListener("click",a,!0))}),t(()=>{document.removeEventListener("click",a,!0),r.disconnect()})}var G="bases-cms",re=class extends H.BasesView{constructor(e,s,t){super(e);this.type=G;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.displayedCount=50;this.isLoading=!1;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.currentBaseIdentifier=null;this.backupInterval=null;this.containerEl=s,this.plugin=t,this.cardRenderer=new ee(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container"),this.containerEl.style.overflowY="auto",this.containerEl.style.overflowX="hidden",this.containerEl.style.height="100%";let i=this.app.isMobile;this.displayedCount=i?25:50,_e(this.app,this.containerEl,this.config,this.plugin.settings,a=>this.register(a)),this.setupViewSwitchListener()}setupViewSwitchListener(){let e=null,s=()=>{e||(e=new MutationObserver(l=>{if(this.selectedFiles.size!==0){for(let c of l)if(c.type==="childList"&&c.removedNodes.length>0){let p=!1;for(let d of this.selectedFiles)if(this.containerEl.querySelector(`[data-path="${d}"]`)){p=!0;break}let u=this.containerEl.querySelectorAll(".card[data-path]");if(!p||u.length===0){this.selectedFiles.clear(),this.updateSelectionUI();break}}}}),this.containerEl&&e.observe(this.containerEl,{childList:!0,subtree:!0}))},t=()=>{if(e){e.disconnect(),e=null,this.selectedFiles.size>0&&this.selectedFiles.clear(),this.updateSelectionUI(),this.bulkToolbar&&this.bulkToolbar.hide();let l=this.containerEl.querySelector(".bases-cms-bulk-toolbar");l&&(l.style.display="none",l.style.opacity="0")}},i=()=>{try{let l=this.config;if(l!=null&&l.getName)return l.getName();if(l!=null&&l.name)return String(l.name);let c=this;if(c.controller){let p=c.controller;if(p!=null&&p.getBaseName)return p.getBaseName();if(p!=null&&p.baseName)return String(p.baseName)}if(this.data){let p=this.data;if(p.baseName)return String(p.baseName)}}catch(l){}return null},a=()=>{if(this.selectedFiles.size===0){this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}let l=i();if(this.currentBaseIdentifier!==null&&l!==null&&this.currentBaseIdentifier!==l){this.selectedFiles.clear(),this.updateSelectionUI(),t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}this.containerEl.querySelectorAll(".card[data-path]").length===0&&(this.selectedFiles.clear(),this.updateSelectionUI())},r=this.handleSelectionChange.bind(this);this.handleSelectionChange=(l,c)=>{if(r(l,c),this.selectedFiles.size>0)this.currentBaseIdentifier===null&&(this.currentBaseIdentifier=i()),s(),this.backupInterval===null&&(this.backupInterval=this.plugin.registerInterval(window.setInterval(a,500)));else{this.currentBaseIdentifier=null,t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null),this.bulkToolbar&&this.bulkToolbar.hide();let p=this.containerEl.querySelector(".bases-cms-bulk-toolbar");p&&(p.style.display="none",p.style.opacity="0")}},this.register(()=>{t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)})}onDataUpdated(){let e=this.app.workspace.activeLeaf;if(e&&this.selectedFiles.size>0){let t=e.view;if(t&&t!==this){if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)){this.selectedFiles.clear(),this.updateSelectionUI();return}let a=t.containerEl;if(!a||!a.contains(this.containerEl)){this.selectedFiles.clear(),this.updateSelectionUI();return}}}if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)&&this.selectedFiles.size>0){this.selectedFiles.clear(),this.updateSelectionUI();return}(async()=>{var F;let t=this.data.groupedData,i=this.data.data;this.cardRenderer.basesConfig=this.config;let a=A(this.config,this.plugin.settings),r=this.containerEl.clientWidth,l=a.cardSize,c=1,p=8,u=Math.max(c,Math.floor((r+p)/(l+p))),d=(r-p*(u-1))/u;this.containerEl.style.setProperty("--card-min-width",`${d}px`),this.containerEl.style.setProperty("--grid-columns",String(u)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(a.imageAspectRatio));let h=this.containerEl.scrollTop,v=this.getSortMethod(),b=t.map(w=>({group:w,entries:[...w.entries]})),E=[],f=this.displayedCount;for(let w of b){if(f<=0)break;let y=Math.min(w.entries.length,f);E.push(...w.entries.slice(0,y)),f-=y}if(a.imageFormat!=="none"){let w=i.filter(g=>!(g.file.path in this.images)).map(g=>{let P=this.app.vault.getAbstractFileByPath(g.file.path);if(!(P instanceof H.TFile))return null;let D=Se(g,a.imageProperty);return{path:g.file.path,file:P,imagePropertyValues:D}}).filter(g=>g!==null),y=w.filter(g=>E.some(P=>P.file.path===g.path)),k=w.filter(g=>!E.some(P=>P.file.path===g.path));if(y.length>0&&await ue(y,a.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),k.length>0&&ue(k,a.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),a.fallbackToEmbeds){let g=w.filter(P=>!(P.path in this.images)&&!this.hasImageAvailable[P.path]);g.length>0&&Le(g,this.app,this.images,this.hasImageAvailable).then(()=>{g.forEach(P=>{var D;if(P.path in this.images){let B=this.containerEl.querySelector(`.card[data-path="${P.path}"]`);if(B){let R=this.images[P.path],I=Array.isArray(R)?R[0]:R;if(I){let W=B.querySelector("img");if(W){if(W.src!==I){W.src=I;let V=W.parentElement;V&&V.classList.contains("image-embed")&&V.style.setProperty("--cover-image-url",`url("${I}")`)}}else{let V=B.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(V){let be=V.querySelector(".card-status-badge"),je=V.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",ce=(D=V.parentElement)==null?void 0:D.createDiv(je);if(ce){let ye=ce.createDiv("image-embed");W=ye.createEl("img",{attr:{src:I,alt:"",decoding:"async"}}),ye.style.setProperty("--cover-image-url",`url("${I}")`),be&&ce.appendChild(be),V.remove()}}}}}}})})}}if(a.showTextPreview){let w=E.filter(y=>!(y.file.path in this.snippets)).map(y=>{let k=this.app.vault.getAbstractFileByPath(y.file.path);if(!(k instanceof H.TFile))return null;let g=M(y,a.descriptionProperty);return{path:y.file.path,file:k,descriptionData:g==null?void 0:g.data}}).filter(y=>y!==null);Be(w,a.fallbackToContent,!1,this.app,this.snippets).then(()=>{w.forEach(y=>{if(y.path in this.snippets&&this.snippets[y.path]){let k=this.containerEl.querySelector(`[data-path="${y.path}"]`);if(k){let g=k.__textPreviewEl;g&&(!g.textContent||g.textContent.trim().length===0)&&g.setText(this.snippets[y.path])}}})})}let m=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let w=this.containerEl.querySelector(".bases-cms-bulk-toolbar");w&&(m=w,m.remove())}this.containerEl.empty(),this.propertyObservers.forEach(w=>w.disconnect()),this.propertyObservers=[];let T=this.containerEl.createDiv("bases-cms-grid"),S=0,C=[];for(let w of b){if(S>=this.displayedCount)break;let y=Math.min(w.entries.length,this.displayedCount-S);if(y===0)continue;let k=w.entries.slice(0,y),g=T.createDiv("bases-cms-group");if(w.group.hasKey()){let B=g.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),R=((F=w.group.key)==null?void 0:F.toString())||"";B.setText(R)}let P=ke(k,a,v,!1,this.snippets,this.images,this.hasImageAvailable);for(let D=0;D<P.length;D++){let B=P[D],R=k[D],I=this.renderCard(g,B,R,S+D,a);I&&C.push(I)}S+=y}C.length>0&&requestAnimationFrame(()=>{for(let{img:w,src:y}of C)w.src=y}),h>0&&(this.containerEl.scrollTop=h),this.setupInfiniteScroll(i.length),this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>{let w=this.containerEl.clientWidth,y=A(this.config,this.plugin.settings),k=y.cardSize,g=1,P=8,D=Math.max(g,Math.floor((w+P)/(k+P))),B=(w-P*(D-1))/D;this.containerEl.style.setProperty("--card-min-width",`${B}px`),this.containerEl.style.setProperty("--grid-columns",String(D)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(y.imageAspectRatio))}),this.resizeObserver.observe(this.containerEl)),m&&this.bulkToolbar&&(this.containerEl.appendChild(m),this.bulkToolbar.toolbarEl=m),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(y=>{let k=y.getAttribute("data-path"),g=y.querySelector('input[type="checkbox"].selection-checkbox');if(k){let P=this.selectedFiles.has(k);P?y.addClass("selected"):y.removeClass("selected"),g&&(g.checked=P)}}),m&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.isLoading=!1})()}renderCard(e,s,t,i,a){let r=this.selectedFiles.has(s.path);return this.cardRenderer.renderCard(e,s,t,a,this,r,(l,c)=>{this.handleSelectionChange(l,c)},(l,c,p)=>{this.handlePropertyToggle(l,c,p)})}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let s=e[0],t=s.property,i=s.direction.toLowerCase();if(t.includes("ctime"))return`ctime-${i}`;if(t.includes("mtime"))return`mtime-${i}`}return"mtime-desc"}setupInfiniteScroll(e){this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=e)&&(this.scrollListener=()=>{if(this.scrollThrottleTimeout!==null||this.isLoading)return;let s=this.containerEl.scrollTop,t=this.containerEl.scrollHeight,i=this.containerEl.clientHeight,a=t-(s+i),l=this.app.isMobile?1:2,c=i*l;if(a<c&&this.displayedCount<e){this.isLoading=!0;let p=50;this.displayedCount=Math.min(this.displayedCount+p,e),this.onDataUpdated()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.register(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}handleSelectionChange(e,s){if(s?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI(),this.selectedFiles.size===0&&this.bulkToolbar){this.bulkToolbar.hide();let t=this.containerEl.querySelector(".bases-cms-bulk-toolbar");t&&(t.style.display="none",t.style.opacity="0")}}async handlePropertyToggle(e,s,t){try{let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof H.TFile))return;let a=s.startsWith("note.")?s.substring(5):s,r=A(this.config,this.plugin.settings),l=r.showDraftStatus&&a==="draft",c=!1;if(l)if(r.draftStatusUseFilenamePrefix){let p=i.basename,u=p.startsWith("_"),h=i.path.split("/");if(t===!0){if(!u){let v=`_${p}${i.extension?`.${i.extension}`:""}`;h[h.length-1]=v;let b=h.join("/");await this.app.fileManager.renameFile(i,b),c=!0}}else if(u){let v=p.substring(1)+(i.extension?`.${i.extension}`:"");h[h.length-1]=v;let b=h.join("/");await this.app.fileManager.renameFile(i,b),c=!0}}else{let p=r.draftStatusProperty&&r.draftStatusProperty.trim()?r.draftStatusProperty.startsWith("note.")?r.draftStatusProperty.substring(5):r.draftStatusProperty:"draft";await this.app.fileManager.processFrontMatter(i,u=>{u[p]=t}),c=!0}else await this.app.fileManager.processFrontMatter(i,p=>{p[a]=t}),c=!0;c&&requestAnimationFrame(()=>{setTimeout(()=>{try{this.onDataUpdated()}catch(p){console.error("Error refreshing view after property toggle:",p)}},100)})}catch(i){console.error("Error toggling property:",i)}}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(s=>{let t=s.getAttribute("data-path");t&&this.selectedFiles.add(t)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}refreshToolbar(){if(this.bulkToolbar){let e=this.selectedFiles.size;this.bulkToolbar.recreate(),e>0&&this.bulkToolbar.updateCount(e)}}updateSelectionUI(){if(this.containerEl.querySelectorAll(".card").forEach(s=>{let t=s.getAttribute("data-path"),i=s.querySelector('input[type="checkbox"].selection-checkbox');if(t){let a=this.selectedFiles.has(t);a?s.addClass("selected"):s.removeClass("selected"),i&&(i.checked=a)}}),this.selectedFiles.size>0){if(document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>{let i=t.__bulkToolbarInstance;(!i||i!==this.bulkToolbar)&&t.remove()}),this.bulkToolbar){let t=A(this.config,this.plugin.settings);this.bulkToolbar.updateSettings(t)}else{let t=A(this.config,this.plugin.settings);this.bulkToolbar=new oe(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let i=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&i.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),setTimeout(()=>{i.forEach(a=>{this.app.vault.getAbstractFileByPath(a)&&this.selectedFiles.add(a)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()},t)}this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()}else if(this.bulkToolbar&&!this.isRefreshingWithSelection){this.bulkToolbar.hide();let s=this.containerEl.querySelector(".bases-cms-bulk-toolbar");s&&(s.style.display="none",s.style.opacity="0")}}onClose(){this.resizeObserver&&this.resizeObserver.disconnect(),this.propertyObservers.forEach(s=>s.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy(),this.selectedFiles.clear(),document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(s=>s.remove()),this.plugin&&typeof this.plugin.removeView=="function"&&this.plugin.removeView(this)}async onNew(){let e=A(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let s=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),t=this.app.vault.getAbstractFileByPath(s);if((!t||!("children"in t))&&(await this.app.vault.createFolder(s),t=this.app.vault.getAbstractFileByPath(s)),t&&"children"in t){let i=await this.app.vault.create(`${s}/Untitled.md`,"");return await this.app.workspace.openLinkText(i.path,"",!1),!0}}catch(s){console.error("[CMS View] Error creating new note:",s)}return!1}};function me(o,n=5){try{if(typeof o.registerBasesView=="function")o.registerBasesView(G,{name:"CMS",icon:o.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(e,s)=>{let t=new re(e,s,o);return o.activeViews.add(t),t},options:gt()});else if(n>0){let e=o.registrationTimeout;e!==null&&window.clearTimeout(e),o.registrationTimeout=window.setTimeout(()=>{o.registrationTimeout=null,me(o,n-1)},200)}else console.warn("Bases CMS: registerBasesView not available. Is Bases plugin installed?")}catch(e){console.error("Bases CMS: Error registering view:",e)}}function gt(){let{getCMSViewOptions:o}=(K(),we(Pe));return o}var le=class extends We.Plugin{constructor(){super(...arguments);this.activeViews=new Set;this.registrationTimeout=null}async onload(){await this.loadSettings(),this.addSettingTab(new Z(this.app,this)),me(this)}onunload(){this.registrationTimeout!==null&&(window.clearTimeout(this.registrationTimeout),this.registrationTimeout=null),this.activeViews.clear()}async loadSettings(){this.settings=Object.assign({},Te,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}refreshAllToolbars(){let e=[];this.activeViews.forEach(s=>{let t=s.containerEl;(!t||!t.parentElement)&&e.push(s)}),e.forEach(s=>this.activeViews.delete(s)),this.activeViews.forEach(s=>{s&&typeof s.refreshToolbar=="function"&&s.refreshToolbar()})}removeView(e){this.activeViews.delete(e)}};
