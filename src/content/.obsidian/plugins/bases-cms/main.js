/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var de=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var Qe=Object.prototype.hasOwnProperty;var Ge=(o,i)=>()=>(o&&(i=o(o=0)),i);var we=(o,i)=>{for(var e in i)de(o,e,{get:i[e],enumerable:!0})},Ke=(o,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of je(i))!Qe.call(o,t)&&t!==e&&de(o,t,{get:()=>i[t],enumerable:!(s=We(i,t))||s.enumerable});return o};var Se=o=>Ke(de({},"__esModule",{value:!0}),o);var Pe={};we(Pe,{getCMSViewOptions:()=>Ye,readCMSSettings:()=>D});function D(o,i){var e,s,t,a,n,r,l,c,p,u,d,h,g,v,C,E;return{titleProperty:o.get("titleProperty")||"",descriptionProperty:o.get("descriptionProperty")||"",imageProperty:o.get("imageProperty")||"",showTitle:(e=o.get("showTitle"))!=null?e:!0,showDate:(s=o.get("showDate"))!=null?s:!1,dateProperty:o.get("dateProperty")||"",showTextPreview:(t=o.get("showTextPreview"))!=null?t:!0,fallbackToContent:(a=o.get("fallbackToContent"))!=null?a:!0,fallbackToEmbeds:(n=o.get("fallbackToEmbeds"))!=null?n:!1,propertyDisplay1:o.get("propertyDisplay1")||"",propertyDisplay2:o.get("propertyDisplay2")||"",propertyDisplay3:o.get("propertyDisplay3")||"",propertyDisplay4:o.get("propertyDisplay4")||"",propertyLayout12SideBySide:(r=o.get("propertyLayout12SideBySide"))!=null?r:!1,propertyLayout34SideBySide:(l=o.get("propertyLayout34SideBySide"))!=null?l:!1,imageFormat:o.get("imageFormat")||"thumbnail",propertyLabels:o.get("propertyLabels")||"hide",showDraftStatus:(c=o.get("showDraftStatus"))!=null?c:!1,draftStatusProperty:o.get("draftStatusProperty")||"",draftStatusReverse:(p=o.get("draftStatusReverse"))!=null?p:!1,draftStatusUseFilenamePrefix:(u=o.get("draftStatusUseFilenamePrefix"))!=null?u:!1,showTags:(d=o.get("showTags"))!=null?d:!1,tagsProperty:o.get("tagsProperty")||"",maxTagsToShow:(h=o.get("maxTagsToShow"))!=null?h:3,customizeNewButton:(g=o.get("customizeNewButton"))!=null?g:!1,newNoteLocation:o.get("newNoteLocation")||"",hideQuickEditIcon:(v=o.get("hideQuickEditIcon"))!=null?v:!1,cardSize:(C=o.get("cardSize"))!=null?C:250,imageAspectRatio:(E=o.get("imageAspectRatio"))!=null?E:.55}}function Ye(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Filename underscore prefix as draft indicator",key:"draftStatusUseFilenamePrefix",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"slider",displayName:"Maximum tags to show",key:"maxTagsToShow",min:1,max:50,step:1,default:3,showWhen:{key:"showTags",value:!0}},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""},{type:"toggle",displayName:"Hide quick edit icon",key:"hideQuickEditIcon",default:!1}]}var _=Ge(()=>{"use strict"});var bt={};we(bt,{default:()=>pe});module.exports=Se(bt);var Ue=require("obsidian");var x=require("obsidian");var Ee=require("obsidian"),U=class extends Ee.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){let e=this.app.commands,s=new Map;if(e&&typeof e.listCommands=="function")try{let a=e.listCommands();for(let n of a)n&&n.id&&n.name&&!s.has(n.id)&&s.set(n.id,{id:n.id,name:n.name})}catch(a){console.warn("[Bases CMS] Error getting commands via listCommands():",a)}try{let a=e==null?void 0:e.commands;if(a&&typeof a=="object"){let n=Object.values(a);for(let r of n)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(a){console.warn("[Bases CMS] Error getting commands via registry:",a)}try{let a=e==null?void 0:e.commandRegistry;if(a&&typeof a=="object"){let n=Object.values(a);for(let r of n)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(a){console.warn("[Bases CMS] Error getting commands via internal registry:",a)}let t=Array.from(s.values());return t.sort((a,n)=>a.name.localeCompare(n.name)),t}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.createDiv({cls:"suggestion-title",text:t.name})}};var A=require("obsidian"),Je=()=>{if(A.requireApiVersion&&(0,A.requireApiVersion)("1.7.3")&&A.getIconIds)try{return(0,A.getIconIds)()}catch(o){console.warn("[Bases CMS] Error getting icon IDs from Obsidian:",o)}return["settings-2","settings","help-circle","info","star","heart","bookmark","home","search","bell","mail","user","users","folder","file","file-text","image","video","music","calendar","clock","edit","pencil","trash","copy","cut","paste","download","upload","save","share","link","external-link","lock","unlock","eye","eye-off","key","shield","check","x","plus","minus","arrow-left","arrow-right","arrow-up","arrow-down","chevron-left","chevron-right","chevron-up","chevron-down","menu","more-horizontal","more-vertical","grid","list","layout","columns","rows","maximize","minimize","zoom-in","zoom-out","refresh-cw","play","pause","stop","sun","moon","cloud","zap","wand-2","wand","wand-sparkles","palette","brush","sliders","power","wifi","bluetooth","monitor","laptop","smartphone","camera","mic","headphones","code","terminal","terminal-square","github","gitlab","git-branch","git-commit","database","server","cloud-download","cloud-upload","tag","tags","flag","pin","map-pin","compass","globe","rocket","car","bike","robot","apple","windows","linux","chrome","firefox","safari","credit-card","wallet","coins","book","book-open","award","trophy","badge","wrench","tool","package","box","archive","send","reply","forward","mail-open","tag-plus","tag-minus","flag-off","pin-off","map-pin-off","navigation","map","earth","plane","ship","anchor","helicopter","drone","android","keyhole","keys","fingerprint","scan","qr-code","barcode","receipt","piggy-bank","banknote","pencil-line","edit-2","edit-3"]},Ze=Je().map(o=>({id:o,name:o.replace(/^lucide-/,"").replace(/-/g," ").replace(/(^\w{1})|(\s+\w{1})/g,i=>i.toUpperCase())})).sort((o,i)=>o.name.localeCompare(i.name)),W=class extends A.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){return Ze}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.addClass("mod-complex"),s.createDiv({cls:"suggestion-content"}).createDiv({cls:"suggestion-title",text:t.name});let n=s.createDiv({cls:"suggestion-aux"});(0,A.setIcon)(n.createSpan({cls:"suggestion-flair"}),t.id)}};var j=class extends x.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}refreshActiveToolbars(){let e=this.plugin;e&&typeof e.refreshAllToolbars=="function"&&e.refreshAllToolbars()}display(){let{containerEl:e}=this;e.empty(),new x.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations.").addToggle(n=>n.setValue(this.plugin.settings.confirmBulkOperations).onChange(r=>{(async()=>(this.plugin.settings.confirmBulkOperations=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Toolbar buttons").setHeading(),new x.Setting(e).setName("Show select all button").setDesc("Display the select all button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarSelectAll).onChange(r=>{(async()=>(this.plugin.settings.showToolbarSelectAll=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show clear button").setDesc("Display the clear selection button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarClear).onChange(r=>{(async()=>(this.plugin.settings.showToolbarClear=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show publish button").setDesc("Display the publish button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarPublish).onChange(r=>{(async()=>(this.plugin.settings.showToolbarPublish=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show draft button").setDesc("Display the draft button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarDraft).onChange(r=>{(async()=>(this.plugin.settings.showToolbarDraft=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show tags button").setDesc("Display the tags button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarTags).onChange(r=>{(async()=>(this.plugin.settings.showToolbarTags=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show set button").setDesc("Display the set property button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarSet).onChange(r=>{(async()=>(this.plugin.settings.showToolbarSet=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show remove button").setDesc("Display the remove property button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarRemove).onChange(r=>{(async()=>(this.plugin.settings.showToolbarRemove=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show delete button").setDesc("Display the delete button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarDelete).onChange(r=>{(async()=>(this.plugin.settings.showToolbarDelete=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Deletions").setHeading(),new x.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder and all its contents if the note file name matches the specified name.").addToggle(n=>n.setValue(this.plugin.settings.deleteParentFolder).onChange(r=>{(async()=>(this.plugin.settings.deleteParentFolder=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Folder deletion file name").setDesc("File name that triggers parent folder deletion.").addText(n=>n.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(r=>{(async()=>(this.plugin.settings.deleteParentFolderFilename=r,await this.plugin.saveData(this.plugin.settings)))()})).setDisabled(!this.plugin.settings.deleteParentFolder),new x.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(n=>n.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(r=>{(async()=>(this.plugin.settings.deleteUniqueAttachments=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files.").addToggle(n=>n.setValue(this.plugin.settings.confirmDeletions).onChange(r=>{(async()=>(this.plugin.settings.confirmDeletions=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Appearance").setHeading(),new x.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(n=>n.setValue(this.plugin.settings.useHomeIcon).onChange(r=>{(async()=>(this.plugin.settings.useHomeIcon=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Quick edit").setHeading();let s,t,a;new x.Setting(e).setName("Enable quick edit").setDesc("Show an icon on card titles that launches a command when clicked.").addToggle(n=>n.setValue(this.plugin.settings.enableQuickEdit).onChange(r=>{(async()=>(this.plugin.settings.enableQuickEdit=r,await this.plugin.saveData(this.plugin.settings),s&&s.settingEl.toggleClass("bases-cms-setting-hidden",!r),t&&t.settingEl.toggleClass("bases-cms-setting-hidden",!r),a&&a.settingEl.toggleClass("bases-cms-setting-hidden",!r)))()})),s=new x.Setting(e).setName("Quick edit command").setDesc("The command to execute when clicking the quick edit icon on a card title.").addButton(n=>{var l;let r=this.plugin.settings.quickEditCommandName||(this.plugin.settings.quickEditCommand?"Select command...":"No command selected");if(n.setButtonText(r).onClick(()=>{new U(this.app,p=>{(async()=>{let u=this.app.commands,d="";if(u){if(typeof u.listCommands=="function"){let g=u.listCommands().find(v=>v.id===p);g&&(d=g.name)}if(!d){let h=u.commands;h&&h[p]&&(d=h[p].name||"")}}this.plugin.settings.quickEditCommand=p,this.plugin.settings.quickEditCommandName=d,await this.plugin.saveData(this.plugin.settings),this.display()})()}).open()}),this.plugin.settings.quickEditCommand){let c=(l=n.buttonEl.parentElement)==null?void 0:l.createEl("button",{text:"Clear",attr:{style:"margin-left: 8px;"}});c==null||c.addEventListener("click",()=>{(async()=>(this.plugin.settings.quickEditCommand="",this.plugin.settings.quickEditCommandName="",await this.plugin.saveData(this.plugin.settings),this.display()))()})}}),s.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit),t=new x.Setting(e).setName("Quick edit icon").setDesc("Select the icon to display for the quick edit button on card titles.").addButton(n=>{let r=this.getIconName(this.plugin.settings.quickEditIcon||"pencil-line");n.setButtonText(r||"Select icon...").onClick(()=>{new W(this.app,async c=>{this.plugin.settings.quickEditIcon=c,await this.plugin.saveData(this.plugin.settings),this.display()}).open()})}),t.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit),a=new x.Setting(e).setName("Attempt to open file and execute quick edit command").setDesc("For commands that don't have special handling, attempt to open the file and execute the command. Some commands may not work properly this way.").addToggle(n=>n.setValue(this.plugin.settings.quickEditOpenFile).onChange(r=>{(async()=>(this.plugin.settings.quickEditOpenFile=r,await this.plugin.saveData(this.plugin.settings)))()})),a.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit)}getIconName(e){return e?e.replace(/^lucide-/,"").split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):""}};var Te={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,enableQuickEdit:!1,quickEditCommand:"",quickEditCommandName:"",quickEditIcon:"pencil-line",quickEditOpenFile:!1,showToolbarSelectAll:!0,showToolbarClear:!0,showToolbarDraft:!0,showToolbarPublish:!0,showToolbarTags:!0,showToolbarSet:!0,showToolbarRemove:!0,showToolbarDelete:!0};var z=require("obsidian");function M(o,i){if(!i||!i.trim())return null;let e=i.split(",").map(s=>s.trim()).filter(s=>s);for(let s of e){let t=o.getValue(s),a=t;if(a&&("date"in a&&a.date instanceof Date||"data"in a))return t}return null}function he(o,i){if(!i||!i.trim())return[];let e=i.split(",")[0].trim();if(!e)return[];let s=o.getValue(e);if(!s||!("data"in s))return[];let t=s.data,a=[];if(Array.isArray(t)){for(let n of t)if(typeof n=="string"||typeof n=="number"){let r=String(n);if(r&&r.trim()){a.push(r);break}}}else if(t!=null&&t!==""&&(typeof t=="string"||typeof t=="number")){let n=String(t);n.trim()&&a.push(n)}return a}function Ce(o,i,e,s){if(!o||o==="")return"";if(e){let t=e;if(typeof t.getDisplayName=="function")try{let a=t.getDisplayName(o);if(a&&typeof a=="string"&&a.trim()!=="")return a}catch(a){}}return o}function Xe(o,i,e,s,t,a,n){let r=o.file.basename||o.file.name,l=M(o,i.titleProperty),c=l==null?void 0:l.data,p=c!=null&&c!==""&&(typeof c=="string"||typeof c=="number")?String(c):r,u=o.file.path,d=u.split("/").slice(0,-1).join("/"),h=o.getValue("note.tags"),g=[];if(h&&h.data!=null){let T=h.data;g=(Array.isArray(T)?T.map(y=>y&&typeof y=="object"&&"data"in y?String(y.data):typeof y=="string"||typeof y=="number"?String(y):"").filter(y=>y):typeof T=="string"||typeof T=="number"?[String(T)]:[]).map(y=>y.replace(/^#/,""))}let v=o.getValue("file.tags"),C=[];if(v&&v.data!=null){let T=v.data;C=(Array.isArray(T)?T.map(y=>y&&typeof y=="object"&&y!==null&&"data"in y?String(y.data):typeof y=="string"||typeof y=="number"?String(y):"").filter(y=>typeof y=="string"&&y.length>0):typeof T=="string"||typeof T=="number"?[String(T)]:[]).map(y=>y.replace(/^#/,""))}let E=o.file.stat.ctime,k=o.file.stat.mtime,b=[];if(i.showTags&&i.tagsProperty){let T=M(o,i.tagsProperty);if(T&&T.data!=null){let P=T.data;Array.isArray(P)?b=P.map(y=>y&&typeof y=="object"&&"data"in y?String(y.data):typeof y=="string"||typeof y=="number"?String(y):"").filter(y=>typeof y=="string"&&y.length>0):(typeof P=="string"||typeof P=="number")&&(b=[String(P)])}}let m={path:u,name:r,title:p,tags:C,yamlTags:g,ctime:E,mtime:k,folderPath:d,snippet:t,imageUrl:a,hasImageAvailable:n||!1,displayTags:b.length>0?b:void 0},f=[i.propertyDisplay1,i.propertyDisplay2,i.propertyDisplay3,i.propertyDisplay4],w=new Set,S=f.map(T=>!T||T===""||w.has(T)?"":(w.add(T),T));return m.propertyName1=S[0]||void 0,m.propertyName2=S[1]||void 0,m.propertyName3=S[2]||void 0,m.propertyName4=S[3]||void 0,m.property1=S[0]?q(S[0],o,m,i):null,m.property2=S[1]?q(S[1],o,m,i):null,m.property3=S[2]?q(S[2],o,m,i):null,m.property4=S[3]?q(S[3],o,m,i):null,m}function ke(o,i,e,s,t,a,n){return o.map(r=>Xe(r,i,e,s,t[r.file.path],a[r.file.path],n[r.file.path]))}function q(o,i,e,s){if(!o||o==="")return null;if(o==="file.path"||o==="file path")return e.folderPath||null;if(o==="tags"||o==="note.tags")return e.yamlTags.length>0?"tags":null;if(o==="file.tags"||o==="file tags")return e.tags.length>0?"tags":null;if(o==="file.ctime"||o==="created time")return new Date(e.ctime).toLocaleDateString();if(o==="file.mtime"||o==="modified time")return new Date(e.mtime).toLocaleDateString();let t=M(i,o);if(!t)return null;let a=t;if(!a)return null;if("date"in a&&a.date instanceof Date)return a.date.toLocaleDateString();let n=a.data;return n==null||n===""?null:Array.isArray(n)?n.length===0?null:n.map(r=>r&&typeof r=="object"&&"data"in r?String(r.data):String(r)).filter(r=>r&&r.trim()!=="").join(", "):typeof n=="string"||typeof n=="number"||typeof n=="boolean"?String(n):null}_();function xe(o){return/^https?:\/\//i.test(o)}function ue(o){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(o)}function De(o){return new Promise(i=>{let e=new Image;e.onload=()=>i(!0),e.onerror=()=>i(!1),setTimeout(()=>i(!1),5e3),e.src=o})}function et(o){let i=o.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return i?i[1].trim():o}async function Fe(o){let i=[],e=[];for(let n of o){let r=et(n);r.length!==0&&(xe(r)?(ue(r)||!r.includes("."))&&e.push(r):ue(r)&&i.push(r))}let s=e.map(n=>De(n).then(r=>r?n:null)),a=(await Promise.all(s)).filter(n=>n!==null);return{internalPaths:i,externalUrls:a}}function Ae(o,i,e){let s=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],t=[];for(let a of o){let n=e.metadataCache.getFirstLinkpathDest(a,i);if(n&&s.includes(n.extension)){let r=e.vault.getResourcePath(n);t.push(r)}}return t}async function ge(o,i){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=i.metadataCache.getFileCache(o);if(!(s!=null&&s.embeds))return[];let t=[],a=[];for(let c of s.embeds){let p=c.link;if(xe(p))(ue(p)||!p.includes("."))&&a.push(p);else{let u=i.metadataCache.getFirstLinkpathDest(p,o.path);if(u&&e.includes(u.extension)){let d=i.vault.getResourcePath(u);t.push(d)}}}let n=a.map(c=>De(c).then(p=>p?c:null)),l=(await Promise.all(n)).filter(c=>c!==null);return[...t,...l]}var tt=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function st(o){let i=new Map,e=0;return{text:o.replace(/\\(.)/g,(t,a)=>{let n=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return i.set(n,a),e++,n}),map:i}}function it(o,i){let e=o;return i.forEach((s,t)=>{e=e.split(t).join(s)}),e}function nt(o){let i=o,e=!0;for(;e;){e=!1;let s=i.match(/^([`~]{3,})/m);if(!s)break;let t=s[1][0],a=s[1].length,n=s.index,r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`^${r}{${a}}\\s*$`,"m"),p=i.substring(n+s[1].length).match(l);if(p){let d=n+s[1].length+p.index+p[0].length;i=i.substring(0,n)+i.substring(d),e=!0}else{let u=i.indexOf(`
`,n);u===-1?i=i.substring(0,n):i=i.substring(0,n)+i.substring(u+1),e=!0}}return i}function at(o){if(!o||o.trim().length===0)return"";o=o.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),o=o.replace(/^>\s?/gm,"");let{text:i,map:e}=st(o),s=nt(i);return tt.forEach(t=>{s=s.replace(t,(a,...n)=>{if(a.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return n[1]||"";if(n.length>0&&n[0]!==void 0){for(let r=0;r<n.length-2;r++)if(typeof n[r]=="string")return n[r]}return""})}),s=it(s,e),s}function ot(o,i=!1,e,s){let t=o.replace(/^---[\s\S]*?---/,"").trim(),a=at(t),n=a.indexOf(`
`),r=(n!==-1?a.substring(0,n):a).trim();(i||e&&r===e||s&&r===s)&&(a=n!==-1?a.substring(n+1).trim():"");let l=a.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(u=>u).join(" ").trim().replace(/\.{2,}/g,u=>u.replace(/\./g,"\u2024")),c=l.length>500,p=l.substring(0,500);return c&&(p+="\u2026"),p}async function Me(o,i,e,s,t,a){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(s.fallbackToContent){let r=await i.vault.cachedRead(o);return ot(r,s.omitFirstLine,t,a)}return""}async function rt(o,i,e,s,t,a,n){if(!(o in a))try{let{internalPaths:r,externalUrls:l}=await Fe(s),c=[...Ae(r,o,e),...l];c.length===0&&t&&(c=await ge(i,e)),c.length>0&&(a[o]=c.length>1?c:c[0],n[o]=!0)}catch(r){console.error(`Failed to load image for ${o}:`,r)}}async function me(o,i,e,s,t){let a=o.filter(r=>!(r.path in s)),n=50;for(let r=0;r<a.length;r+=n){let l=a.slice(r,r+n);await Promise.all(l.map(async c=>{await rt(c.path,c.file,e,c.imagePropertyValues,i,s,t)}))}}async function Be(o,i,e,s){await Promise.all(o.map(async t=>{if(!(t.path in e||s[t.path]))try{let a=await ge(t.file,i);a.length>0&&(e[t.path]=a.length>1?a:a[0],s[t.path]=!0)}catch(a){console.error(`Failed to load embed images for ${t.path}:`,a)}}))}async function Le(o,i,e,s,t){await Promise.all(o.map(async a=>{if(!(a.path in t))try{a.file.extension==="md"?t[a.path]=await Me(a.file,s,a.descriptionData,{fallbackToContent:i,omitFirstLine:e},a.fileName,a.titleString):t[a.path]=""}catch(n){console.error(`Failed to load snippet for ${a.path}:`,n),t[a.path]=""}}))}var J=require("obsidian");function lt(o,i){let e=null,s=!1;if(i.draftStatusUseFilenamePrefix&&o.file&&o.file.name)e=o.file.name.startsWith("_"),s=i.draftStatusReverse?!e:e;else if(i.draftStatusProperty){let t=M(o,i.draftStatusProperty);if(t){let a=t;a&&"data"in a&&typeof a.data=="boolean"&&(e=a.data,s=i.draftStatusReverse?!e:e)}}return{booleanValue:e,isDraft:s}}function Q(o,i,e,s,t){if(!s.showDraftStatus)return;let{booleanValue:a,isDraft:n}=lt(i,s);if(a!==null){let r=o.createDiv("card-status-badge");n?(r.addClass("status-draft"),r.appendText("Draft")):(r.addClass("status-published"),r.appendText("Published")),t&&(r.addClass("bases-cms-cursor-pointer"),r.addEventListener("click",l=>{l.stopPropagation(),t(e,"draft",!a)}))}}var F=require("obsidian");function ct(o,i){let e=new F.Modal(o);e.titleEl.setText("Rename file");let s=e.contentEl.createDiv();s.style.width="100%";let t=new F.TextComponent(s);t.setValue(i.basename),t.inputEl.style.width="100%",t.inputEl.style.boxSizing="border-box",t.inputEl.focus(),t.inputEl.select();let a=e.contentEl.createDiv({cls:"modal-button-container"});a.createEl("button",{text:"Cancel"}).addEventListener("click",()=>e.close());let r=a.createEl("button",{text:"Rename",cls:"mod-cta"}),l=async()=>{let c=t.getValue().trim();if(!c||c===i.basename){e.close();return}let p=i.path.split("/");p[p.length-1]=c+(i.extension?`.${i.extension}`:"");let u=p.join("/");try{await o.fileManager.renameFile(i,u),e.close()}catch(d){console.error("[Bases CMS] Error renaming file:",d),e.close()}};r.addEventListener("click",()=>{l()}),t.inputEl.addEventListener("keydown",c=>{c.key==="Enter"?(c.preventDefault(),l()):c.key==="Escape"&&(c.preventDefault(),e.close())}),e.open()}function pt(o){let i=o.toLowerCase();return o==="file-explorer:rename-file"||o==="rename-file"||o==="file:rename-file"||i.includes("rename")&&i.includes("file")&&!i.includes(":")}function dt(o,i){let e=o.toLowerCase(),s=i.toLowerCase();return["add tag","add-tag","insert-template","insert-template","editor:","markdown:"].some(a=>e.includes(a)||s.includes(a))}function Ie(o,i,e,s,t,a){if(!i.settings.enableQuickEdit||!i.settings.quickEditCommand||i.settings.quickEditCommand===""||a.hideQuickEditIcon)return;let n=e.createSpan("bases-cms-quick-edit-icon");n.addClass("bases-cms-cursor-default"),(0,F.setIcon)(n,i.settings.quickEditIcon||"pencil-line"),e.addEventListener("click",r=>{n.contains(r.target)&&(r.stopPropagation(),r.stopImmediatePropagation())},!0),s.addEventListener("click",r=>{(async()=>{var p,u,d,h;let l=r.target;if(!n.contains(l)&&!l.closest(".bases-cms-quick-edit-icon"))return;r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault();let c=o.vault.getAbstractFileByPath(t);if(c instanceof F.TFile){let g=i.settings.quickEditCommand,v=o.commands,C=(p=v==null?void 0:v.commands)==null?void 0:p[g],E=(C==null?void 0:C.name)||"",k=E.toLowerCase();if(pt(g)||k.includes("rename")&&k.includes("file")){ct(o,c);return}if(dt(g,E)&&!i.settings.quickEditOpenFile){new F.Notice(`The "${E}" command requires the file to be open in an editor. Enable "Attempt to open file and execute quick edit command" in settings to try anyway.`,5e3);return}let b=!1;try{let m=null,f=g;if(g.includes(":")){let w=g.split(":");m=w[0],f=w.slice(1).join(":")}else{let S=o.commands,T=(u=S==null?void 0:S.commands)==null?void 0:u[g];if(T){let P=T.plugin||T.sourcePlugin;P&&(m=((d=P.manifest)==null?void 0:d.id)||P.pluginId||null)}}if(m){let w=o.plugins,S=(h=w==null?void 0:w.plugins)==null?void 0:h[m];if(S){let T=f.split("-").map((P,y)=>y===0?P:P.charAt(0).toUpperCase()+P.slice(1)).join("")+"ByPath";if(S&&typeof S[T]=="function"){await S[T](t),b=!0;return}}}}catch(m){}if(!b){if(!i.settings.quickEditOpenFile){new F.Notice(`This command doesn't have special handling. Enable "Attempt to open file and execute quick edit command" in settings to try executing it.`,5e3);return}let m=o.workspace.getLeaf(!1);await m.openFile(c),o.workspace.setActiveLeaf(m,{focus:!0});let f=0,w=30,S=()=>{o.workspace.getActiveFile()===c&&(async()=>{var y,N;try{await((N=(y=o.commands)==null?void 0:y.executeCommandById)==null?void 0:N.call(y,i.settings.quickEditCommand))}catch(yt){}})()},T=()=>{let P=m.view,y=P,N=o.workspace.getActiveFile();P&&"editor"in P&&y.editor&&N===c?requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{S()},200)})}):f<w&&(f++,setTimeout(T,50))};T()}}})()},!0),n.addEventListener("mousedown",r=>{r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault()},!0)}var Oe=require("obsidian");var G=class{constructor(i,e,s){this.app=i;this.getBasesConfig=e;this.getBasesController=s}renderProperties(i,e,s,t,a){let n=[t.propertyDisplay1,t.propertyDisplay2,t.propertyDisplay3,t.propertyDisplay4],r=new Set,l=n.map(h=>!h||h===""||r.has(h)?"":(r.add(h),h)),c=l.map(h=>h?q(h,s,e,t):null),p=l[0]!==""||l[1]!=="",u=l[2]!==""||l[3]!=="";if(!p&&!u)return;let d=i.createDiv("card-properties properties-4field");if(p){let h=d.createDiv("property-row property-row-1");t.propertyLayout12SideBySide&&h.addClass("property-row-side-by-side");let g=h.createDiv("property-field property-field-1");l[0]&&this.renderPropertyContent(g,l[0],c[0],e,s,t,a);let v=h.createDiv("property-field property-field-2");l[1]&&this.renderPropertyContent(v,l[1],c[1],e,s,t,a)}if(u){let h=d.createDiv("property-row property-row-2");t.propertyLayout34SideBySide&&h.addClass("property-row-side-by-side");let g=h.createDiv("property-field property-field-3");l[2]&&this.renderPropertyContent(g,l[2],c[2],e,s,t,a);let v=h.createDiv("property-field property-field-4");l[3]&&this.renderPropertyContent(v,l[3],c[3],e,s,t,a)}}renderPropertyContent(i,e,s,t,a,n,r){if(e===""||!s&&n.propertyLabels==="hide"||n.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&t.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&t.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&t.folderPath.length===0))return;let l=this.getBasesConfig?this.getBasesConfig():void 0,c=this.getBasesController?this.getBasesController():void 0,p=Ce(e,this.app,l,c),u=p.toLowerCase()!==e.toLowerCase();if(n.propertyLabels==="above"){let g=i.createDiv("property-label");u&&g.addClass("property-label-custom"),g.textContent=p}let d=i.createDiv("property-content");if(n.propertyLabels==="inline"){let g=d.createSpan("property-label-inline");g.textContent=p+": "}if(!s){d.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")d.createSpan().appendText(s);else if((e==="tags"||e==="note.tags")&&t.yamlTags.length>0){let g=d.createDiv("tags-wrapper");t.yamlTags.forEach(v=>{g.createEl("a",{cls:"tag",text:v,href:"#"}).addEventListener("click",E=>{var b,m,f;E.preventDefault();let k=(m=(b=this.app.internalPlugins)==null?void 0:b.plugins)==null?void 0:m["global-search"];(f=k==null?void 0:k.instance)!=null&&f.openGlobalSearch&&k.instance.openGlobalSearch("tag:"+v)})})}else if((e==="file.tags"||e==="file tags")&&t.tags.length>0){let g=d.createDiv("tags-wrapper");t.tags.forEach(v=>{g.createEl("a",{cls:"tag",text:v,href:"#"}).addEventListener("click",E=>{var b,m,f;E.preventDefault();let k=(m=(b=this.app.internalPlugins)==null?void 0:b.plugins)==null?void 0:m["global-search"];(f=k==null?void 0:k.instance)!=null&&f.openGlobalSearch&&k.instance.openGlobalSearch("tag:"+v)})})}else if((e==="file.path"||e==="path"||e==="file path")&&t.path.length>0){let g=d.createDiv("path-wrapper"),v=t.path.split("/").filter(C=>C);v.forEach((C,E)=>{let k=g.createSpan(),b=E===v.length-1,m=b?"path-segment filename-segment":"path-segment file-path-segment";k.createSpan({cls:m,text:C}).addEventListener("click",w=>{if(w.stopPropagation(),b){let S=this.app.vault.getAbstractFileByPath(t.path);S instanceof Oe.TFile&&this.app.workspace.getLeaf(!1).openFile(S)}}),E<v.length-1&&k.createSpan({cls:"path-separator",text:"/"})})}else{let g=this.app.metadataCache,C=(typeof g.getAllPropertyInfos=="function"?g.getAllPropertyInfos():{})[e.toLowerCase()],E=a.getValue(e);if(((C==null?void 0:C.widget)==="checkbox"||E&&"data"in E&&typeof E.data=="boolean")&&r){let b=d.createEl("input",{type:"checkbox"});b.checked=E&&"data"in E?Boolean(E.data):!1,d.createSpan({text:p}),b.addEventListener("change",async m=>{m.stopPropagation();let f=b.checked;try{let w=e.startsWith("note.")?e.substring(5):e;await r(t.path,w,f)}catch(w){console.error("Error toggling property:",w),b.checked=!f}}),b.addEventListener("click",m=>{m.stopPropagation()})}else d.createDiv("text-wrapper").appendText(s)}(!d.textContent||d.textContent.trim().length===0)&&d.remove()}};var K=class{constructor(i,e,s,t,a,n){this.app=i;this.plugin=e;this.propertyObservers=s;this.updateLayoutRef=t;this.basesConfig=a,this.basesController=n,this.propertyRenderer=new G(this.app,()=>this.basesConfig,()=>this.basesController)}renderCard(i,e,s,t,a,n,r,l){let c=i.createDiv("card bases-cms-card");t.imageFormat==="cover"?c.classList.add("image-format-cover"):t.imageFormat==="thumbnail"&&c.classList.add("image-format-thumbnail"),c.setAttribute("data-path",e.path),c.setAttribute("data-href",e.path),c.addClass("bases-cms-cursor-pointer");let p=c.createDiv("bases-cms-select-checkbox"),u=p.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(u.checked=n,u.addEventListener("change",d=>{d.stopPropagation(),d.stopImmediatePropagation(),r(e.path,u.checked)}),u.addEventListener("click",d=>{d.stopPropagation(),d.stopImmediatePropagation()}),t.showDraftStatus&&t.imageFormat!=="cover"&&Q(c,s,e.path,t,l),c.addEventListener("click",d=>{let h=d.target;if(h.closest(".bases-cms-quick-edit-icon")){d.stopPropagation(),d.stopImmediatePropagation(),d.preventDefault();return}if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge"))return;let v=d.metaKey||d.ctrlKey;this.app.workspace.openLinkText(e.path,"",v)}),c.addEventListener("contextmenu",d=>{let h=d.target;if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge")||h.closest(".bases-cms-quick-edit-icon"))return;let g=this.app.vault.getAbstractFileByPath(e.path);if(g&&g instanceof J.TFile){d.stopPropagation();let v=new J.Menu;this.app.workspace.trigger("file-menu",v,g,"bases"),v.showAtMouseEvent(d)}}),t.showTitle){let d=c.createDiv("card-title");d.appendText(e.title),Ie(this.app,this.plugin,d,c,e.path,t)}if(t.showDate&&t.dateProperty){let d=M(s,t.dateProperty);if(d){let h=d,g="";if(h&&"date"in h&&h.date instanceof Date)g=h.date.toLocaleDateString();else if(h&&"data"in h&&h.data){let v=h.data;if(v instanceof Date)g=v.toLocaleDateString();else if(typeof v=="string"||typeof v=="number"){let C=new Date(v);isNaN(C.getTime())?g=String(v):g=C.toLocaleDateString()}}g&&c.createDiv("card-date").appendText(g)}}if(t.showTextPreview||t.showTags&&e.displayTags&&e.displayTags.length>0||t.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||t.imageFormat==="cover"){let d=c.createDiv("card-content");if(t.imageFormat==="thumbnail"){let h=d.createDiv("card-text-wrapper");if(t.showTextPreview){let g=h.createDiv("card-text-preview");e.snippet&&g.setText(e.snippet),c.__textPreviewEl=g,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let g=h.createDiv("card-tags"),v=t.maxTagsToShow,C=e.displayTags.slice(0,v),E=e.displayTags.length-v;C.forEach(k=>{g.createSpan("card-tag").appendText(k)}),E>0&&g.createSpan("card-tag-more").appendText(`+${E} more`)}}else{if(t.showTextPreview){let h=d.createDiv("card-text-preview");e.snippet&&h.setText(e.snippet),c.__textPreviewEl=h,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let h=d.createDiv("card-tags"),g=t.maxTagsToShow,v=e.displayTags.slice(0,g),C=e.displayTags.length-g;v.forEach(E=>{h.createSpan("card-tag").appendText(E)}),C>0&&h.createSpan("card-tag-more").appendText(`+${C} more`)}}if(t.imageFormat!=="none"&&e.imageUrl){let g=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(E=>E&&typeof E=="string"&&E.trim().length>0),v=t.imageFormat==="cover"?"card-cover":"card-thumbnail",C=d.createDiv(v);if(g.length>0){let E=C.createDiv("image-embed"),k=E.createEl("img",{attr:{alt:"",decoding:"async",sizes:t.imageFormat==="cover"?"100vw":"80px"}});return E.style.setProperty("--cover-image-url",`url("${g[0]}")`),t.showDraftStatus&&t.imageFormat==="cover"&&Q(C,s,e.path,t,l),this.propertyRenderer.renderProperties(c,e,s,t,l),{img:k,src:g[0]}}}else if(t.imageFormat==="cover"){let h=d.createDiv("card-cover-placeholder");Q(h,s,e.path,t,l)}}return this.propertyRenderer.renderProperties(c,e,s,t,l),null}};var _e=require("obsidian");var L=require("obsidian");async function fe(o,i,e,s){await o.fileManager.processFrontMatter(i,t=>{for(let[a,n]of e){if(a==="tags"&&!Object.prototype.hasOwnProperty.call(t,"tags")&&!Array.isArray(n.data)){t[a]=[n.data];continue}if(!t[a]||s){t[a]=n.data;continue}let r=n.type,l=t[a],c=Array.isArray(l)?"list":typeof l=="number"?"number":typeof l=="boolean"?"checkbox":"text";if(ht(r,c)){if(t[a]===n.data||!n.data)continue;let p=ut(t[a],n.data);t[a]=p;continue}else{t[a]=n.data;continue}}})}async function Ne(o,i,e){await o.fileManager.processFrontMatter(i,s=>{for(let t of e)s[t]=void 0})}function ht(o,i){let e=["number","date","datetime","checkbox"];return!(e.includes(o)||e.includes(i))}function ut(...o){let e=o.map(t=>Array.isArray(t)?t:[t]).flat();return[...new Set(e)]}var B=class{constructor(i){this.app=i}async setDraft(i,e,s){await this.batchProcessFiles(i,async t=>{if(s)if(s.draftStatusUseFilenamePrefix){let a=t.basename,n=a.startsWith("_"),l=t.path.split("/"),c=e;if(s.draftStatusReverse&&(c=!e),c===!0){if(!n){let p=`_${a}${t.extension?`.${t.extension}`:""}`;l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else if(n){let p=a.substring(1)+(t.extension?`.${t.extension}`:"");l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else{let a=s.draftStatusProperty&&s.draftStatusProperty.trim()?s.draftStatusProperty.startsWith("note.")?s.draftStatusProperty.substring(5):s.draftStatusProperty:"draft",n=e;s.draftStatusReverse&&(n=!e),await this.app.fileManager.processFrontMatter(t,r=>{r[a]=n})}else await this.app.fileManager.processFrontMatter(t,a=>{a.draft=e})}),new L.Notice(`Set ${i.length} file${i.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(i,e){let s=new Map;s.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(i,async t=>{await fe(this.app,t,s,!1)}),new L.Notice(`Added tags to ${i.length} file${i.length!==1?"s":""}`)}async removeTags(i,e){await this.batchProcessFiles(i,async s=>{let t=this.app.metadataCache.getFileCache(s),a=t==null?void 0:t.frontmatter;if(a!=null&&a.tags){let r=(Array.isArray(a.tags)?a.tags:[a.tags]).filter(l=>!e.includes(l));await this.app.fileManager.processFrontMatter(s,l=>{r.length>0?l.tags=r:l.tags=void 0})}}),new L.Notice(`Removed tags from ${i.length} file${i.length!==1?"s":""}`)}async setProperty(i,e,s,t="text"){let a=e.startsWith("note.")?e.substring(5):e,n=new Map;n.set(a,{type:t,data:s,overwrite:!0,delimiter:","}),await this.batchProcessFiles(i,async r=>{await fe(this.app,r,n,!0)}),new L.Notice(`Set ${a} on ${i.length} file${i.length!==1?"s":""}`)}async removeProperty(i,e){let s=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(i,async t=>{await Ne(this.app,t,[s])}),new L.Notice(`Removed ${s} from ${i.length} file${i.length!==1?"s":""}`)}async batchProcessFiles(i,e){let s=0,t=i.length;for(let a of i){let n=this.app.vault.getAbstractFileByPath(a);if(n instanceof L.TFile)try{await e(n),s++}catch(r){console.error(`Error processing ${a}:`,r)}}s<t&&new L.Notice(`Processed ${s} of ${t} files`)}};var I=require("obsidian");var Z=class extends I.Modal{constructor(e,s){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=s,this.bulkOps=new B(e)}onOpen(){let{contentEl:e}=this;e.empty(),new I.Setting(e).setName("Manage tags").setHeading(),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new I.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated).").addText(l=>{l.setPlaceholder("tag1, tag2, tag3").onChange(c=>{this.tagsToAdd=c})}),e.createEl("h3",{text:"Remove tags"});let s=e.createDiv(),t=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof I.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;u!=null&&u.tags&&(Array.isArray(u.tags)?u.tags:[u.tags]).forEach(h=>t.add(h))}}for(let l of Array.from(t).sort())new I.Setting(s).setName(l).addToggle(c=>{c.setValue(this.tagsToRemove.has(l)).onChange(p=>{p?this.tagsToRemove.add(l):this.tagsToRemove.delete(l)})});let a=e.createDiv();a.addClass("bases-cms-modal-button-container");let n=a.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=a.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>(await this.applyChanges(),this.close()))()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(s=>s.trim()).filter(s=>s.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var V=require("obsidian");var X=class extends V.Modal{constructor(e,s){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=s,this.bulkOps=new B(e)}onOpen(){let{contentEl:e}=this;e.empty(),new V.Setting(e).setName("Set property").setHeading(),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new V.Setting(e).setName("Property name").setDesc("Enter the property name to set.").addText(n=>{n.setPlaceholder("Enter name").onChange(r=>{this.propertyName=r})}),new V.Setting(e).setName("Property type").setDesc("Select the property type.").addDropdown(n=>{n.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(r=>{this.propertyType=r})}),new V.Setting(e).setName("Property value").setDesc("Enter the property value.").addText(n=>{n.setPlaceholder("Enter value").onChange(r=>{this.propertyValue=r})});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let a=s.createEl("button");a.setText("Apply"),a.addClass("mod-cta"),a.addEventListener("click",()=>{(async()=>this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close()))()})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var R=require("obsidian");var Y=class extends R.Modal{constructor(e,s){super(e);this.propertiesToRemove=new Set;this.files=s,this.bulkOps=new B(e)}onOpen(){let{contentEl:e}=this;e.empty(),new R.Setting(e).setName("Remove property").setHeading(),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let s=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof R.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;if(u)for(let d in u)d!=="tags"&&d!=="title"&&s.add(d)}}let t=e.createDiv();for(let l of Array.from(s).sort())new R.Setting(t).setName(l).addToggle(c=>{c.setValue(this.propertiesToRemove.has(l)).onChange(p=>{p?this.propertiesToRemove.add(l):this.propertiesToRemove.delete(l)})});s.size===0&&e.createEl("p",{text:"No properties found in selected files."});let a=e.createDiv();a.addClass("bases-cms-modal-button-container");let n=a.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=a.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close()))()})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var se=require("obsidian");var O=require("obsidian");var $=require("obsidian");function Ve(o,i){let e=[],s=o.vault.getAbstractFileByPath(i.path);if(s instanceof $.TFile){let t=o.metadataCache.getFileCache(s),a=(t==null?void 0:t.embeds)||[];for(let n of a){let r=o.metadataCache.getFirstLinkpathDest(n.link,i.path);r instanceof $.TFile&&e.push(r)}}return e}function Re(o,i){let e=[];for(let s of i.children)s instanceof $.TFile&&s.extension==="md"?e.push(...Ve(o,s)):s instanceof $.TFolder&&e.push(...Re(o,s));return e}async function gt(o,i,e,s){let t=o.vault.getMarkdownFiles().filter(l=>l.path!==e.path),a=i.path,n=i.name,r=i.basename;for(let l of t){if(s&&l.path.startsWith(s.path+"/"))continue;let c=await o.vault.read(l);if(c.includes(a)||c.includes(n)||c.includes(r)||c.includes(`![[${n}]]`)||c.includes(`[[${n}]]`)||c.includes(`(${n})`)||c.includes(`(${a})`))return!0}return!1}async function $e(o,i,e){let s=[];s.push(...Ve(o,i)),e&&s.push(...Re(o,e));let t=Array.from(new Set(s.map(n=>n.path))).map(n=>o.vault.getAbstractFileByPath(n)).filter(n=>n instanceof $.TFile),a=[];for(let n of t)await gt(o,n,i,e)||a.push(n);return a}function mt(o,i){let e=i.deleteParentFolderFilename||"index";return o.basename===e&&o.parent!==null}function qe(o,i){return i.deleteParentFolder&&mt(o,i)}async function be(o,i,e){let s=[],t=[],a=[];for(let l of i){let c=o.vault.getAbstractFileByPath(l);if(c instanceof O.TFile){if(qe(c,e)){let p=c.parent;if(p&&!t.includes(p)){t.push(p);let u=p.children.filter(d=>d instanceof O.TFile);s.push(...u)}}else s.push(c);if(e.deleteUniqueAttachments){let p=qe(c,e)&&c.parent||void 0,u=await $e(o,c,p);a.push(...u)}}}let n=Array.from(new Set(s.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof O.TFile),r=Array.from(new Set(a.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof O.TFile);return{filesToDelete:n,foldersToDelete:Array.from(new Set(t)),attachmentsToDelete:r}}async function ee(o,i){let e=0,s=0;for(let t of i.filesToDelete)try{await o.fileManager.trashFile(t),e++}catch(a){console.error(`Error deleting file ${t.path}:`,a),s++}for(let t of i.attachmentsToDelete)try{await o.fileManager.trashFile(t),e++}catch(a){console.error(`Error deleting attachment ${t.path}:`,a),s++}for(let t of i.foldersToDelete)try{await o.fileManager.trashFile(t),e++}catch(a){console.error(`Error deleting folder ${t.path}:`,a),s++}s>0?new O.Notice(`Deleted ${e} items, ${s} errors occurred`):new O.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var te=class extends se.Modal{constructor(e,s,t){super(e);this.preview=s,this.onConfirm=t}onOpen(){let{contentEl:e}=this;if(e.empty(),new se.Setting(e).setName("Confirm deletion").setHeading(),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.filesToDelete.slice(0,20))n.createEl("li").setText(r.path);this.preview.filesToDelete.length>20&&n.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.foldersToDelete)n.createEl("li").setText(r.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.attachmentsToDelete.slice(0,20))n.createEl("li").setText(r.path);this.preview.attachmentsToDelete.length>20&&n.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"This action cannot be undone.",cls:"bases-cms-deletion-warning"});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let a=s.createEl("button");a.setText("Delete"),a.addClass("mod-cta"),a.addClass("destructive"),a.addEventListener("click",()=>{(async()=>(await ee(this.app,this.preview),this.onConfirm(),this.close()))()})}onClose(){let{contentEl:e}=this;e.empty()}};var ie=require("obsidian"),H=class extends ie.Modal{constructor(e,s,t,a){super(e);this.files=s,this.operation=t,this.onConfirm=a}onOpen(){let{contentEl:e}=this;e.empty();let s=this.operation==="draft"?"mark as draft":"mark as published",t=s.charAt(0).toUpperCase()+s.slice(1);if(new ie.Setting(e).setName(`Confirm ${t}`).setHeading(),e.createEl("p",{text:`Are you sure you want to ${s} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let l=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let c of this.files.slice(0,20))l.createEl("li").setText(c);this.files.length>20&&l.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let a=e.createDiv();a.addClass("bases-cms-modal-button-container");let n=a.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=a.createEl("button");r.setText("Confirm"),r.addClass("mod-cta"),r.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var ne=class{constructor(i,e,s,t,a,n){this.app=i;this.plugin=e;this.getSelectedFiles=s;this.clearSelection=t;this.refreshView=a;this.showToolbar=n;this.bulkOps=new B(i)}async handleSetDraft(i){let e=this.getSelectedFiles();e.length!==0&&(this.plugin.settings.confirmBulkOperations?new H(this.app,e,"draft",()=>{(async()=>(await this.bulkOps.setDraft(e,!0,i),this.refreshView()))()}).open():(await this.bulkOps.setDraft(e,!0,i),this.refreshView()))}async handlePublish(i){let e=this.getSelectedFiles();e.length!==0&&(this.plugin.settings.confirmBulkOperations?new H(this.app,e,"publish",()=>{(async()=>(await this.bulkOps.setDraft(e,!1,i),this.refreshView()))()}).open():(await this.bulkOps.setDraft(e,!1,i),this.refreshView()))}handleManageTags(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new Z(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}handleSetProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new X(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}handleRemoveProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new Y(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}async handleDelete(){let i=this.getSelectedFiles();if(i.length!==0)if(this.plugin.settings.confirmDeletions){let e=await be(this.app,i,this.plugin.settings);new te(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await be(this.app,i,this.plugin.settings);await ee(this.app,e),this.clearSelection(),this.refreshView()}}};var ae=class{constructor(i,e,s,t,a,n,r,l){this.app=i;this.plugin=e;this.container=s;this.getSelectedFiles=t;this.clearSelection=a;this.refreshView=n;this.toolbarEl=null;this.countEl=null;this.resizeObserver=null;this.timeoutIds=[];this.selectAllCallback=r,this.settings=l,this.actions=new ne(this.app,this.plugin,this.getSelectedFiles,this.clearSelection,this.refreshView,()=>this.show()),this.createToolbar()}updateSettings(i){this.settings=i}createToolbar(){this.toolbarEl=document.createElement("div"),this.toolbarEl.className="bases-toolbar bases-cms-bulk-toolbar bases-cms-bulk-toolbar-hidden",this.toolbarEl.__bulkToolbarInstance=this,this.createToolbarContent(),this.positionToolbar();let i=window.setTimeout(()=>this.positionToolbar(),100);this.timeoutIds.push(i)}positionToolbar(){if(!this.toolbarEl)return;let i=this.container.closest(".bases-header");if(!i){let s=this.container.parentElement;for(;s&&!i;){if(s.classList.contains("bases-header")){i=s;break}s=s.parentElement}}if(!i){let s=Array.from(document.querySelectorAll(".bases-header"));for(let t of s)if(t.contains(this.container)){i=t;break}}let e=this.container.closest(".view-content");if(e)this.toolbarEl.parentElement!==e?(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container)):this.toolbarEl.nextSibling!==this.container&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container));else if(i&&i.parentElement)this.toolbarEl.parentElement!==i.parentElement&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),i.parentElement.insertBefore(this.toolbarEl,i.nextSibling));else{let s=this.container.parentElement;s&&(this.toolbarEl.parentElement!==s||this.toolbarEl.nextSibling!==this.container)&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),s.insertBefore(this.toolbarEl,this.container))}}createToolbarContent(){if(!this.toolbarEl)return;let i=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-left"),e=(a,n,r,l,c=!1)=>{let u=l.createDiv("bases-toolbar-item").createDiv("text-icon-button");c&&u.addClass("destructive"),u.setAttribute("tabindex","0");let d=u.createSpan("text-button-icon");return(0,_e.setIcon)(d,a),u.createSpan("text-button-label").setText(n),u.addEventListener("click",r),u};this.plugin.settings.showToolbarSelectAll&&e("copy-check","Select all",()=>this.handleSelectAll(),i),this.plugin.settings.showToolbarClear&&e("square-x","Clear",()=>this.clearSelection(),i);let s=i.createDiv("bases-toolbar-item bases-cms-selected-count");this.countEl=s.createSpan("text-button-label"),this.countEl.setText("0 items selected");let t=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-right");this.plugin.settings.showToolbarPublish&&e("book-check","Publish",()=>{this.actions.handlePublish(this.settings)},t),this.plugin.settings.showToolbarDraft&&e("book-dashed","Draft",()=>{this.actions.handleSetDraft(this.settings)},t),this.plugin.settings.showToolbarTags&&e("tags","Tags",()=>this.actions.handleManageTags(),t),this.plugin.settings.showToolbarSet&&e("list-check","Set",()=>this.actions.handleSetProperty(),t),this.plugin.settings.showToolbarRemove&&e("list-x","Remove",()=>this.actions.handleRemoveProperty(),t),this.plugin.settings.showToolbarDelete&&e("trash-2","Delete",()=>{this.actions.handleDelete()},t,!0),this.setupResponsiveBehavior()}setupResponsiveBehavior(){if(!this.toolbarEl)return;let i=window.setTimeout(()=>{this.updateCollapsedState()},100);this.timeoutIds.push(i),this.toolbarEl&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCollapsedState()}),this.resizeObserver.observe(this.toolbarEl));let e=this.container;if(e){let s=new ResizeObserver(()=>{let t=window.setTimeout(()=>{this.updateCollapsedState()},10);this.timeoutIds.push(t)});s.observe(e),this.containerObserver=s}}updateCollapsedState(){if(!this.toolbarEl)return;this.toolbarEl.offsetWidth<680?this.toolbarEl.addClass("collapsed"):this.toolbarEl.removeClass("collapsed")}updateCount(i){this.countEl&&this.countEl.setText(`${i} item${i!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){if(this.toolbarEl||(console.warn("[Bases CMS] Toolbar element not found, recreating..."),this.createToolbar()),this.toolbarEl){this.positionToolbar(),this.toolbarEl.parentElement||(console.warn("[Bases CMS] Toolbar not in DOM, repositioning..."),this.positionToolbar()),this.toolbarEl.removeClass("bases-cms-bulk-toolbar-hidden"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.offsetHeight;let i=window.setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-out"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-in"))},10);this.timeoutIds.push(i)}else console.error("[Bases CMS] Failed to show toolbar - element is null")}hide(){if(this.toolbarEl){this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-in"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-out");let i=window.setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-hidden"))},200);this.timeoutIds.push(i)}}recreate(){let i=this.toolbarEl&&!this.toolbarEl.hasClass("bases-cms-bulk-toolbar-hidden"),e=0;if(this.countEl&&this.countEl.textContent){let s=this.countEl.textContent.match(/\d+/);s&&(e=parseInt(s[0],10))}this.destroy(),this.createToolbar(),i&&this.toolbarEl&&e>0&&(this.updateCount(e),this.show())}destroy(){this.timeoutIds.forEach(e=>window.clearTimeout(e)),this.timeoutIds=[],this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);let i=this.containerObserver;i&&(i.disconnect(),this.containerObserver=void 0),this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};_();function ze(o,i,e,s,t){let a=l=>{var C;let c=l.target,p=c.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!p||c.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let u=o.workspace.activeLeaf,d=u==null?void 0:u.view,h=d?d.containerEl:null;if(!(d&&h&&(h===i||((C=p.closest(".workspace-leaf"))==null?void 0:C.contains(h)))))return;let v=D(e,s);v.customizeNewButton&&(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),(async()=>{var m;let E=((m=v.newNoteLocation)==null?void 0:m.trim())||"";if(E===""){let f=o.vault.config,w=(f==null?void 0:f.newFileLocation)||"folder",S=(f==null?void 0:f.newFileFolderPath)||"";console.debug("[CMS View] Obsidian config:",{newFileLocation:w,newFileFolderPath:S});let T="Untitled.md";if(w==="folder"&&S)T=`${S}/Untitled.md`;else if(w==="current"){let y=o.workspace.getActiveFile();y&&y.parent&&(T=`${y.parent.path}/Untitled.md`)}else w==="root"&&(T="Untitled.md");console.debug("[CMS View] Creating file at:",T);let P=await o.vault.create(T,"");await o.workspace.openLinkText(P.path,"",!1);return}if(E==="/"||E.replace(/\//g,"")===""){let f=await o.vault.create("Untitled.md","");await o.workspace.openLinkText(f.path,"",!1);return}let k=E.replace(/^\/+|\/+$/g,""),b=o.vault.getAbstractFileByPath(k);if((!b||!("children"in b))&&(await o.vault.createFolder(k),b=o.vault.getAbstractFileByPath(k)),b&&"children"in b){let f=await o.vault.create(`${k}/Untitled.md`,"");await o.workspace.openLinkText(f.path,"",!1)}})())};document.addEventListener("click",a,!0);let n=new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(c=>{let p=c;p.__cmsIntercepted||(p.__cmsIntercepted=!0,c.addEventListener("click",a,!0))})});n.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(l=>{let c=l;c.__cmsIntercepted||(c.__cmsIntercepted=!0,l.addEventListener("click",a,!0))}),t(()=>{document.removeEventListener("click",a,!0),n.disconnect()})}var He=require("obsidian");_();var oe=class{constructor(i,e,s,t){this.app=i;this.config=e;this.pluginSettings=s;this.onRefresh=t}async handlePropertyToggle(i,e,s){try{let t=this.app.vault.getAbstractFileByPath(i);if(!(t instanceof He.TFile))return;let a=e.startsWith("note.")?e.substring(5):e,n=D(this.config,this.pluginSettings),r=n.showDraftStatus&&a==="draft",l=!1;if(r)if(n.draftStatusUseFilenamePrefix){let c=t.basename,p=c.startsWith("_"),d=t.path.split("/");if(s===!0){if(!p){let h=`_${c}${t.extension?`.${t.extension}`:""}`;d[d.length-1]=h;let g=d.join("/");await this.app.fileManager.renameFile(t,g),l=!0}}else if(p){let h=c.substring(1)+(t.extension?`.${t.extension}`:"");d[d.length-1]=h;let g=d.join("/");await this.app.fileManager.renameFile(t,g),l=!0}}else{let c=n.draftStatusProperty&&n.draftStatusProperty.trim()?n.draftStatusProperty.startsWith("note.")?n.draftStatusProperty.substring(5):n.draftStatusProperty:"draft";await this.app.fileManager.processFrontMatter(t,p=>{p[c]=s}),l=!0}else await this.app.fileManager.processFrontMatter(t,c=>{c[a]=s}),l=!0;l&&requestAnimationFrame(()=>{window.setTimeout(()=>{try{this.onRefresh()}catch(c){console.error("Error refreshing view after property toggle:",c)}},100)})}catch(t){console.error("Error toggling property:",t)}}};_();var re=class{constructor(i,e,s,t,a,n){this.containerEl=i;this.app=e;this.config=s;this.pluginSettings=t;this.onLoadMore=a;this.registerCleanup=n;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.windowResizeHandler=null;this.isLoading=!1;this.displayedCount=50;this.totalEntries=0;var l;let r=(l=this.app.isMobile)!=null?l:!1;this.displayedCount=r?25:50}setDisplayedCount(i){this.displayedCount=i}getDisplayedCount(){return this.displayedCount}setIsLoading(i){this.isLoading=i}setupInfiniteScroll(i){this.totalEntries=i,this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=i)&&(this.scrollListener=()=>{var c;if(this.scrollThrottleTimeout!==null||this.isLoading)return;let e=this.containerEl.scrollTop,s=this.containerEl.scrollHeight,t=this.containerEl.clientHeight,a=s-(e+t),r=((c=this.app.isMobile)!=null?c:!1)?1:2,l=t*r;if(a<l&&this.displayedCount<i){this.isLoading=!0;let p=50;this.displayedCount=Math.min(this.displayedCount+p,i),this.onLoadMore()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.registerCleanup(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}setupResizeObserver(){if(this.resizeObserver)return;let i=()=>{let e=D(this.config,this.pluginSettings),s=e.cardSize;this.containerEl.style.setProperty("--card-min-width",`${s}px`),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(e.imageAspectRatio))};this.resizeObserver=new ResizeObserver(i),this.resizeObserver.observe(this.containerEl),i()}updateGridLayout(i){this.containerEl.style.setProperty("--card-min-width",`${i.cardSize}px`),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(i.imageAspectRatio))}cleanup(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.windowResizeHandler&&(window.removeEventListener("resize",this.windowResizeHandler),this.windowResizeHandler=null),this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),this.scrollThrottleTimeout!==null&&(window.clearTimeout(this.scrollThrottleTimeout),this.scrollThrottleTimeout=null)}};var le=class{constructor(i,e,s,t,a,n,r,l){this.containerEl=i;this.plugin=e;this.config=s;this.controller=t;this.data=a;this.selectedFiles=n;this.onSelectionCleared=r;this.registerCleanup=l;this.mutationObserver=null;this.backupInterval=null;this.currentBaseIdentifier=null}setup(i){let e=()=>{this.mutationObserver||(this.mutationObserver=new MutationObserver(l=>{if(this.selectedFiles.size!==0){for(let c of l)if(c.type==="childList"&&c.removedNodes.length>0){let p=!1;for(let d of this.selectedFiles)if(this.containerEl.querySelector(`[data-path="${d}"]`)){p=!0;break}let u=this.containerEl.querySelectorAll(".card[data-path]");if(!p||u.length===0){this.selectedFiles.clear(),this.onSelectionCleared();break}}}}),this.containerEl&&this.mutationObserver.observe(this.containerEl,{childList:!0,subtree:!0}))},s=()=>{this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,this.selectedFiles.size>0&&this.selectedFiles.clear(),this.onSelectionCleared())},t=()=>{var l,c,p,u;try{if((l=this.config)!=null&&l.getName)return this.config.getName();if((c=this.config)!=null&&c.name)return String(this.config.name);if(this.controller){if((p=this.controller)!=null&&p.getBaseName)return this.controller.getBaseName();if((u=this.controller)!=null&&u.baseName)return String(this.controller.baseName)}if(this.data&&this.data.baseName)return String(this.data.baseName)}catch(d){}return null},a=()=>{if(this.selectedFiles.size===0){this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}let l=t();if(this.currentBaseIdentifier!==null&&l!==null&&this.currentBaseIdentifier!==l){this.selectedFiles.clear(),this.onSelectionCleared(),s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}this.containerEl.querySelectorAll(".card[data-path]").length===0&&(this.selectedFiles.clear(),this.onSelectionCleared())},n=i.bind(this),r=(l,c)=>{n(l,c),this.selectedFiles.size>0?(this.currentBaseIdentifier===null&&(this.currentBaseIdentifier=t()),e(),this.backupInterval===null&&(this.backupInterval=this.plugin.registerInterval(window.setInterval(a,500)))):(this.currentBaseIdentifier=null,s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null))};return this.registerCleanup(()=>{s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)}),r}cleanup(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)}};var ye="bases-cms",ce=class extends z.BasesView{constructor(e,s,t){super(e);this.type=ye;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.containerEl=s,this.plugin=t,this.cardRenderer=new K(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container"),this.propertyToggleHandler=new oe(this.app,this.config,this.plugin.settings,()=>this.onDataUpdated()),this.scrollLayoutManager=new re(this.containerEl,this.app,this.config,this.plugin.settings,()=>this.onDataUpdated(),n=>this.register(n)),this.viewSwitchListener=new le(this.containerEl,this.plugin,this.config,this.controller,this.data,this.selectedFiles,()=>this.updateSelectionUI(),n=>this.register(n)),ze(this.app,this.containerEl,this.config,this.plugin.settings,n=>this.register(n));let a=this.handleSelectionChange.bind(this);this.handleSelectionChange=this.viewSwitchListener.setup(a)}onDataUpdated(){let e=this.app.workspace.activeLeaf,s=e==null?void 0:e.view;if(s&&this.selectedFiles.size>0&&s!==this){if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)){this.selectedFiles.clear(),this.updateSelectionUI();return}let n=s.containerEl;if(!n||!n.contains(this.containerEl)){this.selectedFiles.clear(),this.updateSelectionUI();return}}if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)&&this.selectedFiles.size>0){this.selectedFiles.clear(),this.updateSelectionUI();return}(async()=>{var k;let a=this.data.groupedData,n=this.data.data;this.cardRenderer.basesConfig=this.config;let r=D(this.config,this.plugin.settings);this.scrollLayoutManager.updateGridLayout(r);let l=this.containerEl.scrollTop,c=this.getSortMethod(),p=a.map(b=>({group:b,entries:[...b.entries]})),u=[],d=this.scrollLayoutManager.getDisplayedCount();for(let b of p){if(d<=0)break;let m=Math.min(b.entries.length,d);u.push(...b.entries.slice(0,m)),d-=m}let h=[];if(r.imageFormat!=="none"){let b=u.filter(f=>!(f.file.path in this.images)).map(f=>{let w=this.app.vault.getAbstractFileByPath(f.file.path);if(!(w instanceof z.TFile))return null;let S=he(f,r.imageProperty);return{path:f.file.path,file:w,imagePropertyValues:S}}).filter(f=>f!==null),m=n.filter(f=>!(f.file.path in this.images)&&!u.some(w=>w.file.path===f.file.path)).map(f=>{let w=this.app.vault.getAbstractFileByPath(f.file.path);if(!(w instanceof z.TFile))return null;let S=he(f,r.imageProperty);return{path:f.file.path,file:w,imagePropertyValues:S}}).filter(f=>f!==null);if(b.length>0&&h.push(me(b,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable).then(()=>{requestAnimationFrame(()=>{b.forEach(f=>{f.path in this.images&&this.updateCardImage(f.path,this.images[f.path])})})})),m.length>0&&h.push(me(m,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable)),r.fallbackToEmbeds){let w=[...b,...m].filter(S=>!(S.path in this.images)&&!this.hasImageAvailable[S.path]);w.length>0&&h.push(Be(w,this.app,this.images,this.hasImageAvailable).then(()=>{requestAnimationFrame(()=>{w.forEach(S=>{S.path in this.images&&this.updateCardImage(S.path,this.images[S.path])})})}))}}if(r.showTextPreview){let b=u.filter(m=>!(m.file.path in this.snippets)).map(m=>{let f=this.app.vault.getAbstractFileByPath(m.file.path);if(!(f instanceof z.TFile))return null;let w=M(m,r.descriptionProperty);return{path:m.file.path,file:f,descriptionData:w==null?void 0:w.data}}).filter(m=>m!==null);Le(b,r.fallbackToContent,!1,this.app,this.snippets).then(()=>{requestAnimationFrame(()=>{b.forEach(m=>{if(m.path in this.snippets&&this.snippets[m.path]){let f=this.containerEl.querySelector(`[data-path="${m.path}"]`);if(f){let w=f.__textPreviewEl;w&&(!w.textContent||w.textContent.trim().length===0)&&w.setText(this.snippets[m.path])}}})})})}let g=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let b=this.containerEl.querySelector(".bases-cms-bulk-toolbar");b instanceof HTMLElement&&(g=b,g.remove())}this.containerEl.empty(),this.propertyObservers.forEach(b=>b.disconnect()),this.propertyObservers=[];let v=this.containerEl.createDiv("bases-cms-grid"),C=0,E=[];for(let b of p){if(C>=this.scrollLayoutManager.getDisplayedCount())break;let m=Math.min(b.entries.length,this.scrollLayoutManager.getDisplayedCount()-C);if(m===0)continue;let f=b.entries.slice(0,m),w=v.createDiv("bases-cms-group");if(b.group.hasKey()){let P=w.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),y=((k=b.group.key)==null?void 0:k.toString())||"";P.setText(y)}let S=ke(f,r,c,!1,this.snippets,this.images,this.hasImageAvailable);for(let T=0;T<S.length;T++){let P=S[T],y=f[T],N=this.renderCard(w,P,y,C+T,r);N&&E.push(N)}C+=m}E.length>0&&requestAnimationFrame(()=>{for(let{img:b,src:m}of E)b.src=m}),l>0&&(this.containerEl.scrollTop=l),this.scrollLayoutManager.setupInfiniteScroll(n.length),this.scrollLayoutManager.setupResizeObserver(),g&&this.bulkToolbar&&(this.containerEl.appendChild(g),this.bulkToolbar.toolbarEl=g),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(m=>{let f=m.getAttribute("data-path"),w=m.querySelector('input[type="checkbox"].selection-checkbox');if(f){let S=this.selectedFiles.has(f);S?m.addClass("selected"):m.removeClass("selected"),w&&(w.checked=S)}}),g&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.scrollLayoutManager.setIsLoading(!1)})()}renderCard(e,s,t,a,n){let r=this.selectedFiles.has(s.path);return this.cardRenderer.renderCard(e,s,t,n,this,r,(l,c)=>{this.handleSelectionChange(l,c)},(l,c,p)=>{this.handlePropertyToggle(l,c,p)})}updateCardImage(e,s){var r;let t=this.containerEl.querySelector(`.card[data-path="${e}"]`);if(!t)return;let a=Array.isArray(s)?s[0]:s;if(!a)return;let n=t.querySelector("img");if(n){if(n.src!==a){n.src=a;let l=n.parentElement;l&&l.classList.contains("image-embed")&&l.style.setProperty("--cover-image-url",`url("${a}")`)}}else{let l=t.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(l){let c=l.querySelector(".card-status-badge"),p=l.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",u=(r=l.parentElement)==null?void 0:r.createDiv(p);if(u){let d=u.createDiv("image-embed");n=d.createEl("img",{attr:{src:a,alt:"",decoding:"async"}}),d.style.setProperty("--cover-image-url",`url("${a}")`),c&&u.appendChild(c),l.remove()}}}}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let s=e[0],t=s.property,a=s.direction.toLowerCase();if(t.includes("ctime"))return`ctime-${a}`;if(t.includes("mtime"))return`mtime-${a}`}return"mtime-desc"}handleSelectionChange(e,s){if(s?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI(),this.selectedFiles.size===0&&this.bulkToolbar){this.bulkToolbar.hide();let t=this.containerEl.querySelector(".bases-cms-bulk-toolbar");t instanceof HTMLElement&&(t.removeClass("bases-cms-bulk-toolbar-visible"),t.addClass("bases-cms-bulk-toolbar-hidden"))}}async handlePropertyToggle(e,s,t){await this.propertyToggleHandler.handlePropertyToggle(e,s,t)}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(s=>{let t=s.getAttribute("data-path");t&&this.selectedFiles.add(t)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}refreshToolbar(){if(this.bulkToolbar){let e=this.selectedFiles.size;this.bulkToolbar.recreate(),e>0&&this.bulkToolbar.updateCount(e)}}updateSelectionUI(){if(this.containerEl.querySelectorAll(".card").forEach(s=>{let t=s.getAttribute("data-path"),a=s.querySelector('input[type="checkbox"].selection-checkbox');if(t){let n=this.selectedFiles.has(t);n?s.addClass("selected"):s.removeClass("selected"),a&&(a.checked=n)}}),this.selectedFiles.size>0){if(document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>{let a=t.__bulkToolbarInstance;(!a||a!==this.bulkToolbar)&&t.remove()}),this.bulkToolbar){let t=D(this.config,this.plugin.settings);this.bulkToolbar.updateSettings(t)}else{let t=D(this.config,this.plugin.settings);this.bulkToolbar=new ae(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let a=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&a.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),window.setTimeout(()=>{a.forEach(n=>{this.app.vault.getAbstractFileByPath(n)&&this.selectedFiles.add(n)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),window.setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()},t)}this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()}else if(this.bulkToolbar&&!this.isRefreshingWithSelection){this.bulkToolbar.hide();let s=this.containerEl.querySelector(".bases-cms-bulk-toolbar");s instanceof HTMLElement&&(s.removeClass("bases-cms-bulk-toolbar-visible"),s.addClass("bases-cms-bulk-toolbar-hidden"))}}onClose(){this.scrollLayoutManager.cleanup(),this.viewSwitchListener.cleanup(),this.propertyObservers.forEach(t=>t.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy(),this.selectedFiles.clear(),document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>t.remove());let s=this.plugin;s&&typeof s.removeView=="function"&&s.removeView(this)}async onNew(){let e=D(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let s=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),t=this.app.vault.getAbstractFileByPath(s);if((!t||!("children"in t))&&(await this.app.vault.createFolder(s),t=this.app.vault.getAbstractFileByPath(s)),t&&"children"in t){let a=await this.app.vault.create(`${s}/Untitled.md`,"");return await this.app.workspace.openLinkText(a.path,"",!1),!0}}catch(s){console.error("[CMS View] Error creating new note:",s)}return!1}};function ve(o,i=5){try{let e=o;if(typeof e.registerBasesView=="function")e.registerBasesView(ye,{name:"CMS",icon:o.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(s,t)=>{let a=new ce(s,t,o),n=o;return n.activeViews&&n.activeViews.add(a),a},options:ft()});else if(i>0){let s=o,t=s.registrationTimeout;t!=null&&window.clearTimeout(t),s.registrationTimeout=window.setTimeout(()=>{s.registrationTimeout=null,ve(o,i-1)},200)}else console.warn("Bases CMS: registerBasesView not available. Is Bases plugin installed?")}catch(e){console.error("Bases CMS: Error registering view:",e)}}function ft(){let{getCMSViewOptions:o}=(_(),Se(Pe));return o}var pe=class extends Ue.Plugin{constructor(){super(...arguments);this.activeViews=new Set;this.registrationTimeout=null}async onload(){await this.loadSettings(),this.addSettingTab(new j(this.app,this)),ve(this)}onunload(){this.registrationTimeout!==null&&(window.clearTimeout(this.registrationTimeout),this.registrationTimeout=null),this.activeViews.clear()}async loadSettings(){this.settings=Object.assign({},Te,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}refreshAllToolbars(){let e=[];this.activeViews.forEach(s=>{let t=s.containerEl;(!t||!t.parentElement)&&e.push(s)}),e.forEach(s=>this.activeViews.delete(s)),this.activeViews.forEach(s=>{s&&typeof s.refreshToolbar=="function"&&s.refreshToolbar()})}removeView(e){this.activeViews.delete(e)}};
