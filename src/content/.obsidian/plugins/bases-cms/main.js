/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var he=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames;var Je=Object.prototype.hasOwnProperty;var Ke=(n,a)=>()=>(n&&(a=n(n=0)),a);var Te=(n,a)=>{for(var e in a)he(n,e,{get:a[e],enumerable:!0})},Xe=(n,a,e,s)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of Ze(a))!Je.call(n,t)&&t!==e&&he(n,t,{get:()=>a[t],enumerable:!(s=Ge(a,t))||s.enumerable});return n};var Se=n=>Xe(he({},"__esModule",{value:!0}),n);var Fe={};Te(Fe,{getCMSViewOptions:()=>et,readCMSSettings:()=>B});function B(n,a){var e,s,t,i,o,r,l,c,p,u,h,d,b,g,E,y;return{titleProperty:n.get("titleProperty")||"",descriptionProperty:n.get("descriptionProperty")||"",imageProperty:n.get("imageProperty")||"",showTitle:(e=n.get("showTitle"))!=null?e:!0,showDate:(s=n.get("showDate"))!=null?s:!1,dateProperty:n.get("dateProperty")||"",showTextPreview:(t=n.get("showTextPreview"))!=null?t:!0,fallbackToContent:(i=n.get("fallbackToContent"))!=null?i:!0,fallbackToEmbeds:(o=n.get("fallbackToEmbeds"))!=null?o:!1,propertyDisplay1:n.get("propertyDisplay1")||"",propertyDisplay2:n.get("propertyDisplay2")||"",propertyDisplay3:n.get("propertyDisplay3")||"",propertyDisplay4:n.get("propertyDisplay4")||"",propertyLayout12SideBySide:(r=n.get("propertyLayout12SideBySide"))!=null?r:!1,propertyLayout34SideBySide:(l=n.get("propertyLayout34SideBySide"))!=null?l:!1,imageFormat:n.get("imageFormat")||"thumbnail",propertyLabels:n.get("propertyLabels")||"hide",showDraftStatus:(c=n.get("showDraftStatus"))!=null?c:!1,draftStatusProperty:n.get("draftStatusProperty")||"",draftStatusReverse:(p=n.get("draftStatusReverse"))!=null?p:!1,draftStatusUseFilenamePrefix:(u=n.get("draftStatusUseFilenamePrefix"))!=null?u:!1,showTags:(h=n.get("showTags"))!=null?h:!1,tagsProperty:n.get("tagsProperty")||"",maxTagsToShow:(d=n.get("maxTagsToShow"))!=null?d:3,customizeNewButton:(b=n.get("customizeNewButton"))!=null?b:!1,newNoteLocation:n.get("newNoteLocation")||"",hideQuickEditIcon:(g=n.get("hideQuickEditIcon"))!=null?g:!1,cardSize:(E=n.get("cardSize"))!=null?E:250,imageAspectRatio:(y=n.get("imageAspectRatio"))!=null?y:.55}}function et(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Filename underscore prefix as draft indicator",key:"draftStatusUseFilenamePrefix",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"slider",displayName:"Maximum tags to show",key:"maxTagsToShow",min:1,max:50,step:1,default:3,showWhen:{key:"showTags",value:!0}},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""},{type:"toggle",displayName:"Hide quick edit icon",key:"hideQuickEditIcon",default:!1}]}var K=Ke(()=>{"use strict"});var ft={};Te(ft,{default:()=>pe});module.exports=Se(ft);var je=require("obsidian");var F=require("obsidian");var Ce=require("obsidian"),Z=class extends Ce.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){let e=this.app.commands,s=new Map;if(e&&typeof e.listCommands=="function")try{let i=e.listCommands();for(let o of i)o&&o.id&&o.name&&!s.has(o.id)&&s.set(o.id,{id:o.id,name:o.name})}catch(i){console.warn("[Bases CMS] Error getting commands via listCommands():",i)}try{let i=e==null?void 0:e.commands;if(i&&typeof i=="object"){let o=Object.values(i);for(let r of o)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via registry:",i)}try{let i=e==null?void 0:e.commandRegistry;if(i&&typeof i=="object"){let o=Object.values(i);for(let r of o)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via internal registry:",i)}let t=Array.from(s.values());return t.sort((i,o)=>i.name.localeCompare(o.name)),t}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.createDiv({cls:"suggestion-title",text:t.name})}};var J=class extends F.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}refreshActiveToolbars(){let e=this.plugin;e&&typeof e.refreshAllToolbars=="function"&&e.refreshAllToolbars()}display(){let{containerEl:e}=this;e.empty(),new F.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations.").addToggle(t=>t.setValue(this.plugin.settings.confirmBulkOperations).onChange(i=>{(async()=>(this.plugin.settings.confirmBulkOperations=i,await this.plugin.saveData(this.plugin.settings)))()})),new F.Setting(e).setName("Toolbar buttons").setHeading(),new F.Setting(e).setName("Show select all button").setDesc("Display the select all button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarSelectAll).onChange(i=>{(async()=>(this.plugin.settings.showToolbarSelectAll=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show clear button").setDesc("Display the clear selection button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarClear).onChange(i=>{(async()=>(this.plugin.settings.showToolbarClear=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show publish button").setDesc("Display the publish button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarPublish).onChange(i=>{(async()=>(this.plugin.settings.showToolbarPublish=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show draft button").setDesc("Display the draft button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarDraft).onChange(i=>{(async()=>(this.plugin.settings.showToolbarDraft=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show tags button").setDesc("Display the tags button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarTags).onChange(i=>{(async()=>(this.plugin.settings.showToolbarTags=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show set button").setDesc("Display the set property button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarSet).onChange(i=>{(async()=>(this.plugin.settings.showToolbarSet=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show remove button").setDesc("Display the remove property button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarRemove).onChange(i=>{(async()=>(this.plugin.settings.showToolbarRemove=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Show delete button").setDesc("Display the delete button in the CMS toolbar.").addToggle(t=>t.setValue(this.plugin.settings.showToolbarDelete).onChange(i=>{(async()=>(this.plugin.settings.showToolbarDelete=i,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new F.Setting(e).setName("Deletions").setHeading(),new F.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder and all its contents if the note file name matches the specified name.").addToggle(t=>t.setValue(this.plugin.settings.deleteParentFolder).onChange(i=>{(async()=>(this.plugin.settings.deleteParentFolder=i,await this.plugin.saveData(this.plugin.settings)))()})),new F.Setting(e).setName("Folder deletion file name").setDesc("File name that triggers parent folder deletion.").addText(t=>t.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(i=>{(async()=>(this.plugin.settings.deleteParentFolderFilename=i,await this.plugin.saveData(this.plugin.settings)))()})).setDisabled(!this.plugin.settings.deleteParentFolder),new F.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(t=>t.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(i=>{(async()=>(this.plugin.settings.deleteUniqueAttachments=i,await this.plugin.saveData(this.plugin.settings)))()})),new F.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files.").addToggle(t=>t.setValue(this.plugin.settings.confirmDeletions).onChange(i=>{(async()=>(this.plugin.settings.confirmDeletions=i,await this.plugin.saveData(this.plugin.settings)))()})),new F.Setting(e).setName("Appearance").setHeading(),new F.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(t=>t.setValue(this.plugin.settings.useHomeIcon).onChange(i=>{(async()=>(this.plugin.settings.useHomeIcon=i,await this.plugin.saveData(this.plugin.settings)))()})),new F.Setting(e).setName("Quick edit").setHeading(),new F.Setting(e).setName("Enable quick edit").setDesc("Show a pencil icon on card titles that launches a command when clicked.").addToggle(t=>t.setValue(this.plugin.settings.enableQuickEdit).onChange(i=>{(async()=>(this.plugin.settings.enableQuickEdit=i,await this.plugin.saveData(this.plugin.settings),s.settingEl.toggleClass("bases-cms-setting-hidden",!i)))()}));let s=new F.Setting(e).setName("Quick edit command").setDesc("The command to execute when clicking the quick edit icon on a card title.").addButton(t=>{var o;let i=this.plugin.settings.quickEditCommandName||(this.plugin.settings.quickEditCommand?"Select command...":"No command selected");if(t.setButtonText(i).onClick(()=>{new Z(this.app,l=>{(async()=>{let c=this.app.commands,p="";if(c){if(typeof c.listCommands=="function"){let h=c.listCommands().find(d=>d.id===l);h&&(p=h.name)}if(!p){let u=c.commands;u&&u[l]&&(p=u[l].name||"")}}this.plugin.settings.quickEditCommand=l,this.plugin.settings.quickEditCommandName=p,await this.plugin.saveData(this.plugin.settings),this.display()})()}).open()}),this.plugin.settings.quickEditCommand){let r=(o=t.buttonEl.parentElement)==null?void 0:o.createEl("button",{text:"Clear",attr:{style:"margin-left: 8px;"}});r==null||r.addEventListener("click",()=>{(async()=>(this.plugin.settings.quickEditCommand="",this.plugin.settings.quickEditCommandName="",await this.plugin.saveData(this.plugin.settings),this.display()))()})}});s.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit)}};var ke={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,enableQuickEdit:!1,quickEditCommand:"",quickEditCommandName:"",showToolbarSelectAll:!0,showToolbarClear:!0,showToolbarDraft:!0,showToolbarPublish:!0,showToolbarTags:!0,showToolbarSet:!0,showToolbarRemove:!0,showToolbarDelete:!0};var W=require("obsidian");function M(n,a){if(!a||!a.trim())return null;let e=a.split(",").map(s=>s.trim()).filter(s=>s);for(let s of e){let t=n.getValue(s),i=t;if(i&&("date"in i&&i.date instanceof Date||"data"in i))return t}return null}function Pe(n,a){if(!a||!a.trim())return[];let e=a.split(",")[0].trim();if(!e)return[];let s=n.getValue(e);if(!s||!("data"in s))return[];let t=s.data,i=[];if(Array.isArray(t)){for(let o of t)if(typeof o=="string"||typeof o=="number"){let r=String(o);if(r&&r.trim()){i.push(r);break}}}else if(t!=null&&t!==""&&(typeof t=="string"||typeof t=="number")){let o=String(t);o.trim()&&i.push(o)}return i}function xe(n,a,e,s){if(!n||n==="")return"";if(e){let t=e;if(typeof t.getDisplayName=="function")try{let i=t.getDisplayName(n);if(i&&typeof i=="string"&&i.trim()!=="")return i}catch(i){}}return n}function Ye(n,a,e,s,t,i,o){let r=n.file.basename||n.file.name,l=M(n,a.titleProperty),c=l==null?void 0:l.data,p=c!=null&&c!==""&&(typeof c=="string"||typeof c=="number")?String(c):r,u=n.file.path,h=u.split("/").slice(0,-1).join("/"),d=n.getValue("note.tags"),b=[];if(d&&d.data!=null){let m=d.data;b=(Array.isArray(m)?m.map(f=>f&&typeof f=="object"&&"data"in f?String(f.data):typeof f=="string"||typeof f=="number"?String(f):"").filter(f=>f):typeof m=="string"||typeof m=="number"?[String(m)]:[]).map(f=>f.replace(/^#/,""))}let g=n.getValue("file.tags"),E=[];if(g&&g.data!=null){let m=g.data;E=(Array.isArray(m)?m.map(f=>f&&typeof f=="object"&&f!==null&&"data"in f?String(f.data):typeof f=="string"||typeof f=="number"?String(f):"").filter(f=>typeof f=="string"&&f.length>0):typeof m=="string"||typeof m=="number"?[String(m)]:[]).map(f=>f.replace(/^#/,""))}let y=n.file.stat.ctime,S=n.file.stat.mtime,w=[];if(a.showTags&&a.tagsProperty){let m=M(n,a.tagsProperty);if(m&&m.data!=null){let v=m.data;Array.isArray(v)?w=v.map(f=>f&&typeof f=="object"&&"data"in f?String(f.data):typeof f=="string"||typeof f=="number"?String(f):"").filter(f=>typeof f=="string"&&f.length>0):(typeof v=="string"||typeof v=="number")&&(w=[String(v)])}}let T={path:u,name:r,title:p,tags:E,yamlTags:b,ctime:y,mtime:S,folderPath:h,snippet:t,imageUrl:i,hasImageAvailable:o||!1,displayTags:w.length>0?w:void 0},k=[a.propertyDisplay1,a.propertyDisplay2,a.propertyDisplay3,a.propertyDisplay4],P=new Set,x=k.map(m=>!m||m===""||P.has(m)?"":(P.add(m),m));return T.propertyName1=x[0]||void 0,T.propertyName2=x[1]||void 0,T.propertyName3=x[2]||void 0,T.propertyName4=x[3]||void 0,T.property1=x[0]?z(x[0],n,T,a):null,T.property2=x[1]?z(x[1],n,T,a):null,T.property3=x[2]?z(x[2],n,T,a):null,T.property4=x[3]?z(x[3],n,T,a):null,T}function De(n,a,e,s,t,i,o){return n.map(r=>Ye(r,a,e,s,t[r.file.path],i[r.file.path],o[r.file.path]))}function z(n,a,e,s){if(!n||n==="")return null;if(n==="file.path"||n==="file path")return e.folderPath||null;if(n==="tags"||n==="note.tags")return e.yamlTags.length>0?"tags":null;if(n==="file.tags"||n==="file tags")return e.tags.length>0?"tags":null;if(n==="file.ctime"||n==="created time")return new Date(e.ctime).toLocaleDateString();if(n==="file.mtime"||n==="modified time")return new Date(e.mtime).toLocaleDateString();let t=M(a,n);if(!t)return null;let i=t;if(!i)return null;if("date"in i&&i.date instanceof Date)return i.date.toLocaleDateString();let o=i.data;return o==null||o===""?null:Array.isArray(o)?o.length===0?null:o.map(r=>r&&typeof r=="object"&&"data"in r?String(r.data):String(r)).filter(r=>r&&r.trim()!=="").join(", "):typeof o=="string"||typeof o=="number"||typeof o=="boolean"?String(o):null}K();function Ae(n){return/^https?:\/\//i.test(n)}function ue(n){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(n)}function Me(n){return new Promise(a=>{let e=new Image;e.onload=()=>a(!0),e.onerror=()=>a(!1),setTimeout(()=>a(!1),5e3),e.src=n})}function tt(n){let a=n.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return a?a[1].trim():n}async function Be(n){let a=[],e=[];for(let o of n){let r=tt(o);r.length!==0&&(Ae(r)?(ue(r)||!r.includes("."))&&e.push(r):ue(r)&&a.push(r))}let s=e.map(o=>Me(o).then(r=>r?o:null)),i=(await Promise.all(s)).filter(o=>o!==null);return{internalPaths:a,externalUrls:i}}function Le(n,a,e){let s=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],t=[];for(let i of n){let o=e.metadataCache.getFirstLinkpathDest(i,a);if(o&&s.includes(o.extension)){let r=e.vault.getResourcePath(o);t.push(r)}}return t}async function ge(n,a){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=a.metadataCache.getFileCache(n);if(!(s!=null&&s.embeds))return[];let t=[],i=[];for(let c of s.embeds){let p=c.link;if(Ae(p))(ue(p)||!p.includes("."))&&i.push(p);else{let u=a.metadataCache.getFirstLinkpathDest(p,n.path);if(u&&e.includes(u.extension)){let h=a.vault.getResourcePath(u);t.push(h)}}}let o=i.map(c=>Me(c).then(p=>p?c:null)),l=(await Promise.all(o)).filter(c=>c!==null);return[...t,...l]}var st=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function it(n){let a=new Map,e=0;return{text:n.replace(/\\(.)/g,(t,i)=>{let o=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return a.set(o,i),e++,o}),map:a}}function at(n,a){let e=n;return a.forEach((s,t)=>{e=e.split(t).join(s)}),e}function nt(n){let a=n,e=!0;for(;e;){e=!1;let s=a.match(/^([`~]{3,})/m);if(!s)break;let t=s[1][0],i=s[1].length,o=s.index,r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`^${r}{${i}}\\s*$`,"m"),p=a.substring(o+s[1].length).match(l);if(p){let h=o+s[1].length+p.index+p[0].length;a=a.substring(0,o)+a.substring(h),e=!0}else{let u=a.indexOf(`
`,o);u===-1?a=a.substring(0,o):a=a.substring(0,o)+a.substring(u+1),e=!0}}return a}function ot(n){if(!n||n.trim().length===0)return"";n=n.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),n=n.replace(/^>\s?/gm,"");let{text:a,map:e}=it(n),s=nt(a);return st.forEach(t=>{s=s.replace(t,(i,...o)=>{if(i.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return o[1]||"";if(o.length>0&&o[0]!==void 0){for(let r=0;r<o.length-2;r++)if(typeof o[r]=="string")return o[r]}return""})}),s=at(s,e),s}function rt(n,a=!1,e,s){let t=n.replace(/^---[\s\S]*?---/,"").trim(),i=ot(t),o=i.indexOf(`
`),r=(o!==-1?i.substring(0,o):i).trim();(a||e&&r===e||s&&r===s)&&(i=o!==-1?i.substring(o+1).trim():"");let l=i.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(u=>u).join(" ").trim().replace(/\.{2,}/g,u=>u.replace(/\./g,"\u2024")),c=l.length>500,p=l.substring(0,500);return c&&(p+="\u2026"),p}async function Ie(n,a,e,s,t,i){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(s.fallbackToContent){let r=await a.vault.cachedRead(n);return rt(r,s.omitFirstLine,t,i)}return""}async function lt(n,a,e,s,t,i,o){if(!(n in i))try{let{internalPaths:r,externalUrls:l}=await Be(s),c=[...Le(r,n,e),...l];c.length===0&&t&&(c=await ge(a,e)),c.length>0&&(i[n]=c.length>1?c:c[0],o[n]=!0)}catch(r){console.error(`Failed to load image for ${n}:`,r)}}async function me(n,a,e,s,t){let i=n.filter(r=>!(r.path in s)),o=50;for(let r=0;r<i.length;r+=o){let l=i.slice(r,r+o);await Promise.all(l.map(async c=>{await lt(c.path,c.file,e,c.imagePropertyValues,a,s,t)}))}}async function Oe(n,a,e,s){await Promise.all(n.map(async t=>{if(!(t.path in e||s[t.path]))try{let i=await ge(t.file,a);i.length>0&&(e[t.path]=i.length>1?i:i[0],s[t.path]=!0)}catch(i){console.error(`Failed to load embed images for ${t.path}:`,i)}}))}async function Ne(n,a,e,s,t){await Promise.all(n.map(async i=>{if(!(i.path in t))try{i.file.extension==="md"?t[i.path]=await Ie(i.file,s,i.descriptionData,{fallbackToContent:a,omitFirstLine:e},i.fileName,i.titleString):t[i.path]=""}catch(o){console.error(`Failed to load snippet for ${i.path}:`,o),t[i.path]=""}}))}var Q=require("obsidian");function ct(n,a){let e=null,s=!1;if(a.draftStatusUseFilenamePrefix&&n.file&&n.file.name)e=n.file.name.startsWith("_"),s=a.draftStatusReverse?!e:e;else if(a.draftStatusProperty){let t=M(n,a.draftStatusProperty);if(t){let i=t;i&&"data"in i&&typeof i.data=="boolean"&&(e=i.data,s=a.draftStatusReverse?!e:e)}}return{booleanValue:e,isDraft:s}}function X(n,a,e,s,t){if(!s.showDraftStatus)return;let{booleanValue:i,isDraft:o}=ct(a,s);if(i!==null){let r=n.createDiv("card-status-badge");o?(r.addClass("status-draft"),r.appendText("Draft")):(r.addClass("status-published"),r.appendText("Published")),t&&(r.addClass("bases-cms-cursor-pointer"),r.addEventListener("click",l=>{l.stopPropagation(),t(e,"draft",!i)}))}}var Y=require("obsidian");function Ve(n,a,e,s,t,i){if(!a.settings.enableQuickEdit||!a.settings.quickEditCommand||a.settings.quickEditCommand===""||i.hideQuickEditIcon)return;let o=e.createSpan("bases-cms-quick-edit-icon");o.addClass("bases-cms-cursor-default"),(0,Y.setIcon)(o,"pencil-line"),e.addEventListener("click",r=>{o.contains(r.target)&&(r.stopPropagation(),r.stopImmediatePropagation())},!0),s.addEventListener("click",r=>{(async()=>{var p,u,h,d,b;let l=r.target;if(!o.contains(l)&&!l.closest(".bases-cms-quick-edit-icon"))return;r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault();let c=n.vault.getAbstractFileByPath(t);if(c instanceof Y.TFile){let g=a.settings.quickEditCommand,E=!1;try{let y=null,S=g;if(g.includes(":")){let w=g.split(":");y=w[0],S=w.slice(1).join(":")}else{let T=n.commands,k=(p=T==null?void 0:T.commands)==null?void 0:p[g];if(k){let P=k.plugin||k.sourcePlugin;P&&(y=((u=P.manifest)==null?void 0:u.id)||P.pluginId||null)}}if(y){let w=n.plugins,T=(h=w==null?void 0:w.plugins)==null?void 0:h[y];if(T){let k=S.split("-").map((P,x)=>x===0?P:P.charAt(0).toUpperCase()+P.slice(1)).join("")+"ByPath";if(T&&typeof T[k]=="function"){await T[k](t),E=!0;return}}}}catch(y){}if(!E)try{await((b=(d=n.commands)==null?void 0:d.executeCommandById)==null?void 0:b.call(d,a.settings.quickEditCommand));return}catch(y){let S=n.workspace.getLeaf(!1);await S.openFile(c);let w=()=>{let T=S.view,k=T;T&&"editor"in T&&k.editor?setTimeout(()=>{(async()=>{var P,x;try{await((x=(P=n.commands)==null?void 0:P.executeCommandById)==null?void 0:x.call(P,a.settings.quickEditCommand))}catch(m){}})()},100):setTimeout(w,50)};w()}}})()},!0),o.addEventListener("mousedown",r=>{r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault()},!0)}var ee=class{constructor(a,e,s,t,i,o){this.app=a;this.plugin=e;this.propertyObservers=s;this.updateLayoutRef=t;this.basesConfig=i,this.basesController=o}renderCard(a,e,s,t,i,o,r,l){let c=a.createDiv("card bases-cms-card");t.imageFormat==="cover"?c.classList.add("image-format-cover"):t.imageFormat==="thumbnail"&&c.classList.add("image-format-thumbnail"),c.setAttribute("data-path",e.path),c.setAttribute("data-href",e.path),c.addClass("bases-cms-cursor-pointer");let p=c.createDiv("bases-cms-select-checkbox"),u=p.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(u.checked=o,u.addEventListener("change",h=>{h.stopPropagation(),h.stopImmediatePropagation(),r(e.path,u.checked)}),u.addEventListener("click",h=>{h.stopPropagation(),h.stopImmediatePropagation()}),t.showDraftStatus&&t.imageFormat!=="cover"&&X(c,s,e.path,t,l),c.addEventListener("click",h=>{let d=h.target;if(d.closest(".bases-cms-quick-edit-icon")){h.stopPropagation(),h.stopImmediatePropagation(),h.preventDefault();return}if(p.contains(d)||d.tagName==="INPUT"||d.closest("input")||d.closest(".bases-cms-property")||d.closest(".card-status-badge"))return;let g=h.metaKey||h.ctrlKey;this.app.workspace.openLinkText(e.path,"",g)}),c.addEventListener("contextmenu",h=>{let d=h.target;if(p.contains(d)||d.tagName==="INPUT"||d.closest("input")||d.closest(".bases-cms-property")||d.closest(".card-status-badge")||d.closest(".bases-cms-quick-edit-icon"))return;let b=this.app.vault.getAbstractFileByPath(e.path);if(b&&b instanceof Q.TFile){h.stopPropagation();let g=new Q.Menu;this.app.workspace.trigger("file-menu",g,b,"bases"),g.showAtMouseEvent(h)}}),t.showTitle){let h=c.createDiv("card-title");h.appendText(e.title),Ve(this.app,this.plugin,h,c,e.path,t)}if(t.showDate&&t.dateProperty){let h=M(s,t.dateProperty);if(h){let d=h,b="";if(d&&"date"in d&&d.date instanceof Date)b=d.date.toLocaleDateString();else if(d&&"data"in d&&d.data){let g=d.data;if(g instanceof Date)b=g.toLocaleDateString();else if(typeof g=="string"||typeof g=="number"){let E=new Date(g);isNaN(E.getTime())?b=String(g):b=E.toLocaleDateString()}}b&&c.createDiv("card-date").appendText(b)}}if(t.showTextPreview||t.showTags&&e.displayTags&&e.displayTags.length>0||t.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||t.imageFormat==="cover"){let h=c.createDiv("card-content");if(t.imageFormat==="thumbnail"){let d=h.createDiv("card-text-wrapper");if(t.showTextPreview){let b=d.createDiv("card-text-preview");e.snippet&&b.setText(e.snippet),c.__textPreviewEl=b,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let b=d.createDiv("card-tags"),g=t.maxTagsToShow,E=e.displayTags.slice(0,g),y=e.displayTags.length-g;E.forEach(S=>{b.createSpan("card-tag").appendText(S)}),y>0&&b.createSpan("card-tag-more").appendText(`+${y} more`)}}else{if(t.showTextPreview){let d=h.createDiv("card-text-preview");e.snippet&&d.setText(e.snippet),c.__textPreviewEl=d,c.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let d=h.createDiv("card-tags"),b=t.maxTagsToShow,g=e.displayTags.slice(0,b),E=e.displayTags.length-b;g.forEach(y=>{d.createSpan("card-tag").appendText(y)}),E>0&&d.createSpan("card-tag-more").appendText(`+${E} more`)}}if(t.imageFormat!=="none"&&e.imageUrl){let b=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(y=>y&&typeof y=="string"&&y.trim().length>0),g=t.imageFormat==="cover"?"card-cover":"card-thumbnail",E=h.createDiv(g);if(b.length>0){let y=E.createDiv("image-embed"),S=y.createEl("img",{attr:{alt:"",decoding:"async",sizes:t.imageFormat==="cover"?"100vw":"80px"}});return y.style.setProperty("--cover-image-url",`url("${b[0]}")`),t.showDraftStatus&&t.imageFormat==="cover"&&X(E,s,e.path,t,l),this.renderProperties(c,e,s,t,l),{img:S,src:b[0]}}}else if(t.imageFormat==="cover"){let d=h.createDiv("card-cover-placeholder");X(d,s,e.path,t,l)}}return this.renderProperties(c,e,s,t,l),null}renderProperties(a,e,s,t,i){let o=[t.propertyDisplay1,t.propertyDisplay2,t.propertyDisplay3,t.propertyDisplay4],r=new Set,l=o.map(d=>!d||d===""||r.has(d)?"":(r.add(d),d)),c=l.map(d=>d?z(d,s,e,t):null),p=l[0]!==""||l[1]!=="",u=l[2]!==""||l[3]!=="";if(!p&&!u)return;let h=a.createDiv("card-properties properties-4field");if(p){let d=h.createDiv("property-row property-row-1");t.propertyLayout12SideBySide&&d.addClass("property-row-side-by-side");let b=d.createDiv("property-field property-field-1");l[0]&&this.renderPropertyContent(b,l[0],c[0],e,s,t,i);let g=d.createDiv("property-field property-field-2");l[1]&&this.renderPropertyContent(g,l[1],c[1],e,s,t,i)}if(u){let d=h.createDiv("property-row property-row-2");t.propertyLayout34SideBySide&&d.addClass("property-row-side-by-side");let b=d.createDiv("property-field property-field-3");l[2]&&this.renderPropertyContent(b,l[2],c[2],e,s,t,i);let g=d.createDiv("property-field property-field-4");l[3]&&this.renderPropertyContent(g,l[3],c[3],e,s,t,i)}}renderPropertyContent(a,e,s,t,i,o,r){if(e===""||!s&&o.propertyLabels==="hide"||o.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&t.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&t.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&t.folderPath.length===0))return;let l=xe(e,this.app,this.basesConfig,this.basesController),c=l.toLowerCase()!==e.toLowerCase();if(o.propertyLabels==="above"){let h=a.createDiv("property-label");c&&h.addClass("property-label-custom"),h.textContent=l}let p=a.createDiv("property-content");if(o.propertyLabels==="inline"){let h=p.createSpan("property-label-inline");h.textContent=l+": "}if(!s){p.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")p.createSpan().appendText(s);else if((e==="tags"||e==="note.tags")&&t.yamlTags.length>0){let h=p.createDiv("tags-wrapper");t.yamlTags.forEach(d=>{h.createEl("a",{cls:"tag",text:d,href:"#"}).addEventListener("click",g=>{var y,S,w;g.preventDefault();let E=(S=(y=this.app.internalPlugins)==null?void 0:y.plugins)==null?void 0:S["global-search"];(w=E==null?void 0:E.instance)!=null&&w.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+d)})})}else if((e==="file.tags"||e==="file tags")&&t.tags.length>0){let h=p.createDiv("tags-wrapper");t.tags.forEach(d=>{h.createEl("a",{cls:"tag",text:d,href:"#"}).addEventListener("click",g=>{var y,S,w;g.preventDefault();let E=(S=(y=this.app.internalPlugins)==null?void 0:y.plugins)==null?void 0:S["global-search"];(w=E==null?void 0:E.instance)!=null&&w.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+d)})})}else if((e==="file.path"||e==="path"||e==="file path")&&t.path.length>0){let h=p.createDiv("path-wrapper"),d=t.path.split("/").filter(b=>b);d.forEach((b,g)=>{let E=h.createSpan(),y=g===d.length-1,S=y?"path-segment filename-segment":"path-segment file-path-segment";E.createSpan({cls:S,text:b}).addEventListener("click",T=>{if(T.stopPropagation(),y){let k=this.app.vault.getAbstractFileByPath(t.path);k instanceof Q.TFile&&this.app.workspace.getLeaf(!1).openFile(k)}}),g<d.length-1&&E.createSpan({cls:"path-separator",text:"/"})})}else{let h=this.app.metadataCache,b=(typeof h.getAllPropertyInfos=="function"?h.getAllPropertyInfos():{})[e.toLowerCase()],g=i.getValue(e);if(((b==null?void 0:b.widget)==="checkbox"||g&&"data"in g&&typeof g.data=="boolean")&&r){let y=p.createEl("input",{type:"checkbox",cls:"checkbox-input"});y.checked=g&&"data"in g?Boolean(g.data):!1;let S=e.startsWith("note.")?e.substring(5):e;p.createSpan({cls:"checkbox-label",text:S}),y.addEventListener("click",w=>{w.stopPropagation()}),y.addEventListener("change",w=>{w.stopPropagation(),(async()=>{try{let T=e.startsWith("note.")?e.substring(5):e;await r(t.path,T,y.checked)}catch(T){console.error("Error toggling property:",T),y.checked=!y.checked}})()})}else p.createDiv("text-wrapper").appendText(s)}(!p.textContent||p.textContent.trim().length===0)&&p.remove()}};var qe=require("obsidian");var V=require("obsidian");async function fe(n,a,e,s){await n.fileManager.processFrontMatter(a,t=>{for(let[i,o]of e){if(i==="tags"&&!Object.prototype.hasOwnProperty.call(t,"tags")&&!Array.isArray(o.data)){t[i]=[o.data];continue}if(!t[i]||s){t[i]=o.data;continue}let r=o.type,l=t[i],c=Array.isArray(l)?"list":typeof l=="number"?"number":typeof l=="boolean"?"checkbox":"text";if(pt(r,c)){if(t[i]===o.data||!o.data)continue;let p=dt(t[i],o.data);t[i]=p;continue}else{t[i]=o.data;continue}}})}async function Re(n,a,e){await n.fileManager.processFrontMatter(a,s=>{for(let t of e)s[t]=void 0})}function pt(n,a){let e=["number","date","datetime","checkbox"];return!(e.includes(n)||e.includes(a))}function dt(...n){let e=n.map(t=>Array.isArray(t)?t:[t]).flat();return[...new Set(e)]}var L=class{constructor(a){this.app=a}async setDraft(a,e,s){await this.batchProcessFiles(a,async t=>{if(s)if(s.draftStatusUseFilenamePrefix){let i=t.basename,o=i.startsWith("_"),l=t.path.split("/"),c=e;if(s.draftStatusReverse&&(c=!e),c===!0){if(!o){let p=`_${i}${t.extension?`.${t.extension}`:""}`;l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else if(o){let p=i.substring(1)+(t.extension?`.${t.extension}`:"");l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(t,u)}}else{let i=s.draftStatusProperty&&s.draftStatusProperty.trim()?s.draftStatusProperty.startsWith("note.")?s.draftStatusProperty.substring(5):s.draftStatusProperty:"draft",o=e;s.draftStatusReverse&&(o=!e),await this.app.fileManager.processFrontMatter(t,r=>{r[i]=o})}else await this.app.fileManager.processFrontMatter(t,i=>{i.draft=e})}),new V.Notice(`Set ${a.length} file${a.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(a,e){let s=new Map;s.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(a,async t=>{await fe(this.app,t,s,!1)}),new V.Notice(`Added tags to ${a.length} file${a.length!==1?"s":""}`)}async removeTags(a,e){await this.batchProcessFiles(a,async s=>{let t=this.app.metadataCache.getFileCache(s),i=t==null?void 0:t.frontmatter;if(i!=null&&i.tags){let r=(Array.isArray(i.tags)?i.tags:[i.tags]).filter(l=>!e.includes(l));await this.app.fileManager.processFrontMatter(s,l=>{r.length>0?l.tags=r:l.tags=void 0})}}),new V.Notice(`Removed tags from ${a.length} file${a.length!==1?"s":""}`)}async setProperty(a,e,s,t="text"){let i=e.startsWith("note.")?e.substring(5):e,o=new Map;o.set(i,{type:t,data:s,overwrite:!0,delimiter:","}),await this.batchProcessFiles(a,async r=>{await fe(this.app,r,o,!0)}),new V.Notice(`Set ${i} on ${a.length} file${a.length!==1?"s":""}`)}async removeProperty(a,e){let s=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(a,async t=>{await Re(this.app,t,[s])}),new V.Notice(`Removed ${s} from ${a.length} file${a.length!==1?"s":""}`)}async batchProcessFiles(a,e){let s=0,t=a.length;for(let i of a){let o=this.app.vault.getAbstractFileByPath(i);if(o instanceof V.TFile)try{await e(o),s++}catch(r){console.error(`Error processing ${i}:`,r)}}s<t&&new V.Notice(`Processed ${s} of ${t} files`)}};var R=require("obsidian");var te=class extends R.Modal{constructor(e,s){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new R.Setting(e).setName("Manage tags").setHeading(),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new R.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated).").addText(l=>{l.setPlaceholder("tag1, tag2, tag3").onChange(c=>{this.tagsToAdd=c})}),e.createEl("h3",{text:"Remove tags"});let s=e.createDiv(),t=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof R.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;u!=null&&u.tags&&(Array.isArray(u.tags)?u.tags:[u.tags]).forEach(d=>t.add(d))}}for(let l of Array.from(t).sort())new R.Setting(s).setName(l).addToggle(c=>{c.setValue(this.tagsToRemove.has(l)).onChange(p=>{p?this.tagsToRemove.add(l):this.tagsToRemove.delete(l)})});let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let o=i.createEl("button");o.setText("Cancel"),o.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>(await this.applyChanges(),this.close()))()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(s=>s.trim()).filter(s=>s.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var U=require("obsidian");var se=class extends U.Modal{constructor(e,s){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new U.Setting(e).setName("Set property").setHeading(),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new U.Setting(e).setName("Property name").setDesc("Enter the property name to set.").addText(o=>{o.setPlaceholder("Enter name").onChange(r=>{this.propertyName=r})}),new U.Setting(e).setName("Property type").setDesc("Select the property type.").addDropdown(o=>{o.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(r=>{this.propertyType=r})}),new U.Setting(e).setName("Property value").setDesc("Enter the property value.").addText(o=>{o.setPlaceholder("Enter value").onChange(r=>{this.propertyValue=r})});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let i=s.createEl("button");i.setText("Apply"),i.addClass("mod-cta"),i.addEventListener("click",()=>{(async()=>this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close()))()})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var H=require("obsidian");var ie=class extends H.Modal{constructor(e,s){super(e);this.propertiesToRemove=new Set;this.files=s,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new H.Setting(e).setName("Remove property").setHeading(),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let s=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof H.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;if(u)for(let h in u)h!=="tags"&&h!=="title"&&s.add(h)}}let t=e.createDiv();for(let l of Array.from(s).sort())new H.Setting(t).setName(l).addToggle(c=>{c.setValue(this.propertiesToRemove.has(l)).onChange(p=>{p?this.propertiesToRemove.add(l):this.propertiesToRemove.delete(l)})});s.size===0&&e.createEl("p",{text:"No properties found in selected files."});let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let o=i.createEl("button");o.setText("Cancel"),o.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close()))()})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var oe=require("obsidian");var $=require("obsidian");var q=require("obsidian");function $e(n,a){let e=[],s=n.vault.getAbstractFileByPath(a.path);if(s instanceof q.TFile){let t=n.metadataCache.getFileCache(s),i=(t==null?void 0:t.embeds)||[];for(let o of i){let r=n.metadataCache.getFirstLinkpathDest(o.link,a.path);r instanceof q.TFile&&e.push(r)}}return e}function _e(n,a){let e=[];for(let s of a.children)s instanceof q.TFile&&s.extension==="md"?e.push(...$e(n,s)):s instanceof q.TFolder&&e.push(..._e(n,s));return e}async function ht(n,a,e,s){let t=n.vault.getMarkdownFiles().filter(l=>l.path!==e.path),i=a.path,o=a.name,r=a.basename;for(let l of t){if(s&&l.path.startsWith(s.path+"/"))continue;let c=await n.vault.read(l);if(c.includes(i)||c.includes(o)||c.includes(r)||c.includes(`![[${o}]]`)||c.includes(`[[${o}]]`)||c.includes(`(${o})`)||c.includes(`(${i})`))return!0}return!1}async function Ue(n,a,e){let s=[];s.push(...$e(n,a)),e&&s.push(..._e(n,e));let t=Array.from(new Set(s.map(o=>o.path))).map(o=>n.vault.getAbstractFileByPath(o)).filter(o=>o instanceof q.TFile),i=[];for(let o of t)await ht(n,o,a,e)||i.push(o);return i}function ut(n,a){let e=a.deleteParentFolderFilename||"index";return n.basename===e&&n.parent!==null}function He(n,a){return a.deleteParentFolder&&ut(n,a)}async function be(n,a,e){let s=[],t=[],i=[];for(let l of a){let c=n.vault.getAbstractFileByPath(l);if(c instanceof $.TFile){if(He(c,e)){let p=c.parent;if(p&&!t.includes(p)){t.push(p);let u=p.children.filter(h=>h instanceof $.TFile);s.push(...u)}}else s.push(c);if(e.deleteUniqueAttachments){let p=He(c,e)&&c.parent||void 0,u=await Ue(n,c,p);i.push(...u)}}}let o=Array.from(new Set(s.map(l=>l.path))).map(l=>n.vault.getAbstractFileByPath(l)).filter(l=>l instanceof $.TFile),r=Array.from(new Set(i.map(l=>l.path))).map(l=>n.vault.getAbstractFileByPath(l)).filter(l=>l instanceof $.TFile);return{filesToDelete:o,foldersToDelete:Array.from(new Set(t)),attachmentsToDelete:r}}async function ae(n,a){let e=0,s=0;for(let t of a.filesToDelete)try{await n.fileManager.trashFile(t),e++}catch(i){console.error(`Error deleting file ${t.path}:`,i),s++}for(let t of a.attachmentsToDelete)try{await n.fileManager.trashFile(t),e++}catch(i){console.error(`Error deleting attachment ${t.path}:`,i),s++}for(let t of a.foldersToDelete)try{await n.fileManager.trashFile(t),e++}catch(i){console.error(`Error deleting folder ${t.path}:`,i),s++}s>0?new $.Notice(`Deleted ${e} items, ${s} errors occurred`):new $.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var ne=class extends oe.Modal{constructor(e,s,t){super(e);this.preview=s,this.onConfirm=t}onOpen(){let{contentEl:e}=this;if(e.empty(),new oe.Setting(e).setName("Confirm deletion").setHeading(),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let o=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.filesToDelete.slice(0,20))o.createEl("li").setText(r.path);this.preview.filesToDelete.length>20&&o.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let o=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.foldersToDelete)o.createEl("li").setText(r.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let o=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.attachmentsToDelete.slice(0,20))o.createEl("li").setText(r.path);this.preview.attachmentsToDelete.length>20&&o.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"This action cannot be undone.",cls:"bases-cms-deletion-warning"});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let i=s.createEl("button");i.setText("Delete"),i.addClass("mod-cta"),i.addClass("destructive"),i.addEventListener("click",()=>{(async()=>(await ae(this.app,this.preview),this.onConfirm(),this.close()))()})}onClose(){let{contentEl:e}=this;e.empty()}};var re=require("obsidian"),G=class extends re.Modal{constructor(e,s,t,i){super(e);this.files=s,this.operation=t,this.onConfirm=i}onOpen(){let{contentEl:e}=this;e.empty();let s=this.operation==="draft"?"mark as draft":"mark as published",t=s.charAt(0).toUpperCase()+s.slice(1);if(new re.Setting(e).setName(`Confirm ${t}`).setHeading(),e.createEl("p",{text:`Are you sure you want to ${s} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let l=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let c of this.files.slice(0,20))l.createEl("li").setText(c);this.files.length>20&&l.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let o=i.createEl("button");o.setText("Cancel"),o.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Confirm"),r.addClass("mod-cta"),r.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var le=class{constructor(a,e,s,t,i,o,r,l){this.app=a;this.plugin=e;this.container=s;this.getSelectedFiles=t;this.clearSelection=i;this.refreshView=o;this.toolbarEl=null;this.countEl=null;this.resizeObserver=null;this.bulkOps=new L(a),this.selectAllCallback=r,this.settings=l,this.createToolbar()}updateSettings(a){this.settings=a}createToolbar(){this.toolbarEl=document.createElement("div"),this.toolbarEl.className="bases-toolbar bases-cms-bulk-toolbar bases-cms-bulk-toolbar-hidden",this.toolbarEl.__bulkToolbarInstance=this,this.createToolbarContent(),this.positionToolbar(),setTimeout(()=>this.positionToolbar(),100)}positionToolbar(){if(!this.toolbarEl)return;let a=this.container.closest(".bases-header");if(!a){let s=this.container.parentElement;for(;s&&!a;){if(s.classList.contains("bases-header")){a=s;break}s=s.parentElement}}if(!a){let s=Array.from(document.querySelectorAll(".bases-header"));for(let t of s)if(t.contains(this.container)){a=t;break}}let e=this.container.closest(".view-content");if(e)this.toolbarEl.parentElement!==e?(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container)):this.toolbarEl.nextSibling!==this.container&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container));else if(a&&a.parentElement)this.toolbarEl.parentElement!==a.parentElement&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),a.parentElement.insertBefore(this.toolbarEl,a.nextSibling));else{let s=this.container.parentElement;s&&(this.toolbarEl.parentElement!==s||this.toolbarEl.nextSibling!==this.container)&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),s.insertBefore(this.toolbarEl,this.container))}}createToolbarContent(){if(!this.toolbarEl)return;let a=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-left"),e=(i,o,r,l,c=!1)=>{let u=l.createDiv("bases-toolbar-item").createDiv("text-icon-button");c&&u.addClass("destructive"),u.setAttribute("tabindex","0");let h=u.createSpan("text-button-icon");return(0,qe.setIcon)(h,i),u.createSpan("text-button-label").setText(o),u.addEventListener("click",r),u};this.plugin.settings.showToolbarSelectAll&&e("copy-check","Select all",()=>this.handleSelectAll(),a),this.plugin.settings.showToolbarClear&&e("square-x","Clear",()=>this.clearSelection(),a);let s=a.createDiv("bases-toolbar-item bases-cms-selected-count");this.countEl=s.createSpan("text-button-label"),this.countEl.setText("0 items selected");let t=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-right");this.plugin.settings.showToolbarPublish&&e("book-check","Publish",()=>{this.handlePublish()},t),this.plugin.settings.showToolbarDraft&&e("book-dashed","Draft",()=>{this.handleSetDraft()},t),this.plugin.settings.showToolbarTags&&e("tags","Tags",()=>this.handleManageTags(),t),this.plugin.settings.showToolbarSet&&e("list-check","Set",()=>this.handleSetProperty(),t),this.plugin.settings.showToolbarRemove&&e("list-x","Remove",()=>this.handleRemoveProperty(),t),this.plugin.settings.showToolbarDelete&&e("trash-2","Delete",()=>{this.handleDelete()},t,!0),this.setupResponsiveBehavior()}setupResponsiveBehavior(){if(!this.toolbarEl)return;setTimeout(()=>{this.updateCollapsedState()},100),this.toolbarEl&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCollapsedState()}),this.resizeObserver.observe(this.toolbarEl));let a=this.container;if(a){let e=new ResizeObserver(()=>{setTimeout(()=>{this.updateCollapsedState()},10)});e.observe(a),this.containerObserver=e}}updateCollapsedState(){if(!this.toolbarEl)return;this.toolbarEl.offsetWidth<680?this.toolbarEl.addClass("collapsed"):this.toolbarEl.removeClass("collapsed")}updateCount(a){this.countEl&&this.countEl.setText(`${a} item${a!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){this.toolbarEl||(console.warn("[Bases CMS] Toolbar element not found, recreating..."),this.createToolbar()),this.toolbarEl?(this.positionToolbar(),this.toolbarEl.parentElement||(console.warn("[Bases CMS] Toolbar not in DOM, repositioning..."),this.positionToolbar()),this.toolbarEl.removeClass("bases-cms-bulk-toolbar-hidden"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.offsetHeight,setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-out"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-in"))},10)):console.error("[Bases CMS] Failed to show toolbar - element is null")}hide(){this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-in"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-out"),setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-hidden"))},200))}async handleSetDraft(){let a=this.getSelectedFiles();a.length!==0&&(this.plugin.settings.confirmBulkOperations?new G(this.app,a,"draft",()=>{(async()=>(await this.bulkOps.setDraft(a,!0,this.settings),this.refreshView()))()}).open():(await this.bulkOps.setDraft(a,!0,this.settings),this.refreshView()))}async handlePublish(){let a=this.getSelectedFiles();a.length!==0&&(this.plugin.settings.confirmBulkOperations?new G(this.app,a,"publish",()=>{(async()=>(await this.bulkOps.setDraft(a,!1,this.settings),this.refreshView()))()}).open():(await this.bulkOps.setDraft(a,!1,this.settings),this.refreshView()))}handleManageTags(){let a=this.getSelectedFiles();if(a.length===0)return;let e=new te(this.app,a);e.onClose=()=>{this.show(),this.refreshView()},e.open()}handleSetProperty(){let a=this.getSelectedFiles();if(a.length===0)return;let e=new se(this.app,a);e.onClose=()=>{this.show(),this.refreshView()},e.open()}handleRemoveProperty(){let a=this.getSelectedFiles();if(a.length===0)return;let e=new ie(this.app,a);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleDelete(){let a=this.getSelectedFiles();if(a.length!==0)if(this.plugin.settings.confirmDeletions){let e=await be(this.app,a,this.plugin.settings);new ne(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await be(this.app,a,this.plugin.settings);await ae(this.app,e),this.clearSelection(),this.refreshView()}}recreate(){let a=this.toolbarEl&&!this.toolbarEl.hasClass("bases-cms-bulk-toolbar-hidden"),e=0;if(this.countEl&&this.countEl.textContent){let s=this.countEl.textContent.match(/\d+/);s&&(e=parseInt(s[0],10))}this.destroy(),this.createToolbar(),a&&this.toolbarEl&&e>0&&(this.updateCount(e),this.show())}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);let a=this.containerObserver;a&&(a.disconnect(),this.containerObserver=void 0),this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};K();function ze(n,a,e,s,t){let i=l=>{var E;let c=l.target,p=c.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!p||c.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let u=n.workspace.activeLeaf,h=u==null?void 0:u.view,d=h?h.containerEl:null;if(!(h&&d&&(d===a||((E=p.closest(".workspace-leaf"))==null?void 0:E.contains(d)))))return;let g=B(e,s);g.customizeNewButton&&(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),(async()=>{var T;let y=((T=g.newNoteLocation)==null?void 0:T.trim())||"";if(y===""){let k=n.vault.config,P=(k==null?void 0:k.newFileLocation)||"folder",x=(k==null?void 0:k.newFileFolderPath)||"";console.debug("[CMS View] Obsidian config:",{newFileLocation:P,newFileFolderPath:x});let m="Untitled.md";if(P==="folder"&&x)m=`${x}/Untitled.md`;else if(P==="current"){let f=n.workspace.getActiveFile();f&&f.parent&&(m=`${f.parent.path}/Untitled.md`)}else P==="root"&&(m="Untitled.md");console.debug("[CMS View] Creating file at:",m);let v=await n.vault.create(m,"");await n.workspace.openLinkText(v.path,"",!1);return}if(y==="/"||y.replace(/\//g,"")===""){let k=await n.vault.create("Untitled.md","");await n.workspace.openLinkText(k.path,"",!1);return}let S=y.replace(/^\/+|\/+$/g,""),w=n.vault.getAbstractFileByPath(S);if((!w||!("children"in w))&&(await n.vault.createFolder(S),w=n.vault.getAbstractFileByPath(S)),w&&"children"in w){let k=await n.vault.create(`${S}/Untitled.md`,"");await n.workspace.openLinkText(k.path,"",!1)}})())};document.addEventListener("click",i,!0);let o=new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(c=>{let p=c;p.__cmsIntercepted||(p.__cmsIntercepted=!0,c.addEventListener("click",i,!0))})});o.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(l=>{let c=l;c.__cmsIntercepted||(c.__cmsIntercepted=!0,l.addEventListener("click",i,!0))}),t(()=>{document.removeEventListener("click",i,!0),o.disconnect()})}var ye="bases-cms",ce=class extends W.BasesView{constructor(e,s,t){var o;super(e);this.type=ye;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.displayedCount=50;this.isLoading=!1;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.currentBaseIdentifier=null;this.backupInterval=null;this.containerEl=s,this.plugin=t,this.cardRenderer=new ee(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container");let i=(o=this.app.isMobile)!=null?o:!1;this.displayedCount=i?25:50,ze(this.app,this.containerEl,this.config,this.plugin.settings,r=>this.register(r)),this.setupViewSwitchListener()}setupViewSwitchListener(){let e=null,s=()=>{e||(e=new MutationObserver(l=>{if(this.selectedFiles.size!==0){for(let c of l)if(c.type==="childList"&&c.removedNodes.length>0){let p=!1;for(let h of this.selectedFiles)if(this.containerEl.querySelector(`[data-path="${h}"]`)){p=!0;break}let u=this.containerEl.querySelectorAll(".card[data-path]");if(!p||u.length===0){this.selectedFiles.clear(),this.updateSelectionUI();break}}}}),this.containerEl&&e.observe(this.containerEl,{childList:!0,subtree:!0}))},t=()=>{if(e){e.disconnect(),e=null,this.selectedFiles.size>0&&this.selectedFiles.clear(),this.updateSelectionUI(),this.bulkToolbar&&this.bulkToolbar.hide();let l=this.containerEl.querySelector(".bases-cms-bulk-toolbar");l instanceof HTMLElement&&(l.removeClass("bases-cms-bulk-toolbar-visible"),l.addClass("bases-cms-bulk-toolbar-hidden"))}},i=()=>{try{let l=this.config;if(l!=null&&l.getName)return l.getName();if(l!=null&&l.name)return String(l.name);let c=this;if(c.controller){let p=c.controller;if(p!=null&&p.getBaseName)return p.getBaseName();if(p!=null&&p.baseName)return String(p.baseName)}if(this.data){let p=this.data;if(p.baseName)return String(p.baseName)}}catch(l){}return null},o=()=>{if(this.selectedFiles.size===0){this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}let l=i();if(this.currentBaseIdentifier!==null&&l!==null&&this.currentBaseIdentifier!==l){this.selectedFiles.clear(),this.updateSelectionUI(),t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}this.containerEl.querySelectorAll(".card[data-path]").length===0&&(this.selectedFiles.clear(),this.updateSelectionUI())},r=this.handleSelectionChange.bind(this);this.handleSelectionChange=(l,c)=>{if(r(l,c),this.selectedFiles.size>0)this.currentBaseIdentifier===null&&(this.currentBaseIdentifier=i()),s(),this.backupInterval===null&&(this.backupInterval=this.plugin.registerInterval(window.setInterval(o,500)));else{this.currentBaseIdentifier=null,t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null),this.bulkToolbar&&this.bulkToolbar.hide();let p=this.containerEl.querySelector(".bases-cms-bulk-toolbar");p instanceof HTMLElement&&(p.removeClass("bases-cms-bulk-toolbar-visible"),p.addClass("bases-cms-bulk-toolbar-hidden"))}},this.register(()=>{t(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)})}onDataUpdated(){let e=this.app.workspace.activeLeaf,s=e==null?void 0:e.view;if(s&&this.selectedFiles.size>0&&s!==this){if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)){this.selectedFiles.clear(),this.updateSelectionUI();return}let o=s.containerEl;if(!o||!o.contains(this.containerEl)){this.selectedFiles.clear(),this.updateSelectionUI();return}}if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)&&this.selectedFiles.size>0){this.selectedFiles.clear(),this.updateSelectionUI();return}(async()=>{var x;let i=this.data.groupedData,o=this.data.data;this.cardRenderer.basesConfig=this.config;let r=B(this.config,this.plugin.settings),l=this.containerEl.clientWidth,c=r.cardSize,p=1,u=8,h=Math.max(p,Math.floor((l+u)/(c+u))),d=(l-u*(h-1))/h;this.containerEl.style.setProperty("--card-min-width",`${d}px`),this.containerEl.style.setProperty("--grid-columns",String(h)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(r.imageAspectRatio));let b=this.containerEl.scrollTop,g=this.getSortMethod(),E=i.map(m=>({group:m,entries:[...m.entries]})),y=[],S=this.displayedCount;for(let m of E){if(S<=0)break;let v=Math.min(m.entries.length,S);y.push(...m.entries.slice(0,v)),S-=v}if(r.imageFormat!=="none"){let m=o.filter(C=>!(C.file.path in this.images)).map(C=>{let D=this.app.vault.getAbstractFileByPath(C.file.path);if(!(D instanceof W.TFile))return null;let A=Pe(C,r.imageProperty);return{path:C.file.path,file:D,imagePropertyValues:A}}).filter(C=>C!==null),v=m.filter(C=>y.some(D=>D.file.path===C.path)),f=m.filter(C=>!y.some(D=>D.file.path===C.path));if(v.length>0&&await me(v,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),f.length>0&&me(f,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),r.fallbackToEmbeds){let C=m.filter(D=>!(D.path in this.images)&&!this.hasImageAvailable[D.path]);C.length>0&&Oe(C,this.app,this.images,this.hasImageAvailable).then(()=>{C.forEach(D=>{var A;if(D.path in this.images){let I=this.containerEl.querySelector(`.card[data-path="${D.path}"]`);if(I){let _=this.images[D.path],O=Array.isArray(_)?_[0]:_;if(O){let j=I.querySelector("img");if(j){if(j.src!==O){j.src=O;let N=j.parentElement;N&&N.classList.contains("image-embed")&&N.style.setProperty("--cover-image-url",`url("${O}")`)}}else{let N=I.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(N){let we=N.querySelector(".card-status-badge"),Qe=N.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",de=(A=N.parentElement)==null?void 0:A.createDiv(Qe);if(de){let Ee=de.createDiv("image-embed");j=Ee.createEl("img",{attr:{src:O,alt:"",decoding:"async"}}),Ee.style.setProperty("--cover-image-url",`url("${O}")`),we&&de.appendChild(we),N.remove()}}}}}}})})}}if(r.showTextPreview){let m=y.filter(v=>!(v.file.path in this.snippets)).map(v=>{let f=this.app.vault.getAbstractFileByPath(v.file.path);if(!(f instanceof W.TFile))return null;let C=M(v,r.descriptionProperty);return{path:v.file.path,file:f,descriptionData:C==null?void 0:C.data}}).filter(v=>v!==null);Ne(m,r.fallbackToContent,!1,this.app,this.snippets).then(()=>{m.forEach(v=>{if(v.path in this.snippets&&this.snippets[v.path]){let f=this.containerEl.querySelector(`[data-path="${v.path}"]`);if(f){let C=f.__textPreviewEl;C&&(!C.textContent||C.textContent.trim().length===0)&&C.setText(this.snippets[v.path])}}})})}let w=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let m=this.containerEl.querySelector(".bases-cms-bulk-toolbar");m instanceof HTMLElement&&(w=m,w.remove())}this.containerEl.empty(),this.propertyObservers.forEach(m=>m.disconnect()),this.propertyObservers=[];let T=this.containerEl.createDiv("bases-cms-grid"),k=0,P=[];for(let m of E){if(k>=this.displayedCount)break;let v=Math.min(m.entries.length,this.displayedCount-k);if(v===0)continue;let f=m.entries.slice(0,v),C=T.createDiv("bases-cms-group");if(m.group.hasKey()){let I=C.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),_=((x=m.group.key)==null?void 0:x.toString())||"";I.setText(_)}let D=De(f,r,g,!1,this.snippets,this.images,this.hasImageAvailable);for(let A=0;A<D.length;A++){let I=D[A],_=f[A],O=this.renderCard(C,I,_,k+A,r);O&&P.push(O)}k+=v}P.length>0&&requestAnimationFrame(()=>{for(let{img:m,src:v}of P)m.src=v}),b>0&&(this.containerEl.scrollTop=b),this.setupInfiniteScroll(o.length),this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>{let m=this.containerEl.clientWidth,v=B(this.config,this.plugin.settings),f=v.cardSize,C=1,D=8,A=Math.max(C,Math.floor((m+D)/(f+D))),I=(m-D*(A-1))/A;this.containerEl.style.setProperty("--card-min-width",`${I}px`),this.containerEl.style.setProperty("--grid-columns",String(A)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(v.imageAspectRatio))}),this.resizeObserver.observe(this.containerEl)),w&&this.bulkToolbar&&(this.containerEl.appendChild(w),this.bulkToolbar.toolbarEl=w),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(v=>{let f=v.getAttribute("data-path"),C=v.querySelector('input[type="checkbox"].selection-checkbox');if(f){let D=this.selectedFiles.has(f);D?v.addClass("selected"):v.removeClass("selected"),C&&(C.checked=D)}}),w&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.isLoading=!1})()}renderCard(e,s,t,i,o){let r=this.selectedFiles.has(s.path);return this.cardRenderer.renderCard(e,s,t,o,this,r,(l,c)=>{this.handleSelectionChange(l,c)},(l,c,p)=>{this.handlePropertyToggle(l,c,p)})}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let s=e[0],t=s.property,i=s.direction.toLowerCase();if(t.includes("ctime"))return`ctime-${i}`;if(t.includes("mtime"))return`mtime-${i}`}return"mtime-desc"}setupInfiniteScroll(e){this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=e)&&(this.scrollListener=()=>{var p;if(this.scrollThrottleTimeout!==null||this.isLoading)return;let s=this.containerEl.scrollTop,t=this.containerEl.scrollHeight,i=this.containerEl.clientHeight,o=t-(s+i),l=((p=this.app.isMobile)!=null?p:!1)?1:2,c=i*l;if(o<c&&this.displayedCount<e){this.isLoading=!0;let u=50;this.displayedCount=Math.min(this.displayedCount+u,e),this.onDataUpdated()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.register(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}handleSelectionChange(e,s){if(s?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI(),this.selectedFiles.size===0&&this.bulkToolbar){this.bulkToolbar.hide();let t=this.containerEl.querySelector(".bases-cms-bulk-toolbar");t instanceof HTMLElement&&(t.removeClass("bases-cms-bulk-toolbar-visible"),t.addClass("bases-cms-bulk-toolbar-hidden"))}}async handlePropertyToggle(e,s,t){try{let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof W.TFile))return;let o=s.startsWith("note.")?s.substring(5):s,r=B(this.config,this.plugin.settings),l=r.showDraftStatus&&o==="draft",c=!1;if(l)if(r.draftStatusUseFilenamePrefix){let p=i.basename,u=p.startsWith("_"),d=i.path.split("/");if(t===!0){if(!u){let b=`_${p}${i.extension?`.${i.extension}`:""}`;d[d.length-1]=b;let g=d.join("/");await this.app.fileManager.renameFile(i,g),c=!0}}else if(u){let b=p.substring(1)+(i.extension?`.${i.extension}`:"");d[d.length-1]=b;let g=d.join("/");await this.app.fileManager.renameFile(i,g),c=!0}}else{let p=r.draftStatusProperty&&r.draftStatusProperty.trim()?r.draftStatusProperty.startsWith("note.")?r.draftStatusProperty.substring(5):r.draftStatusProperty:"draft";await this.app.fileManager.processFrontMatter(i,u=>{u[p]=t}),c=!0}else await this.app.fileManager.processFrontMatter(i,p=>{p[o]=t}),c=!0;c&&requestAnimationFrame(()=>{setTimeout(()=>{try{this.onDataUpdated()}catch(p){console.error("Error refreshing view after property toggle:",p)}},100)})}catch(i){console.error("Error toggling property:",i)}}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(s=>{let t=s.getAttribute("data-path");t&&this.selectedFiles.add(t)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}refreshToolbar(){if(this.bulkToolbar){let e=this.selectedFiles.size;this.bulkToolbar.recreate(),e>0&&this.bulkToolbar.updateCount(e)}}updateSelectionUI(){if(this.containerEl.querySelectorAll(".card").forEach(s=>{let t=s.getAttribute("data-path"),i=s.querySelector('input[type="checkbox"].selection-checkbox');if(t){let o=this.selectedFiles.has(t);o?s.addClass("selected"):s.removeClass("selected"),i&&(i.checked=o)}}),this.selectedFiles.size>0){if(document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>{let i=t.__bulkToolbarInstance;(!i||i!==this.bulkToolbar)&&t.remove()}),this.bulkToolbar){let t=B(this.config,this.plugin.settings);this.bulkToolbar.updateSettings(t)}else{let t=B(this.config,this.plugin.settings);this.bulkToolbar=new le(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let i=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&i.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),setTimeout(()=>{i.forEach(o=>{this.app.vault.getAbstractFileByPath(o)&&this.selectedFiles.add(o)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()},t)}this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()}else if(this.bulkToolbar&&!this.isRefreshingWithSelection){this.bulkToolbar.hide();let s=this.containerEl.querySelector(".bases-cms-bulk-toolbar");s instanceof HTMLElement&&(s.removeClass("bases-cms-bulk-toolbar-visible"),s.addClass("bases-cms-bulk-toolbar-hidden"))}}onClose(){this.resizeObserver&&this.resizeObserver.disconnect(),this.propertyObservers.forEach(t=>t.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy(),this.selectedFiles.clear(),document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>t.remove());let s=this.plugin;s&&typeof s.removeView=="function"&&s.removeView(this)}async onNew(){let e=B(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let s=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),t=this.app.vault.getAbstractFileByPath(s);if((!t||!("children"in t))&&(await this.app.vault.createFolder(s),t=this.app.vault.getAbstractFileByPath(s)),t&&"children"in t){let i=await this.app.vault.create(`${s}/Untitled.md`,"");return await this.app.workspace.openLinkText(i.path,"",!1),!0}}catch(s){console.error("[CMS View] Error creating new note:",s)}return!1}};function ve(n,a=5){try{let e=n;if(typeof e.registerBasesView=="function")e.registerBasesView(ye,{name:"CMS",icon:n.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(s,t)=>{let i=new ce(s,t,n),o=n;return o.activeViews&&o.activeViews.add(i),i},options:mt()});else if(a>0){let s=n,t=s.registrationTimeout;t!=null&&window.clearTimeout(t),s.registrationTimeout=window.setTimeout(()=>{s.registrationTimeout=null,ve(n,a-1)},200)}else console.warn("Bases CMS: registerBasesView not available. Is Bases plugin installed?")}catch(e){console.error("Bases CMS: Error registering view:",e)}}function mt(){let{getCMSViewOptions:n}=(K(),Se(Fe));return n}var pe=class extends je.Plugin{constructor(){super(...arguments);this.activeViews=new Set;this.registrationTimeout=null}async onload(){await this.loadSettings(),this.addSettingTab(new J(this.app,this)),ve(this)}onunload(){this.registrationTimeout!==null&&(window.clearTimeout(this.registrationTimeout),this.registrationTimeout=null),this.activeViews.clear()}async loadSettings(){this.settings=Object.assign({},ke,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}refreshAllToolbars(){let e=[];this.activeViews.forEach(s=>{let t=s.containerEl;(!t||!t.parentElement)&&e.push(s)}),e.forEach(s=>this.activeViews.delete(s)),this.activeViews.forEach(s=>{s&&typeof s.refreshToolbar=="function"&&s.refreshToolbar()})}removeView(e){this.activeViews.delete(e)}};
