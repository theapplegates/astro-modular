/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ge=Object.defineProperty;var Ze=Object.getOwnPropertyDescriptor;var Je=Object.getOwnPropertyNames;var Xe=Object.prototype.hasOwnProperty;var Ye=(o,n)=>()=>(o&&(n=o(o=0)),n);var ke=(o,n)=>{for(var e in n)ge(o,e,{get:n[e],enumerable:!0})},et=(o,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of Je(n))!Xe.call(o,s)&&s!==e&&ge(o,s,{get:()=>n[s],enumerable:!(t=Ze(n,s))||t.enumerable});return o};var Ce=o=>et(ge({},"__esModule",{value:!0}),o);var Me={};ke(Me,{getCMSViewOptions:()=>nt,readCMSSettings:()=>B});function B(o,n){var e,t,s,i,a,r,l,c,p,u,h,d,m,g,E,y;return{titleProperty:o.get("titleProperty")||"",descriptionProperty:o.get("descriptionProperty")||"",imageProperty:o.get("imageProperty")||"",showTitle:(e=o.get("showTitle"))!=null?e:!0,showDate:(t=o.get("showDate"))!=null?t:!1,dateProperty:o.get("dateProperty")||"",showTextPreview:(s=o.get("showTextPreview"))!=null?s:!0,fallbackToContent:(i=o.get("fallbackToContent"))!=null?i:!0,fallbackToEmbeds:(a=o.get("fallbackToEmbeds"))!=null?a:!1,propertyDisplay1:o.get("propertyDisplay1")||"",propertyDisplay2:o.get("propertyDisplay2")||"",propertyDisplay3:o.get("propertyDisplay3")||"",propertyDisplay4:o.get("propertyDisplay4")||"",propertyLayout12SideBySide:(r=o.get("propertyLayout12SideBySide"))!=null?r:!1,propertyLayout34SideBySide:(l=o.get("propertyLayout34SideBySide"))!=null?l:!1,imageFormat:o.get("imageFormat")||"thumbnail",propertyLabels:o.get("propertyLabels")||"hide",showDraftStatus:(c=o.get("showDraftStatus"))!=null?c:!1,draftStatusProperty:o.get("draftStatusProperty")||"",draftStatusReverse:(p=o.get("draftStatusReverse"))!=null?p:!1,draftStatusUseFilenamePrefix:(u=o.get("draftStatusUseFilenamePrefix"))!=null?u:!1,showTags:(h=o.get("showTags"))!=null?h:!1,tagsProperty:o.get("tagsProperty")||"",maxTagsToShow:(d=o.get("maxTagsToShow"))!=null?d:3,customizeNewButton:(m=o.get("customizeNewButton"))!=null?m:!1,newNoteLocation:o.get("newNoteLocation")||"",hideQuickEditIcon:(g=o.get("hideQuickEditIcon"))!=null?g:!1,cardSize:(E=o.get("cardSize"))!=null?E:250,imageAspectRatio:(y=o.get("imageAspectRatio"))!=null?y:.55}}function nt(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Filename underscore prefix as draft indicator",key:"draftStatusUseFilenamePrefix",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"slider",displayName:"Maximum tags to show",key:"maxTagsToShow",min:1,max:50,step:1,default:3,showWhen:{key:"showTags",value:!0}},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""},{type:"toggle",displayName:"Hide quick edit icon",key:"hideQuickEditIcon",default:!1}]}var Y=Ye(()=>{"use strict"});var wt={};ke(wt,{default:()=>he});module.exports=Ce(wt);var Ge=require("obsidian");var D=require("obsidian");var Pe=require("obsidian"),Z=class extends Pe.FuzzySuggestModal{constructor(e,t){super(e);this.onSelect=t}getItems(){let e=this.app.commands,t=new Map;if(e&&typeof e.listCommands=="function")try{let i=e.listCommands();for(let a of i)a&&a.id&&a.name&&!t.has(a.id)&&t.set(a.id,{id:a.id,name:a.name})}catch(i){console.warn("[Bases CMS] Error getting commands via listCommands():",i)}try{let i=e==null?void 0:e.commands;if(i&&typeof i=="object"){let a=Object.values(i);for(let r of a)r&&r.id&&r.name&&!t.has(r.id)&&t.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via registry:",i)}try{let i=e==null?void 0:e.commandRegistry;if(i&&typeof i=="object"){let a=Object.values(i);for(let r of a)r&&r.id&&r.name&&!t.has(r.id)&&t.set(r.id,{id:r.id,name:r.name})}}catch(i){console.warn("[Bases CMS] Error getting commands via internal registry:",i)}let s=Array.from(t.values());return s.sort((i,a)=>i.name.localeCompare(a.name)),s}getItemText(e){return e.name}onChooseItem(e,t){this.onSelect(e.id)}renderSuggestion(e,t){let s=e.item;t.createDiv({cls:"suggestion-title",text:s.name})}};var M=require("obsidian"),tt=()=>{if(M.requireApiVersion&&(0,M.requireApiVersion)("1.7.3")&&M.getIconIds)try{return(0,M.getIconIds)()}catch(o){console.warn("[Bases CMS] Error getting icon IDs from Obsidian:",o)}return["settings-2","settings","help-circle","info","star","heart","bookmark","home","search","bell","mail","user","users","folder","file","file-text","image","video","music","calendar","clock","edit","pencil","trash","copy","cut","paste","download","upload","save","share","link","external-link","lock","unlock","eye","eye-off","key","shield","check","x","plus","minus","arrow-left","arrow-right","arrow-up","arrow-down","chevron-left","chevron-right","chevron-up","chevron-down","menu","more-horizontal","more-vertical","grid","list","layout","columns","rows","maximize","minimize","zoom-in","zoom-out","refresh-cw","play","pause","stop","sun","moon","cloud","zap","wand-2","wand","wand-sparkles","palette","brush","sliders","power","wifi","bluetooth","monitor","laptop","smartphone","camera","mic","headphones","code","terminal","terminal-square","github","gitlab","git-branch","git-commit","database","server","cloud-download","cloud-upload","tag","tags","flag","pin","map-pin","compass","globe","rocket","car","bike","robot","apple","windows","linux","chrome","firefox","safari","credit-card","wallet","coins","book","book-open","award","trophy","badge","wrench","tool","package","box","archive","send","reply","forward","mail-open","tag-plus","tag-minus","flag-off","pin-off","map-pin-off","navigation","map","earth","plane","ship","anchor","helicopter","drone","android","keyhole","keys","fingerprint","scan","qr-code","barcode","receipt","piggy-bank","banknote","pencil-line","edit-2","edit-3"]},st=tt().map(o=>({id:o,name:o.replace(/^lucide-/,"").replace(/-/g," ").replace(/(^\w{1})|(\s+\w{1})/g,n=>n.toUpperCase())})).sort((o,n)=>o.name.localeCompare(n.name)),J=class extends M.FuzzySuggestModal{constructor(e,t){super(e);this.onSelect=t}getItems(){return st}getItemText(e){return e.name}onChooseItem(e,t){this.onSelect(e.id)}renderSuggestion(e,t){let s=e.item;t.addClass("mod-complex"),t.createDiv({cls:"suggestion-content"}).createDiv({cls:"suggestion-title",text:s.name});let a=t.createDiv({cls:"suggestion-aux"});(0,M.setIcon)(a.createSpan({cls:"suggestion-flair"}),s.id)}};var X=class extends D.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}refreshActiveToolbars(){let e=this.plugin;e&&typeof e.refreshAllToolbars=="function"&&e.refreshAllToolbars()}display(){let{containerEl:e}=this;e.empty(),new D.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations.").addToggle(i=>i.setValue(this.plugin.settings.confirmBulkOperations).onChange(a=>{(async()=>(this.plugin.settings.confirmBulkOperations=a,await this.plugin.saveData(this.plugin.settings)))()})),new D.Setting(e).setName("Toolbar buttons").setHeading(),new D.Setting(e).setName("Show select all button").setDesc("Display the select all button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarSelectAll).onChange(a=>{(async()=>(this.plugin.settings.showToolbarSelectAll=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show clear button").setDesc("Display the clear selection button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarClear).onChange(a=>{(async()=>(this.plugin.settings.showToolbarClear=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show publish button").setDesc("Display the publish button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarPublish).onChange(a=>{(async()=>(this.plugin.settings.showToolbarPublish=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show draft button").setDesc("Display the draft button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarDraft).onChange(a=>{(async()=>(this.plugin.settings.showToolbarDraft=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show tags button").setDesc("Display the tags button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarTags).onChange(a=>{(async()=>(this.plugin.settings.showToolbarTags=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show set button").setDesc("Display the set property button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarSet).onChange(a=>{(async()=>(this.plugin.settings.showToolbarSet=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show remove button").setDesc("Display the remove property button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarRemove).onChange(a=>{(async()=>(this.plugin.settings.showToolbarRemove=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Show delete button").setDesc("Display the delete button in the CMS toolbar.").addToggle(i=>i.setValue(this.plugin.settings.showToolbarDelete).onChange(a=>{(async()=>(this.plugin.settings.showToolbarDelete=a,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new D.Setting(e).setName("Deletions").setHeading(),new D.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder and all its contents if the note file name matches the specified name.").addToggle(i=>i.setValue(this.plugin.settings.deleteParentFolder).onChange(a=>{(async()=>(this.plugin.settings.deleteParentFolder=a,await this.plugin.saveData(this.plugin.settings)))()})),new D.Setting(e).setName("Folder deletion file name").setDesc("File name that triggers parent folder deletion.").addText(i=>i.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(a=>{(async()=>(this.plugin.settings.deleteParentFolderFilename=a,await this.plugin.saveData(this.plugin.settings)))()})).setDisabled(!this.plugin.settings.deleteParentFolder),new D.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(i=>i.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(a=>{(async()=>(this.plugin.settings.deleteUniqueAttachments=a,await this.plugin.saveData(this.plugin.settings)))()})),new D.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files.").addToggle(i=>i.setValue(this.plugin.settings.confirmDeletions).onChange(a=>{(async()=>(this.plugin.settings.confirmDeletions=a,await this.plugin.saveData(this.plugin.settings)))()})),new D.Setting(e).setName("Appearance").setHeading(),new D.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(i=>i.setValue(this.plugin.settings.useHomeIcon).onChange(a=>{(async()=>(this.plugin.settings.useHomeIcon=a,await this.plugin.saveData(this.plugin.settings)))()})),new D.Setting(e).setName("Quick edit").setHeading(),new D.Setting(e).setName("Enable quick edit").setDesc("Show an icon on card titles that launches a command when clicked.").addToggle(i=>i.setValue(this.plugin.settings.enableQuickEdit).onChange(a=>{(async()=>(this.plugin.settings.enableQuickEdit=a,await this.plugin.saveData(this.plugin.settings),t.settingEl.toggleClass("bases-cms-setting-hidden",!a)))()}));let t=new D.Setting(e).setName("Quick edit command").setDesc("The command to execute when clicking the quick edit icon on a card title.").addButton(i=>{var r;let a=this.plugin.settings.quickEditCommandName||(this.plugin.settings.quickEditCommand?"Select command...":"No command selected");if(i.setButtonText(a).onClick(()=>{new Z(this.app,c=>{(async()=>{let p=this.app.commands,u="";if(p){if(typeof p.listCommands=="function"){let d=p.listCommands().find(m=>m.id===c);d&&(u=d.name)}if(!u){let h=p.commands;h&&h[c]&&(u=h[c].name||"")}}this.plugin.settings.quickEditCommand=c,this.plugin.settings.quickEditCommandName=u,await this.plugin.saveData(this.plugin.settings),this.display()})()}).open()}),this.plugin.settings.quickEditCommand){let l=(r=i.buttonEl.parentElement)==null?void 0:r.createEl("button",{text:"Clear",attr:{style:"margin-left: 8px;"}});l==null||l.addEventListener("click",()=>{(async()=>(this.plugin.settings.quickEditCommand="",this.plugin.settings.quickEditCommandName="",await this.plugin.saveData(this.plugin.settings),this.display()))()})}});t.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit),new D.Setting(e).setName("Quick edit icon").setDesc("Select the icon to display for the quick edit button on card titles.").addButton(i=>{let a=this.getIconName(this.plugin.settings.quickEditIcon||"pencil-line");i.setButtonText(a||"Select icon...").onClick(()=>{new J(this.app,async l=>{this.plugin.settings.quickEditIcon=l,await this.plugin.saveData(this.plugin.settings),this.display()}).open()})}).settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit)}getIconName(e){return e?e.replace(/^lucide-/,"").split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):""}};var xe={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,enableQuickEdit:!1,quickEditCommand:"",quickEditCommandName:"",quickEditIcon:"pencil-line",showToolbarSelectAll:!0,showToolbarClear:!0,showToolbarDraft:!0,showToolbarPublish:!0,showToolbarTags:!0,showToolbarSet:!0,showToolbarRemove:!0,showToolbarDelete:!0};var j=require("obsidian");function I(o,n){if(!n||!n.trim())return null;let e=n.split(",").map(t=>t.trim()).filter(t=>t);for(let t of e){let s=o.getValue(t),i=s;if(i&&("date"in i&&i.date instanceof Date||"data"in i))return s}return null}function De(o,n){if(!n||!n.trim())return[];let e=n.split(",")[0].trim();if(!e)return[];let t=o.getValue(e);if(!t||!("data"in t))return[];let s=t.data,i=[];if(Array.isArray(s)){for(let a of s)if(typeof a=="string"||typeof a=="number"){let r=String(a);if(r&&r.trim()){i.push(r);break}}}else if(s!=null&&s!==""&&(typeof s=="string"||typeof s=="number")){let a=String(s);a.trim()&&i.push(a)}return i}function Fe(o,n,e,t){if(!o||o==="")return"";if(e){let s=e;if(typeof s.getDisplayName=="function")try{let i=s.getDisplayName(o);if(i&&typeof i=="string"&&i.trim()!=="")return i}catch(i){}}return o}function it(o,n,e,t,s,i,a){let r=o.file.basename||o.file.name,l=I(o,n.titleProperty),c=l==null?void 0:l.data,p=c!=null&&c!==""&&(typeof c=="string"||typeof c=="number")?String(c):r,u=o.file.path,h=u.split("/").slice(0,-1).join("/"),d=o.getValue("note.tags"),m=[];if(d&&d.data!=null){let f=d.data;m=(Array.isArray(f)?f.map(b=>b&&typeof b=="object"&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>b):typeof f=="string"||typeof f=="number"?[String(f)]:[]).map(b=>b.replace(/^#/,""))}let g=o.getValue("file.tags"),E=[];if(g&&g.data!=null){let f=g.data;E=(Array.isArray(f)?f.map(b=>b&&typeof b=="object"&&b!==null&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>typeof b=="string"&&b.length>0):typeof f=="string"||typeof f=="number"?[String(f)]:[]).map(b=>b.replace(/^#/,""))}let y=o.file.stat.ctime,S=o.file.stat.mtime,w=[];if(n.showTags&&n.tagsProperty){let f=I(o,n.tagsProperty);if(f&&f.data!=null){let v=f.data;Array.isArray(v)?w=v.map(b=>b&&typeof b=="object"&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>typeof b=="string"&&b.length>0):(typeof v=="string"||typeof v=="number")&&(w=[String(v)])}}let T={path:u,name:r,title:p,tags:E,yamlTags:m,ctime:y,mtime:S,folderPath:h,snippet:s,imageUrl:i,hasImageAvailable:a||!1,displayTags:w.length>0?w:void 0},C=[n.propertyDisplay1,n.propertyDisplay2,n.propertyDisplay3,n.propertyDisplay4],P=new Set,x=C.map(f=>!f||f===""||P.has(f)?"":(P.add(f),f));return T.propertyName1=x[0]||void 0,T.propertyName2=x[1]||void 0,T.propertyName3=x[2]||void 0,T.propertyName4=x[3]||void 0,T.property1=x[0]?W(x[0],o,T,n):null,T.property2=x[1]?W(x[1],o,T,n):null,T.property3=x[2]?W(x[2],o,T,n):null,T.property4=x[3]?W(x[3],o,T,n):null,T}function Ae(o,n,e,t,s,i,a){return o.map(r=>it(r,n,e,t,s[r.file.path],i[r.file.path],a[r.file.path]))}function W(o,n,e,t){if(!o||o==="")return null;if(o==="file.path"||o==="file path")return e.folderPath||null;if(o==="tags"||o==="note.tags")return e.yamlTags.length>0?"tags":null;if(o==="file.tags"||o==="file tags")return e.tags.length>0?"tags":null;if(o==="file.ctime"||o==="created time")return new Date(e.ctime).toLocaleDateString();if(o==="file.mtime"||o==="modified time")return new Date(e.mtime).toLocaleDateString();let s=I(n,o);if(!s)return null;let i=s;if(!i)return null;if("date"in i&&i.date instanceof Date)return i.date.toLocaleDateString();let a=i.data;return a==null||a===""?null:Array.isArray(a)?a.length===0?null:a.map(r=>r&&typeof r=="object"&&"data"in r?String(r.data):String(r)).filter(r=>r&&r.trim()!=="").join(", "):typeof a=="string"||typeof a=="number"||typeof a=="boolean"?String(a):null}Y();function Ie(o){return/^https?:\/\//i.test(o)}function me(o){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(o)}function Be(o){return new Promise(n=>{let e=new Image;e.onload=()=>n(!0),e.onerror=()=>n(!1),setTimeout(()=>n(!1),5e3),e.src=o})}function at(o){let n=o.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return n?n[1].trim():o}async function Le(o){let n=[],e=[];for(let a of o){let r=at(a);r.length!==0&&(Ie(r)?(me(r)||!r.includes("."))&&e.push(r):me(r)&&n.push(r))}let t=e.map(a=>Be(a).then(r=>r?a:null)),i=(await Promise.all(t)).filter(a=>a!==null);return{internalPaths:n,externalUrls:i}}function Oe(o,n,e){let t=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=[];for(let i of o){let a=e.metadataCache.getFirstLinkpathDest(i,n);if(a&&t.includes(a.extension)){let r=e.vault.getResourcePath(a);s.push(r)}}return s}async function fe(o,n){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],t=n.metadataCache.getFileCache(o);if(!(t!=null&&t.embeds))return[];let s=[],i=[];for(let c of t.embeds){let p=c.link;if(Ie(p))(me(p)||!p.includes("."))&&i.push(p);else{let u=n.metadataCache.getFirstLinkpathDest(p,o.path);if(u&&e.includes(u.extension)){let h=n.vault.getResourcePath(u);s.push(h)}}}let a=i.map(c=>Be(c).then(p=>p?c:null)),l=(await Promise.all(a)).filter(c=>c!==null);return[...s,...l]}var ot=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function rt(o){let n=new Map,e=0;return{text:o.replace(/\\(.)/g,(s,i)=>{let a=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return n.set(a,i),e++,a}),map:n}}function lt(o,n){let e=o;return n.forEach((t,s)=>{e=e.split(s).join(t)}),e}function ct(o){let n=o,e=!0;for(;e;){e=!1;let t=n.match(/^([`~]{3,})/m);if(!t)break;let s=t[1][0],i=t[1].length,a=t.index,r=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`^${r}{${i}}\\s*$`,"m"),p=n.substring(a+t[1].length).match(l);if(p){let h=a+t[1].length+p.index+p[0].length;n=n.substring(0,a)+n.substring(h),e=!0}else{let u=n.indexOf(`
`,a);u===-1?n=n.substring(0,a):n=n.substring(0,a)+n.substring(u+1),e=!0}}return n}function pt(o){if(!o||o.trim().length===0)return"";o=o.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),o=o.replace(/^>\s?/gm,"");let{text:n,map:e}=rt(o),t=ct(n);return ot.forEach(s=>{t=t.replace(s,(i,...a)=>{if(i.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return a[1]||"";if(a.length>0&&a[0]!==void 0){for(let r=0;r<a.length-2;r++)if(typeof a[r]=="string")return a[r]}return""})}),t=lt(t,e),t}function dt(o,n=!1,e,t){let s=o.replace(/^---[\s\S]*?---/,"").trim(),i=pt(s),a=i.indexOf(`
`),r=(a!==-1?i.substring(0,a):i).trim();(n||e&&r===e||t&&r===t)&&(i=a!==-1?i.substring(a+1).trim():"");let l=i.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(u=>u).join(" ").trim().replace(/\.{2,}/g,u=>u.replace(/\./g,"\u2024")),c=l.length>500,p=l.substring(0,500);return c&&(p+="\u2026"),p}async function Ne(o,n,e,t,s,i){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(t.fallbackToContent){let r=await n.vault.cachedRead(o);return dt(r,t.omitFirstLine,s,i)}return""}async function ht(o,n,e,t,s,i,a){if(!(o in i))try{let{internalPaths:r,externalUrls:l}=await Le(t),c=[...Oe(r,o,e),...l];c.length===0&&s&&(c=await fe(n,e)),c.length>0&&(i[o]=c.length>1?c:c[0],a[o]=!0)}catch(r){console.error(`Failed to load image for ${o}:`,r)}}async function be(o,n,e,t,s){let i=o.filter(r=>!(r.path in t)),a=50;for(let r=0;r<i.length;r+=a){let l=i.slice(r,r+a);await Promise.all(l.map(async c=>{await ht(c.path,c.file,e,c.imagePropertyValues,n,t,s)}))}}async function Ve(o,n,e,t){await Promise.all(o.map(async s=>{if(!(s.path in e||t[s.path]))try{let i=await fe(s.file,n);i.length>0&&(e[s.path]=i.length>1?i:i[0],t[s.path]=!0)}catch(i){console.error(`Failed to load embed images for ${s.path}:`,i)}}))}async function Re(o,n,e,t,s){await Promise.all(o.map(async i=>{if(!(i.path in s))try{i.file.extension==="md"?s[i.path]=await Ne(i.file,t,i.descriptionData,{fallbackToContent:n,omitFirstLine:e},i.fileName,i.titleString):s[i.path]=""}catch(a){console.error(`Failed to load snippet for ${i.path}:`,a),s[i.path]=""}}))}var G=require("obsidian");function ut(o,n){let e=null,t=!1;if(n.draftStatusUseFilenamePrefix&&o.file&&o.file.name)e=o.file.name.startsWith("_"),t=n.draftStatusReverse?!e:e;else if(n.draftStatusProperty){let s=I(o,n.draftStatusProperty);if(s){let i=s;i&&"data"in i&&typeof i.data=="boolean"&&(e=i.data,t=n.draftStatusReverse?!e:e)}}return{booleanValue:e,isDraft:t}}function ee(o,n,e,t,s){if(!t.showDraftStatus)return;let{booleanValue:i,isDraft:a}=ut(n,t);if(i!==null){let r=o.createDiv("card-status-badge");a?(r.addClass("status-draft"),r.appendText("Draft")):(r.addClass("status-published"),r.appendText("Published")),s&&(r.addClass("bases-cms-cursor-pointer"),r.addEventListener("click",l=>{l.stopPropagation(),s(e,"draft",!i)}))}}var te=require("obsidian");function $e(o,n,e,t,s,i){if(!n.settings.enableQuickEdit||!n.settings.quickEditCommand||n.settings.quickEditCommand===""||i.hideQuickEditIcon)return;let a=e.createSpan("bases-cms-quick-edit-icon");a.addClass("bases-cms-cursor-default"),(0,te.setIcon)(a,n.settings.quickEditIcon||"pencil-line"),e.addEventListener("click",r=>{a.contains(r.target)&&(r.stopPropagation(),r.stopImmediatePropagation())},!0),t.addEventListener("click",r=>{(async()=>{var p,u,h,d,m;let l=r.target;if(!a.contains(l)&&!l.closest(".bases-cms-quick-edit-icon"))return;r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault();let c=o.vault.getAbstractFileByPath(s);if(c instanceof te.TFile){let g=n.settings.quickEditCommand,E=!1;try{let y=null,S=g;if(g.includes(":")){let w=g.split(":");y=w[0],S=w.slice(1).join(":")}else{let T=o.commands,C=(p=T==null?void 0:T.commands)==null?void 0:p[g];if(C){let P=C.plugin||C.sourcePlugin;P&&(y=((u=P.manifest)==null?void 0:u.id)||P.pluginId||null)}}if(y){let w=o.plugins,T=(h=w==null?void 0:w.plugins)==null?void 0:h[y];if(T){let C=S.split("-").map((P,x)=>x===0?P:P.charAt(0).toUpperCase()+P.slice(1)).join("")+"ByPath";if(T&&typeof T[C]=="function"){await T[C](s),E=!0;return}}}}catch(y){}if(!E)try{await((m=(d=o.commands)==null?void 0:d.executeCommandById)==null?void 0:m.call(d,n.settings.quickEditCommand));return}catch(y){let S=o.workspace.getLeaf(!1);await S.openFile(c);let w=()=>{let T=S.view,C=T;T&&"editor"in T&&C.editor?setTimeout(()=>{(async()=>{var P,x;try{await((x=(P=o.commands)==null?void 0:P.executeCommandById)==null?void 0:x.call(P,n.settings.quickEditCommand))}catch(f){}})()},100):setTimeout(w,50)};w()}}})()},!0),a.addEventListener("mousedown",r=>{r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault()},!0)}var se=class{constructor(n,e,t,s,i,a){this.app=n;this.plugin=e;this.propertyObservers=t;this.updateLayoutRef=s;this.basesConfig=i,this.basesController=a}renderCard(n,e,t,s,i,a,r,l){let c=n.createDiv("card bases-cms-card");s.imageFormat==="cover"?c.classList.add("image-format-cover"):s.imageFormat==="thumbnail"&&c.classList.add("image-format-thumbnail"),c.setAttribute("data-path",e.path),c.setAttribute("data-href",e.path),c.addClass("bases-cms-cursor-pointer");let p=c.createDiv("bases-cms-select-checkbox"),u=p.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(u.checked=a,u.addEventListener("change",h=>{h.stopPropagation(),h.stopImmediatePropagation(),r(e.path,u.checked)}),u.addEventListener("click",h=>{h.stopPropagation(),h.stopImmediatePropagation()}),s.showDraftStatus&&s.imageFormat!=="cover"&&ee(c,t,e.path,s,l),c.addEventListener("click",h=>{let d=h.target;if(d.closest(".bases-cms-quick-edit-icon")){h.stopPropagation(),h.stopImmediatePropagation(),h.preventDefault();return}if(p.contains(d)||d.tagName==="INPUT"||d.closest("input")||d.closest(".bases-cms-property")||d.closest(".card-status-badge"))return;let g=h.metaKey||h.ctrlKey;this.app.workspace.openLinkText(e.path,"",g)}),c.addEventListener("contextmenu",h=>{let d=h.target;if(p.contains(d)||d.tagName==="INPUT"||d.closest("input")||d.closest(".bases-cms-property")||d.closest(".card-status-badge")||d.closest(".bases-cms-quick-edit-icon"))return;let m=this.app.vault.getAbstractFileByPath(e.path);if(m&&m instanceof G.TFile){h.stopPropagation();let g=new G.Menu;this.app.workspace.trigger("file-menu",g,m,"bases"),g.showAtMouseEvent(h)}}),s.showTitle){let h=c.createDiv("card-title");h.appendText(e.title),$e(this.app,this.plugin,h,c,e.path,s)}if(s.showDate&&s.dateProperty){let h=I(t,s.dateProperty);if(h){let d=h,m="";if(d&&"date"in d&&d.date instanceof Date)m=d.date.toLocaleDateString();else if(d&&"data"in d&&d.data){let g=d.data;if(g instanceof Date)m=g.toLocaleDateString();else if(typeof g=="string"||typeof g=="number"){let E=new Date(g);isNaN(E.getTime())?m=String(g):m=E.toLocaleDateString()}}m&&c.createDiv("card-date").appendText(m)}}if(s.showTextPreview||s.showTags&&e.displayTags&&e.displayTags.length>0||s.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||s.imageFormat==="cover"){let h=c.createDiv("card-content");if(s.imageFormat==="thumbnail"){let d=h.createDiv("card-text-wrapper");if(s.showTextPreview){let m=d.createDiv("card-text-preview");e.snippet&&m.setText(e.snippet),c.__textPreviewEl=m,c.__cardPath=e.path}if(s.showTags&&e.displayTags&&e.displayTags.length>0){let m=d.createDiv("card-tags"),g=s.maxTagsToShow,E=e.displayTags.slice(0,g),y=e.displayTags.length-g;E.forEach(S=>{m.createSpan("card-tag").appendText(S)}),y>0&&m.createSpan("card-tag-more").appendText(`+${y} more`)}}else{if(s.showTextPreview){let d=h.createDiv("card-text-preview");e.snippet&&d.setText(e.snippet),c.__textPreviewEl=d,c.__cardPath=e.path}if(s.showTags&&e.displayTags&&e.displayTags.length>0){let d=h.createDiv("card-tags"),m=s.maxTagsToShow,g=e.displayTags.slice(0,m),E=e.displayTags.length-m;g.forEach(y=>{d.createSpan("card-tag").appendText(y)}),E>0&&d.createSpan("card-tag-more").appendText(`+${E} more`)}}if(s.imageFormat!=="none"&&e.imageUrl){let m=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(y=>y&&typeof y=="string"&&y.trim().length>0),g=s.imageFormat==="cover"?"card-cover":"card-thumbnail",E=h.createDiv(g);if(m.length>0){let y=E.createDiv("image-embed"),S=y.createEl("img",{attr:{alt:"",decoding:"async",sizes:s.imageFormat==="cover"?"100vw":"80px"}});return y.style.setProperty("--cover-image-url",`url("${m[0]}")`),s.showDraftStatus&&s.imageFormat==="cover"&&ee(E,t,e.path,s,l),this.renderProperties(c,e,t,s,l),{img:S,src:m[0]}}}else if(s.imageFormat==="cover"){let d=h.createDiv("card-cover-placeholder");ee(d,t,e.path,s,l)}}return this.renderProperties(c,e,t,s,l),null}renderProperties(n,e,t,s,i){let a=[s.propertyDisplay1,s.propertyDisplay2,s.propertyDisplay3,s.propertyDisplay4],r=new Set,l=a.map(d=>!d||d===""||r.has(d)?"":(r.add(d),d)),c=l.map(d=>d?W(d,t,e,s):null),p=l[0]!==""||l[1]!=="",u=l[2]!==""||l[3]!=="";if(!p&&!u)return;let h=n.createDiv("card-properties properties-4field");if(p){let d=h.createDiv("property-row property-row-1");s.propertyLayout12SideBySide&&d.addClass("property-row-side-by-side");let m=d.createDiv("property-field property-field-1");l[0]&&this.renderPropertyContent(m,l[0],c[0],e,t,s,i);let g=d.createDiv("property-field property-field-2");l[1]&&this.renderPropertyContent(g,l[1],c[1],e,t,s,i)}if(u){let d=h.createDiv("property-row property-row-2");s.propertyLayout34SideBySide&&d.addClass("property-row-side-by-side");let m=d.createDiv("property-field property-field-3");l[2]&&this.renderPropertyContent(m,l[2],c[2],e,t,s,i);let g=d.createDiv("property-field property-field-4");l[3]&&this.renderPropertyContent(g,l[3],c[3],e,t,s,i)}}renderPropertyContent(n,e,t,s,i,a,r){if(e===""||!t&&a.propertyLabels==="hide"||a.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&s.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&s.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&s.folderPath.length===0))return;let l=Fe(e,this.app,this.basesConfig,this.basesController),c=l.toLowerCase()!==e.toLowerCase();if(a.propertyLabels==="above"){let h=n.createDiv("property-label");c&&h.addClass("property-label-custom"),h.textContent=l}let p=n.createDiv("property-content");if(a.propertyLabels==="inline"){let h=p.createSpan("property-label-inline");h.textContent=l+": "}if(!t){p.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")p.createSpan().appendText(t);else if((e==="tags"||e==="note.tags")&&s.yamlTags.length>0){let h=p.createDiv("tags-wrapper");s.yamlTags.forEach(d=>{h.createEl("a",{cls:"tag",text:d,href:"#"}).addEventListener("click",g=>{var y,S,w;g.preventDefault();let E=(S=(y=this.app.internalPlugins)==null?void 0:y.plugins)==null?void 0:S["global-search"];(w=E==null?void 0:E.instance)!=null&&w.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+d)})})}else if((e==="file.tags"||e==="file tags")&&s.tags.length>0){let h=p.createDiv("tags-wrapper");s.tags.forEach(d=>{h.createEl("a",{cls:"tag",text:d,href:"#"}).addEventListener("click",g=>{var y,S,w;g.preventDefault();let E=(S=(y=this.app.internalPlugins)==null?void 0:y.plugins)==null?void 0:S["global-search"];(w=E==null?void 0:E.instance)!=null&&w.openGlobalSearch&&E.instance.openGlobalSearch("tag:"+d)})})}else if((e==="file.path"||e==="path"||e==="file path")&&s.path.length>0){let h=p.createDiv("path-wrapper"),d=s.path.split("/").filter(m=>m);d.forEach((m,g)=>{let E=h.createSpan(),y=g===d.length-1,S=y?"path-segment filename-segment":"path-segment file-path-segment";E.createSpan({cls:S,text:m}).addEventListener("click",T=>{if(T.stopPropagation(),y){let C=this.app.vault.getAbstractFileByPath(s.path);C instanceof G.TFile&&this.app.workspace.getLeaf(!1).openFile(C)}}),g<d.length-1&&E.createSpan({cls:"path-separator",text:"/"})})}else{let h=this.app.metadataCache,m=(typeof h.getAllPropertyInfos=="function"?h.getAllPropertyInfos():{})[e.toLowerCase()],g=i.getValue(e);if(((m==null?void 0:m.widget)==="checkbox"||g&&"data"in g&&typeof g.data=="boolean")&&r){let y=p.createEl("input",{type:"checkbox",cls:"checkbox-input"});y.checked=g&&"data"in g?Boolean(g.data):!1;let S=e.startsWith("note.")?e.substring(5):e;p.createSpan({cls:"checkbox-label",text:S}),y.addEventListener("click",w=>{w.stopPropagation()}),y.addEventListener("change",w=>{w.stopPropagation(),(async()=>{try{let T=e.startsWith("note.")?e.substring(5):e;await r(s.path,T,y.checked)}catch(T){console.error("Error toggling property:",T),y.checked=!y.checked}})()})}else p.createDiv("text-wrapper").appendText(t)}(!p.textContent||p.textContent.trim().length===0)&&p.remove()}};var We=require("obsidian");var R=require("obsidian");async function ye(o,n,e,t){await o.fileManager.processFrontMatter(n,s=>{for(let[i,a]of e){if(i==="tags"&&!Object.prototype.hasOwnProperty.call(s,"tags")&&!Array.isArray(a.data)){s[i]=[a.data];continue}if(!s[i]||t){s[i]=a.data;continue}let r=a.type,l=s[i],c=Array.isArray(l)?"list":typeof l=="number"?"number":typeof l=="boolean"?"checkbox":"text";if(gt(r,c)){if(s[i]===a.data||!a.data)continue;let p=mt(s[i],a.data);s[i]=p;continue}else{s[i]=a.data;continue}}})}async function _e(o,n,e){await o.fileManager.processFrontMatter(n,t=>{for(let s of e)t[s]=void 0})}function gt(o,n){let e=["number","date","datetime","checkbox"];return!(e.includes(o)||e.includes(n))}function mt(...o){let e=o.map(s=>Array.isArray(s)?s:[s]).flat();return[...new Set(e)]}var L=class{constructor(n){this.app=n}async setDraft(n,e,t){await this.batchProcessFiles(n,async s=>{if(t)if(t.draftStatusUseFilenamePrefix){let i=s.basename,a=i.startsWith("_"),l=s.path.split("/"),c=e;if(t.draftStatusReverse&&(c=!e),c===!0){if(!a){let p=`_${i}${s.extension?`.${s.extension}`:""}`;l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(s,u)}}else if(a){let p=i.substring(1)+(s.extension?`.${s.extension}`:"");l[l.length-1]=p;let u=l.join("/");await this.app.fileManager.renameFile(s,u)}}else{let i=t.draftStatusProperty&&t.draftStatusProperty.trim()?t.draftStatusProperty.startsWith("note.")?t.draftStatusProperty.substring(5):t.draftStatusProperty:"draft",a=e;t.draftStatusReverse&&(a=!e),await this.app.fileManager.processFrontMatter(s,r=>{r[i]=a})}else await this.app.fileManager.processFrontMatter(s,i=>{i.draft=e})}),new R.Notice(`Set ${n.length} file${n.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(n,e){let t=new Map;t.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(n,async s=>{await ye(this.app,s,t,!1)}),new R.Notice(`Added tags to ${n.length} file${n.length!==1?"s":""}`)}async removeTags(n,e){await this.batchProcessFiles(n,async t=>{let s=this.app.metadataCache.getFileCache(t),i=s==null?void 0:s.frontmatter;if(i!=null&&i.tags){let r=(Array.isArray(i.tags)?i.tags:[i.tags]).filter(l=>!e.includes(l));await this.app.fileManager.processFrontMatter(t,l=>{r.length>0?l.tags=r:l.tags=void 0})}}),new R.Notice(`Removed tags from ${n.length} file${n.length!==1?"s":""}`)}async setProperty(n,e,t,s="text"){let i=e.startsWith("note.")?e.substring(5):e,a=new Map;a.set(i,{type:s,data:t,overwrite:!0,delimiter:","}),await this.batchProcessFiles(n,async r=>{await ye(this.app,r,a,!0)}),new R.Notice(`Set ${i} on ${n.length} file${n.length!==1?"s":""}`)}async removeProperty(n,e){let t=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(n,async s=>{await _e(this.app,s,[t])}),new R.Notice(`Removed ${t} from ${n.length} file${n.length!==1?"s":""}`)}async batchProcessFiles(n,e){let t=0,s=n.length;for(let i of n){let a=this.app.vault.getAbstractFileByPath(i);if(a instanceof R.TFile)try{await e(a),t++}catch(r){console.error(`Error processing ${i}:`,r)}}t<s&&new R.Notice(`Processed ${t} of ${s} files`)}};var $=require("obsidian");var ie=class extends $.Modal{constructor(e,t){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=t,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new $.Setting(e).setName("Manage tags").setHeading(),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new $.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated).").addText(l=>{l.setPlaceholder("tag1, tag2, tag3").onChange(c=>{this.tagsToAdd=c})}),e.createEl("h3",{text:"Remove tags"});let t=e.createDiv(),s=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof $.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;u!=null&&u.tags&&(Array.isArray(u.tags)?u.tags:[u.tags]).forEach(d=>s.add(d))}}for(let l of Array.from(s).sort())new $.Setting(t).setName(l).addToggle(c=>{c.setValue(this.tagsToRemove.has(l)).onChange(p=>{p?this.tagsToRemove.add(l):this.tagsToRemove.delete(l)})});let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let a=i.createEl("button");a.setText("Cancel"),a.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>(await this.applyChanges(),this.close()))()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(t=>t.trim()).filter(t=>t.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var q=require("obsidian");var ne=class extends q.Modal{constructor(e,t){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=t,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new q.Setting(e).setName("Set property").setHeading(),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new q.Setting(e).setName("Property name").setDesc("Enter the property name to set.").addText(a=>{a.setPlaceholder("Enter name").onChange(r=>{this.propertyName=r})}),new q.Setting(e).setName("Property type").setDesc("Select the property type.").addDropdown(a=>{a.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(r=>{this.propertyType=r})}),new q.Setting(e).setName("Property value").setDesc("Enter the property value.").addText(a=>{a.setPlaceholder("Enter value").onChange(r=>{this.propertyValue=r})});let t=e.createDiv();t.addClass("bases-cms-modal-button-container");let s=t.createEl("button");s.setText("Cancel"),s.addEventListener("click",()=>this.close());let i=t.createEl("button");i.setText("Apply"),i.addClass("mod-cta"),i.addEventListener("click",()=>{(async()=>this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close()))()})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var z=require("obsidian");var ae=class extends z.Modal{constructor(e,t){super(e);this.propertiesToRemove=new Set;this.files=t,this.bulkOps=new L(e)}onOpen(){let{contentEl:e}=this;e.empty(),new z.Setting(e).setName("Remove property").setHeading(),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let t=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof z.TFile){let p=this.app.metadataCache.getFileCache(c),u=p==null?void 0:p.frontmatter;if(u)for(let h in u)h!=="tags"&&h!=="title"&&t.add(h)}}let s=e.createDiv();for(let l of Array.from(t).sort())new z.Setting(s).setName(l).addToggle(c=>{c.setValue(this.propertiesToRemove.has(l)).onChange(p=>{p?this.propertiesToRemove.add(l):this.propertiesToRemove.delete(l)})});t.size===0&&e.createEl("p",{text:"No properties found in selected files."});let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let a=i.createEl("button");a.setText("Cancel"),a.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close()))()})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var le=require("obsidian");var _=require("obsidian");var H=require("obsidian");function Ue(o,n){let e=[],t=o.vault.getAbstractFileByPath(n.path);if(t instanceof H.TFile){let s=o.metadataCache.getFileCache(t),i=(s==null?void 0:s.embeds)||[];for(let a of i){let r=o.metadataCache.getFirstLinkpathDest(a.link,n.path);r instanceof H.TFile&&e.push(r)}}return e}function qe(o,n){let e=[];for(let t of n.children)t instanceof H.TFile&&t.extension==="md"?e.push(...Ue(o,t)):t instanceof H.TFolder&&e.push(...qe(o,t));return e}async function ft(o,n,e,t){let s=o.vault.getMarkdownFiles().filter(l=>l.path!==e.path),i=n.path,a=n.name,r=n.basename;for(let l of s){if(t&&l.path.startsWith(t.path+"/"))continue;let c=await o.vault.read(l);if(c.includes(i)||c.includes(a)||c.includes(r)||c.includes(`![[${a}]]`)||c.includes(`[[${a}]]`)||c.includes(`(${a})`)||c.includes(`(${i})`))return!0}return!1}async function ze(o,n,e){let t=[];t.push(...Ue(o,n)),e&&t.push(...qe(o,e));let s=Array.from(new Set(t.map(a=>a.path))).map(a=>o.vault.getAbstractFileByPath(a)).filter(a=>a instanceof H.TFile),i=[];for(let a of s)await ft(o,a,n,e)||i.push(a);return i}function bt(o,n){let e=n.deleteParentFolderFilename||"index";return o.basename===e&&o.parent!==null}function He(o,n){return n.deleteParentFolder&&bt(o,n)}async function ve(o,n,e){let t=[],s=[],i=[];for(let l of n){let c=o.vault.getAbstractFileByPath(l);if(c instanceof _.TFile){if(He(c,e)){let p=c.parent;if(p&&!s.includes(p)){s.push(p);let u=p.children.filter(h=>h instanceof _.TFile);t.push(...u)}}else t.push(c);if(e.deleteUniqueAttachments){let p=He(c,e)&&c.parent||void 0,u=await ze(o,c,p);i.push(...u)}}}let a=Array.from(new Set(t.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof _.TFile),r=Array.from(new Set(i.map(l=>l.path))).map(l=>o.vault.getAbstractFileByPath(l)).filter(l=>l instanceof _.TFile);return{filesToDelete:a,foldersToDelete:Array.from(new Set(s)),attachmentsToDelete:r}}async function oe(o,n){let e=0,t=0;for(let s of n.filesToDelete)try{await o.fileManager.trashFile(s),e++}catch(i){console.error(`Error deleting file ${s.path}:`,i),t++}for(let s of n.attachmentsToDelete)try{await o.fileManager.trashFile(s),e++}catch(i){console.error(`Error deleting attachment ${s.path}:`,i),t++}for(let s of n.foldersToDelete)try{await o.fileManager.trashFile(s),e++}catch(i){console.error(`Error deleting folder ${s.path}:`,i),t++}t>0?new _.Notice(`Deleted ${e} items, ${t} errors occurred`):new _.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var re=class extends le.Modal{constructor(e,t,s){super(e);this.preview=t,this.onConfirm=s}onOpen(){let{contentEl:e}=this;if(e.empty(),new le.Setting(e).setName("Confirm deletion").setHeading(),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.filesToDelete.slice(0,20))a.createEl("li").setText(r.path);this.preview.filesToDelete.length>20&&a.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.foldersToDelete)a.createEl("li").setText(r.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let a=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.attachmentsToDelete.slice(0,20))a.createEl("li").setText(r.path);this.preview.attachmentsToDelete.length>20&&a.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"This action cannot be undone.",cls:"bases-cms-deletion-warning"});let t=e.createDiv();t.addClass("bases-cms-modal-button-container");let s=t.createEl("button");s.setText("Cancel"),s.addEventListener("click",()=>this.close());let i=t.createEl("button");i.setText("Delete"),i.addClass("mod-cta"),i.addClass("destructive"),i.addEventListener("click",()=>{(async()=>(await oe(this.app,this.preview),this.onConfirm(),this.close()))()})}onClose(){let{contentEl:e}=this;e.empty()}};var ce=require("obsidian"),K=class extends ce.Modal{constructor(e,t,s,i){super(e);this.files=t,this.operation=s,this.onConfirm=i}onOpen(){let{contentEl:e}=this;e.empty();let t=this.operation==="draft"?"mark as draft":"mark as published",s=t.charAt(0).toUpperCase()+t.slice(1);if(new ce.Setting(e).setName(`Confirm ${s}`).setHeading(),e.createEl("p",{text:`Are you sure you want to ${t} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let l=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let c of this.files.slice(0,20))l.createEl("li").setText(c);this.files.length>20&&l.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let i=e.createDiv();i.addClass("bases-cms-modal-button-container");let a=i.createEl("button");a.setText("Cancel"),a.addEventListener("click",()=>this.close());let r=i.createEl("button");r.setText("Confirm"),r.addClass("mod-cta"),r.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var pe=class{constructor(n,e,t,s,i,a,r,l){this.app=n;this.plugin=e;this.container=t;this.getSelectedFiles=s;this.clearSelection=i;this.refreshView=a;this.toolbarEl=null;this.countEl=null;this.resizeObserver=null;this.bulkOps=new L(n),this.selectAllCallback=r,this.settings=l,this.createToolbar()}updateSettings(n){this.settings=n}createToolbar(){this.toolbarEl=document.createElement("div"),this.toolbarEl.className="bases-toolbar bases-cms-bulk-toolbar bases-cms-bulk-toolbar-hidden",this.toolbarEl.__bulkToolbarInstance=this,this.createToolbarContent(),this.positionToolbar(),setTimeout(()=>this.positionToolbar(),100)}positionToolbar(){if(!this.toolbarEl)return;let n=this.container.closest(".bases-header");if(!n){let t=this.container.parentElement;for(;t&&!n;){if(t.classList.contains("bases-header")){n=t;break}t=t.parentElement}}if(!n){let t=Array.from(document.querySelectorAll(".bases-header"));for(let s of t)if(s.contains(this.container)){n=s;break}}let e=this.container.closest(".view-content");if(e)this.toolbarEl.parentElement!==e?(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container)):this.toolbarEl.nextSibling!==this.container&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container));else if(n&&n.parentElement)this.toolbarEl.parentElement!==n.parentElement&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),n.parentElement.insertBefore(this.toolbarEl,n.nextSibling));else{let t=this.container.parentElement;t&&(this.toolbarEl.parentElement!==t||this.toolbarEl.nextSibling!==this.container)&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),t.insertBefore(this.toolbarEl,this.container))}}createToolbarContent(){if(!this.toolbarEl)return;let n=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-left"),e=(i,a,r,l,c=!1)=>{let u=l.createDiv("bases-toolbar-item").createDiv("text-icon-button");c&&u.addClass("destructive"),u.setAttribute("tabindex","0");let h=u.createSpan("text-button-icon");return(0,We.setIcon)(h,i),u.createSpan("text-button-label").setText(a),u.addEventListener("click",r),u};this.plugin.settings.showToolbarSelectAll&&e("copy-check","Select all",()=>this.handleSelectAll(),n),this.plugin.settings.showToolbarClear&&e("square-x","Clear",()=>this.clearSelection(),n);let t=n.createDiv("bases-toolbar-item bases-cms-selected-count");this.countEl=t.createSpan("text-button-label"),this.countEl.setText("0 items selected");let s=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-right");this.plugin.settings.showToolbarPublish&&e("book-check","Publish",()=>{this.handlePublish()},s),this.plugin.settings.showToolbarDraft&&e("book-dashed","Draft",()=>{this.handleSetDraft()},s),this.plugin.settings.showToolbarTags&&e("tags","Tags",()=>this.handleManageTags(),s),this.plugin.settings.showToolbarSet&&e("list-check","Set",()=>this.handleSetProperty(),s),this.plugin.settings.showToolbarRemove&&e("list-x","Remove",()=>this.handleRemoveProperty(),s),this.plugin.settings.showToolbarDelete&&e("trash-2","Delete",()=>{this.handleDelete()},s,!0),this.setupResponsiveBehavior()}setupResponsiveBehavior(){if(!this.toolbarEl)return;setTimeout(()=>{this.updateCollapsedState()},100),this.toolbarEl&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCollapsedState()}),this.resizeObserver.observe(this.toolbarEl));let n=this.container;if(n){let e=new ResizeObserver(()=>{setTimeout(()=>{this.updateCollapsedState()},10)});e.observe(n),this.containerObserver=e}}updateCollapsedState(){if(!this.toolbarEl)return;this.toolbarEl.offsetWidth<680?this.toolbarEl.addClass("collapsed"):this.toolbarEl.removeClass("collapsed")}updateCount(n){this.countEl&&this.countEl.setText(`${n} item${n!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){this.toolbarEl||(console.warn("[Bases CMS] Toolbar element not found, recreating..."),this.createToolbar()),this.toolbarEl?(this.positionToolbar(),this.toolbarEl.parentElement||(console.warn("[Bases CMS] Toolbar not in DOM, repositioning..."),this.positionToolbar()),this.toolbarEl.removeClass("bases-cms-bulk-toolbar-hidden"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.offsetHeight,setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-out"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-in"))},10)):console.error("[Bases CMS] Failed to show toolbar - element is null")}hide(){this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-in"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-out"),setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-hidden"))},200))}async handleSetDraft(){let n=this.getSelectedFiles();n.length!==0&&(this.plugin.settings.confirmBulkOperations?new K(this.app,n,"draft",()=>{(async()=>(await this.bulkOps.setDraft(n,!0,this.settings),this.refreshView()))()}).open():(await this.bulkOps.setDraft(n,!0,this.settings),this.refreshView()))}async handlePublish(){let n=this.getSelectedFiles();n.length!==0&&(this.plugin.settings.confirmBulkOperations?new K(this.app,n,"publish",()=>{(async()=>(await this.bulkOps.setDraft(n,!1,this.settings),this.refreshView()))()}).open():(await this.bulkOps.setDraft(n,!1,this.settings),this.refreshView()))}handleManageTags(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new ie(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}handleSetProperty(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new ne(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}handleRemoveProperty(){let n=this.getSelectedFiles();if(n.length===0)return;let e=new ae(this.app,n);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleDelete(){let n=this.getSelectedFiles();if(n.length!==0)if(this.plugin.settings.confirmDeletions){let e=await ve(this.app,n,this.plugin.settings);new re(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await ve(this.app,n,this.plugin.settings);await oe(this.app,e),this.clearSelection(),this.refreshView()}}recreate(){let n=this.toolbarEl&&!this.toolbarEl.hasClass("bases-cms-bulk-toolbar-hidden"),e=0;if(this.countEl&&this.countEl.textContent){let t=this.countEl.textContent.match(/\d+/);t&&(e=parseInt(t[0],10))}this.destroy(),this.createToolbar(),n&&this.toolbarEl&&e>0&&(this.updateCount(e),this.show())}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);let n=this.containerObserver;n&&(n.disconnect(),this.containerObserver=void 0),this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};Y();function je(o,n,e,t,s){let i=l=>{var E;let c=l.target,p=c.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!p||c.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let u=o.workspace.activeLeaf,h=u==null?void 0:u.view,d=h?h.containerEl:null;if(!(h&&d&&(d===n||((E=p.closest(".workspace-leaf"))==null?void 0:E.contains(d)))))return;let g=B(e,t);g.customizeNewButton&&(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),(async()=>{var T;let y=((T=g.newNoteLocation)==null?void 0:T.trim())||"";if(y===""){let C=o.vault.config,P=(C==null?void 0:C.newFileLocation)||"folder",x=(C==null?void 0:C.newFileFolderPath)||"";console.debug("[CMS View] Obsidian config:",{newFileLocation:P,newFileFolderPath:x});let f="Untitled.md";if(P==="folder"&&x)f=`${x}/Untitled.md`;else if(P==="current"){let b=o.workspace.getActiveFile();b&&b.parent&&(f=`${b.parent.path}/Untitled.md`)}else P==="root"&&(f="Untitled.md");console.debug("[CMS View] Creating file at:",f);let v=await o.vault.create(f,"");await o.workspace.openLinkText(v.path,"",!1);return}if(y==="/"||y.replace(/\//g,"")===""){let C=await o.vault.create("Untitled.md","");await o.workspace.openLinkText(C.path,"",!1);return}let S=y.replace(/^\/+|\/+$/g,""),w=o.vault.getAbstractFileByPath(S);if((!w||!("children"in w))&&(await o.vault.createFolder(S),w=o.vault.getAbstractFileByPath(S)),w&&"children"in w){let C=await o.vault.create(`${S}/Untitled.md`,"");await o.workspace.openLinkText(C.path,"",!1)}})())};document.addEventListener("click",i,!0);let a=new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(c=>{let p=c;p.__cmsIntercepted||(p.__cmsIntercepted=!0,c.addEventListener("click",i,!0))})});a.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(l=>{let c=l;c.__cmsIntercepted||(c.__cmsIntercepted=!0,l.addEventListener("click",i,!0))}),s(()=>{document.removeEventListener("click",i,!0),a.disconnect()})}var we="bases-cms",de=class extends j.BasesView{constructor(e,t,s){var a;super(e);this.type=we;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.displayedCount=50;this.isLoading=!1;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.currentBaseIdentifier=null;this.backupInterval=null;this.containerEl=t,this.plugin=s,this.cardRenderer=new se(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container");let i=(a=this.app.isMobile)!=null?a:!1;this.displayedCount=i?25:50,je(this.app,this.containerEl,this.config,this.plugin.settings,r=>this.register(r)),this.setupViewSwitchListener()}setupViewSwitchListener(){let e=null,t=()=>{e||(e=new MutationObserver(l=>{if(this.selectedFiles.size!==0){for(let c of l)if(c.type==="childList"&&c.removedNodes.length>0){let p=!1;for(let h of this.selectedFiles)if(this.containerEl.querySelector(`[data-path="${h}"]`)){p=!0;break}let u=this.containerEl.querySelectorAll(".card[data-path]");if(!p||u.length===0){this.selectedFiles.clear(),this.updateSelectionUI();break}}}}),this.containerEl&&e.observe(this.containerEl,{childList:!0,subtree:!0}))},s=()=>{if(e){e.disconnect(),e=null,this.selectedFiles.size>0&&this.selectedFiles.clear(),this.updateSelectionUI(),this.bulkToolbar&&this.bulkToolbar.hide();let l=this.containerEl.querySelector(".bases-cms-bulk-toolbar");l instanceof HTMLElement&&(l.removeClass("bases-cms-bulk-toolbar-visible"),l.addClass("bases-cms-bulk-toolbar-hidden"))}},i=()=>{try{let l=this.config;if(l!=null&&l.getName)return l.getName();if(l!=null&&l.name)return String(l.name);let c=this;if(c.controller){let p=c.controller;if(p!=null&&p.getBaseName)return p.getBaseName();if(p!=null&&p.baseName)return String(p.baseName)}if(this.data){let p=this.data;if(p.baseName)return String(p.baseName)}}catch(l){}return null},a=()=>{if(this.selectedFiles.size===0){this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}let l=i();if(this.currentBaseIdentifier!==null&&l!==null&&this.currentBaseIdentifier!==l){this.selectedFiles.clear(),this.updateSelectionUI(),s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}this.containerEl.querySelectorAll(".card[data-path]").length===0&&(this.selectedFiles.clear(),this.updateSelectionUI())},r=this.handleSelectionChange.bind(this);this.handleSelectionChange=(l,c)=>{if(r(l,c),this.selectedFiles.size>0)this.currentBaseIdentifier===null&&(this.currentBaseIdentifier=i()),t(),this.backupInterval===null&&(this.backupInterval=this.plugin.registerInterval(window.setInterval(a,500)));else{this.currentBaseIdentifier=null,s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null),this.bulkToolbar&&this.bulkToolbar.hide();let p=this.containerEl.querySelector(".bases-cms-bulk-toolbar");p instanceof HTMLElement&&(p.removeClass("bases-cms-bulk-toolbar-visible"),p.addClass("bases-cms-bulk-toolbar-hidden"))}},this.register(()=>{s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)})}onDataUpdated(){let e=this.app.workspace.activeLeaf,t=e==null?void 0:e.view;if(t&&this.selectedFiles.size>0&&t!==this){if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)){this.selectedFiles.clear(),this.updateSelectionUI();return}let a=t.containerEl;if(!a||!a.contains(this.containerEl)){this.selectedFiles.clear(),this.updateSelectionUI();return}}if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)&&this.selectedFiles.size>0){this.selectedFiles.clear(),this.updateSelectionUI();return}(async()=>{var x;let i=this.data.groupedData,a=this.data.data;this.cardRenderer.basesConfig=this.config;let r=B(this.config,this.plugin.settings),l=this.containerEl.clientWidth,c=r.cardSize,p=1,u=8,h=Math.max(p,Math.floor((l+u)/(c+u))),d=(l-u*(h-1))/h;this.containerEl.style.setProperty("--card-min-width",`${d}px`),this.containerEl.style.setProperty("--grid-columns",String(h)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(r.imageAspectRatio));let m=this.containerEl.scrollTop,g=this.getSortMethod(),E=i.map(f=>({group:f,entries:[...f.entries]})),y=[],S=this.displayedCount;for(let f of E){if(S<=0)break;let v=Math.min(f.entries.length,S);y.push(...f.entries.slice(0,v)),S-=v}if(r.imageFormat!=="none"){let f=a.filter(k=>!(k.file.path in this.images)).map(k=>{let F=this.app.vault.getAbstractFileByPath(k.file.path);if(!(F instanceof j.TFile))return null;let A=De(k,r.imageProperty);return{path:k.file.path,file:F,imagePropertyValues:A}}).filter(k=>k!==null),v=f.filter(k=>y.some(F=>F.file.path===k.path)),b=f.filter(k=>!y.some(F=>F.file.path===k.path));if(v.length>0&&await be(v,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),b.length>0&&be(b,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),r.fallbackToEmbeds){let k=f.filter(F=>!(F.path in this.images)&&!this.hasImageAvailable[F.path]);k.length>0&&Ve(k,this.app,this.images,this.hasImageAvailable).then(()=>{k.forEach(F=>{var A;if(F.path in this.images){let O=this.containerEl.querySelector(`.card[data-path="${F.path}"]`);if(O){let U=this.images[F.path],N=Array.isArray(U)?U[0]:U;if(N){let Q=O.querySelector("img");if(Q){if(Q.src!==N){Q.src=N;let V=Q.parentElement;V&&V.classList.contains("image-embed")&&V.style.setProperty("--cover-image-url",`url("${N}")`)}}else{let V=O.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(V){let Te=V.querySelector(".card-status-badge"),Ke=V.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",ue=(A=V.parentElement)==null?void 0:A.createDiv(Ke);if(ue){let Se=ue.createDiv("image-embed");Q=Se.createEl("img",{attr:{src:N,alt:"",decoding:"async"}}),Se.style.setProperty("--cover-image-url",`url("${N}")`),Te&&ue.appendChild(Te),V.remove()}}}}}}})})}}if(r.showTextPreview){let f=y.filter(v=>!(v.file.path in this.snippets)).map(v=>{let b=this.app.vault.getAbstractFileByPath(v.file.path);if(!(b instanceof j.TFile))return null;let k=I(v,r.descriptionProperty);return{path:v.file.path,file:b,descriptionData:k==null?void 0:k.data}}).filter(v=>v!==null);Re(f,r.fallbackToContent,!1,this.app,this.snippets).then(()=>{f.forEach(v=>{if(v.path in this.snippets&&this.snippets[v.path]){let b=this.containerEl.querySelector(`[data-path="${v.path}"]`);if(b){let k=b.__textPreviewEl;k&&(!k.textContent||k.textContent.trim().length===0)&&k.setText(this.snippets[v.path])}}})})}let w=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let f=this.containerEl.querySelector(".bases-cms-bulk-toolbar");f instanceof HTMLElement&&(w=f,w.remove())}this.containerEl.empty(),this.propertyObservers.forEach(f=>f.disconnect()),this.propertyObservers=[];let T=this.containerEl.createDiv("bases-cms-grid"),C=0,P=[];for(let f of E){if(C>=this.displayedCount)break;let v=Math.min(f.entries.length,this.displayedCount-C);if(v===0)continue;let b=f.entries.slice(0,v),k=T.createDiv("bases-cms-group");if(f.group.hasKey()){let O=k.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),U=((x=f.group.key)==null?void 0:x.toString())||"";O.setText(U)}let F=Ae(b,r,g,!1,this.snippets,this.images,this.hasImageAvailable);for(let A=0;A<F.length;A++){let O=F[A],U=b[A],N=this.renderCard(k,O,U,C+A,r);N&&P.push(N)}C+=v}P.length>0&&requestAnimationFrame(()=>{for(let{img:f,src:v}of P)f.src=v}),m>0&&(this.containerEl.scrollTop=m),this.setupInfiniteScroll(a.length),this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>{let f=this.containerEl.clientWidth,v=B(this.config,this.plugin.settings),b=v.cardSize,k=1,F=8,A=Math.max(k,Math.floor((f+F)/(b+F))),O=(f-F*(A-1))/A;this.containerEl.style.setProperty("--card-min-width",`${O}px`),this.containerEl.style.setProperty("--grid-columns",String(A)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(v.imageAspectRatio))}),this.resizeObserver.observe(this.containerEl)),w&&this.bulkToolbar&&(this.containerEl.appendChild(w),this.bulkToolbar.toolbarEl=w),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(v=>{let b=v.getAttribute("data-path"),k=v.querySelector('input[type="checkbox"].selection-checkbox');if(b){let F=this.selectedFiles.has(b);F?v.addClass("selected"):v.removeClass("selected"),k&&(k.checked=F)}}),w&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.isLoading=!1})()}renderCard(e,t,s,i,a){let r=this.selectedFiles.has(t.path);return this.cardRenderer.renderCard(e,t,s,a,this,r,(l,c)=>{this.handleSelectionChange(l,c)},(l,c,p)=>{this.handlePropertyToggle(l,c,p)})}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let t=e[0],s=t.property,i=t.direction.toLowerCase();if(s.includes("ctime"))return`ctime-${i}`;if(s.includes("mtime"))return`mtime-${i}`}return"mtime-desc"}setupInfiniteScroll(e){this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=e)&&(this.scrollListener=()=>{var p;if(this.scrollThrottleTimeout!==null||this.isLoading)return;let t=this.containerEl.scrollTop,s=this.containerEl.scrollHeight,i=this.containerEl.clientHeight,a=s-(t+i),l=((p=this.app.isMobile)!=null?p:!1)?1:2,c=i*l;if(a<c&&this.displayedCount<e){this.isLoading=!0;let u=50;this.displayedCount=Math.min(this.displayedCount+u,e),this.onDataUpdated()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.register(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}handleSelectionChange(e,t){if(t?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI(),this.selectedFiles.size===0&&this.bulkToolbar){this.bulkToolbar.hide();let s=this.containerEl.querySelector(".bases-cms-bulk-toolbar");s instanceof HTMLElement&&(s.removeClass("bases-cms-bulk-toolbar-visible"),s.addClass("bases-cms-bulk-toolbar-hidden"))}}async handlePropertyToggle(e,t,s){try{let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof j.TFile))return;let a=t.startsWith("note.")?t.substring(5):t,r=B(this.config,this.plugin.settings),l=r.showDraftStatus&&a==="draft",c=!1;if(l)if(r.draftStatusUseFilenamePrefix){let p=i.basename,u=p.startsWith("_"),d=i.path.split("/");if(s===!0){if(!u){let m=`_${p}${i.extension?`.${i.extension}`:""}`;d[d.length-1]=m;let g=d.join("/");await this.app.fileManager.renameFile(i,g),c=!0}}else if(u){let m=p.substring(1)+(i.extension?`.${i.extension}`:"");d[d.length-1]=m;let g=d.join("/");await this.app.fileManager.renameFile(i,g),c=!0}}else{let p=r.draftStatusProperty&&r.draftStatusProperty.trim()?r.draftStatusProperty.startsWith("note.")?r.draftStatusProperty.substring(5):r.draftStatusProperty:"draft";await this.app.fileManager.processFrontMatter(i,u=>{u[p]=s}),c=!0}else await this.app.fileManager.processFrontMatter(i,p=>{p[a]=s}),c=!0;c&&requestAnimationFrame(()=>{setTimeout(()=>{try{this.onDataUpdated()}catch(p){console.error("Error refreshing view after property toggle:",p)}},100)})}catch(i){console.error("Error toggling property:",i)}}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(t=>{let s=t.getAttribute("data-path");s&&this.selectedFiles.add(s)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}refreshToolbar(){if(this.bulkToolbar){let e=this.selectedFiles.size;this.bulkToolbar.recreate(),e>0&&this.bulkToolbar.updateCount(e)}}updateSelectionUI(){if(this.containerEl.querySelectorAll(".card").forEach(t=>{let s=t.getAttribute("data-path"),i=t.querySelector('input[type="checkbox"].selection-checkbox');if(s){let a=this.selectedFiles.has(s);a?t.addClass("selected"):t.removeClass("selected"),i&&(i.checked=a)}}),this.selectedFiles.size>0){if(document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(s=>{let i=s.__bulkToolbarInstance;(!i||i!==this.bulkToolbar)&&s.remove()}),this.bulkToolbar){let s=B(this.config,this.plugin.settings);this.bulkToolbar.updateSettings(s)}else{let s=B(this.config,this.plugin.settings);this.bulkToolbar=new pe(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let i=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&i.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),setTimeout(()=>{i.forEach(a=>{this.app.vault.getAbstractFileByPath(a)&&this.selectedFiles.add(a)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()},s)}this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()}else if(this.bulkToolbar&&!this.isRefreshingWithSelection){this.bulkToolbar.hide();let t=this.containerEl.querySelector(".bases-cms-bulk-toolbar");t instanceof HTMLElement&&(t.removeClass("bases-cms-bulk-toolbar-visible"),t.addClass("bases-cms-bulk-toolbar-hidden"))}}onClose(){this.resizeObserver&&this.resizeObserver.disconnect(),this.propertyObservers.forEach(s=>s.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy(),this.selectedFiles.clear(),document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(s=>s.remove());let t=this.plugin;t&&typeof t.removeView=="function"&&t.removeView(this)}async onNew(){let e=B(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let t=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),s=this.app.vault.getAbstractFileByPath(t);if((!s||!("children"in s))&&(await this.app.vault.createFolder(t),s=this.app.vault.getAbstractFileByPath(t)),s&&"children"in s){let i=await this.app.vault.create(`${t}/Untitled.md`,"");return await this.app.workspace.openLinkText(i.path,"",!1),!0}}catch(t){console.error("[CMS View] Error creating new note:",t)}return!1}};function Ee(o,n=5){try{let e=o;if(typeof e.registerBasesView=="function")e.registerBasesView(we,{name:"CMS",icon:o.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(t,s)=>{let i=new de(t,s,o),a=o;return a.activeViews&&a.activeViews.add(i),i},options:vt()});else if(n>0){let t=o,s=t.registrationTimeout;s!=null&&window.clearTimeout(s),t.registrationTimeout=window.setTimeout(()=>{t.registrationTimeout=null,Ee(o,n-1)},200)}else console.warn("Bases CMS: registerBasesView not available. Is Bases plugin installed?")}catch(e){console.error("Bases CMS: Error registering view:",e)}}function vt(){let{getCMSViewOptions:o}=(Y(),Ce(Me));return o}var he=class extends Ge.Plugin{constructor(){super(...arguments);this.activeViews=new Set;this.registrationTimeout=null}async onload(){await this.loadSettings(),this.addSettingTab(new X(this.app,this)),Ee(this)}onunload(){this.registrationTimeout!==null&&(window.clearTimeout(this.registrationTimeout),this.registrationTimeout=null),this.activeViews.clear()}async loadSettings(){this.settings=Object.assign({},xe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}refreshAllToolbars(){let e=[];this.activeViews.forEach(t=>{let s=t.containerEl;(!s||!s.parentElement)&&e.push(t)}),e.forEach(t=>this.activeViews.delete(t)),this.activeViews.forEach(t=>{t&&typeof t.refreshToolbar=="function"&&t.refreshToolbar()})}removeView(e){this.activeViews.delete(e)}};
