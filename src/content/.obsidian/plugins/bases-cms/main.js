/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ae=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var ze=Object.prototype.hasOwnProperty;var Ne=(a,i)=>()=>(a&&(i=a(a=0)),i);var de=(a,i)=>{for(var e in i)ae(a,e,{get:i[e],enumerable:!0})},We=(a,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of Ve(i))!ze.call(a,t)&&t!==e&&ae(a,t,{get:()=>i[t],enumerable:!(s=Ue(i,t))||s.enumerable});return a};var ue=a=>We(ae({},"__esModule",{value:!0}),a);var ye={};de(ye,{getCMSViewOptions:()=>qe,readCMSSettings:()=>R});function R(a,i){var e,s,t,n,r,o,l,c,h,f,d,p,u;return{titleProperty:a.get("titleProperty")||"title",descriptionProperty:a.get("descriptionProperty")||"description",imageProperty:a.get("imageProperty")||"image",showTitle:(e=a.get("showTitle"))!=null?e:!0,showDate:(s=a.get("showDate"))!=null?s:!1,dateProperty:a.get("dateProperty")||"date",showTextPreview:(t=a.get("showTextPreview"))!=null?t:!0,fallbackToContent:(n=a.get("fallbackToContent"))!=null?n:!0,fallbackToEmbeds:(r=a.get("fallbackToEmbeds"))!=null?r:!1,propertyDisplay1:a.get("propertyDisplay1")||"",propertyDisplay2:a.get("propertyDisplay2")||"",propertyDisplay3:a.get("propertyDisplay3")||"",propertyDisplay4:a.get("propertyDisplay4")||"",propertyLayout12SideBySide:(o=a.get("propertyLayout12SideBySide"))!=null?o:!1,propertyLayout34SideBySide:(l=a.get("propertyLayout34SideBySide"))!=null?l:!1,imageFormat:a.get("imageFormat")||"thumbnail",propertyLabels:a.get("propertyLabels")||"hide",showDraftStatus:(c=a.get("showDraftStatus"))!=null?c:!1,draftStatusProperty:a.get("draftStatusProperty")||"draft",draftStatusReverse:(h=a.get("draftStatusReverse"))!=null?h:!1,showTags:(f=a.get("showTags"))!=null?f:!1,tagsProperty:a.get("tagsProperty")||"",customizeNewButton:(d=a.get("customizeNewButton"))!=null?d:!1,newNoteLocation:a.get("newNoteLocation")||"",thumbnailCacheSize:i.thumbnailCacheSize,cardSize:(p=a.get("cardSize"))!=null?p:250,imageAspectRatio:(u=a.get("imageAspectRatio"))!=null?u:.55}}function qe(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:"title"},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:"date"},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:"draft"},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:"description"},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:"image"},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""}]}var ne=Ne(()=>{});var it={};de(it,{default:()=>ie});module.exports=ue(it);var Re=require("obsidian");var C=require("obsidian"),j=class extends C.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}display(){let{containerEl:e}=this;e.empty(),new C.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations").addToggle(s=>s.setValue(this.plugin.settings.confirmBulkOperations).onChange(async t=>{this.plugin.settings.confirmBulkOperations=t,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Deletions"}),new C.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder if the note filename matches the specified name").addToggle(s=>s.setValue(this.plugin.settings.deleteParentFolder).onChange(async t=>{this.plugin.settings.deleteParentFolder=t,await this.plugin.saveData(this.plugin.settings)})),new C.Setting(e).setName("Folder deletion filename").setDesc('Filename that triggers parent folder deletion (e.g., "index")').addText(s=>s.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(async t=>{this.plugin.settings.deleteParentFolderFilename=t,await this.plugin.saveData(this.plugin.settings)})).setDisabled(!this.plugin.settings.deleteParentFolder),new C.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(s=>s.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(async t=>{this.plugin.settings.deleteUniqueAttachments=t,await this.plugin.saveData(this.plugin.settings)})),new C.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files").addToggle(s=>s.setValue(this.plugin.settings.confirmDeletions).onChange(async t=>{this.plugin.settings.confirmDeletions=t,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Appearance"}),new C.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(s=>s.setValue(this.plugin.settings.useHomeIcon).onChange(async t=>{this.plugin.settings.useHomeIcon=t,await this.plugin.saveData(this.plugin.settings)})),e.createEl("h3",{text:"Performance"}),new C.Setting(e).setName("Thumbnail cache size").setDesc("Maximum size for generated thumbnails. Larger sizes provide better quality but use more memory. This setting caps the thumbnail size regardless of card size.").addDropdown(s=>s.addOption("minimal","Minimal (100x100, fastest)").addOption("small","Small (200x200)").addOption("balanced","Balanced (400x400, recommended)").addOption("large","Large (800x800)").addOption("unlimited","Unlimited (full resolution)").setValue(this.plugin.settings.thumbnailCacheSize).onChange(async t=>{this.plugin.settings.thumbnailCacheSize=t,await this.plugin.saveData(this.plugin.settings)}))}};var W=require("obsidian");function D(a,i){if(!i||!i.trim())return null;let e=i.split(",").map(s=>s.trim()).filter(s=>s);for(let s of e){let t=a.getValue(s),n=t;if(n&&("date"in n&&n.date instanceof Date||"data"in n))return t}return null}function ge(a,i){if(!i||!i.trim())return[];let e=i.split(",")[0].trim();if(!e)return[];let s=a.getValue(e);if(!s||!("data"in s))return[];let t=s.data,n=[];if(Array.isArray(t)){for(let r of t)if(typeof r=="string"||typeof r=="number"){let o=String(r);if(o&&o.trim()){n.push(o);break}}}else if(t!=null&&t!==""&&(typeof t=="string"||typeof t=="number")){let r=String(t);r.trim()&&n.push(r)}return n}function fe(a,i,e,s){if(!a||a==="")return"";if(e&&typeof e.getDisplayName=="function")try{let t=e.getDisplayName(a);if(t&&typeof t=="string"&&t.trim()!=="")return t}catch(t){}return a}function He(a,i,e,s,t,n,r){let o=a.file.basename||a.file.name,l=D(a,i.titleProperty),c=l==null?void 0:l.data,h=c!=null&&c!==""&&(typeof c=="string"||typeof c=="number")?String(c):o,f=a.file.path,d=f.split("/").slice(0,-1).join("/"),p=a.getValue("note.tags"),u=[];if(p&&p.data!=null){let y=p.data;u=(Array.isArray(y)?y.map(v=>v&&typeof v=="object"&&"data"in v?String(v.data):typeof v=="string"||typeof v=="number"?String(v):"").filter(v=>v):typeof y=="string"||typeof y=="number"?[String(y)]:[]).map(v=>v.replace(/^#/,""))}let m=a.getValue("file.tags"),g=[];if(m&&m.data!=null){let y=m.data;g=(Array.isArray(y)?y.map(v=>v&&typeof v=="object"&&v!==null&&"data"in v?String(v.data):typeof v=="string"||typeof v=="number"?String(v):"").filter(v=>typeof v=="string"&&v.length>0):typeof y=="string"||typeof y=="number"?[String(y)]:[]).map(v=>v.replace(/^#/,""))}let b=a.file.stat.ctime,E=a.file.stat.mtime,w=[];if(i.showTags&&i.tagsProperty){let y=D(a,i.tagsProperty);if(y&&y.data!=null){let k=y.data;Array.isArray(k)?w=k.map(v=>v&&typeof v=="object"&&"data"in v?String(v.data):typeof v=="string"||typeof v=="number"?String(v):"").filter(v=>typeof v=="string"&&v.length>0):(typeof k=="string"||typeof k=="number")&&(w=[String(k)])}}let S={path:f,name:o,title:h,tags:g,yamlTags:u,ctime:b,mtime:E,folderPath:d,snippet:t,imageUrl:n,hasImageAvailable:r||!1,displayTags:w.length>0?w:void 0},T=[i.propertyDisplay1,i.propertyDisplay2,i.propertyDisplay3,i.propertyDisplay4],x=new Set,P=T.map(y=>!y||y===""||x.has(y)?"":(x.add(y),y));return S.propertyName1=P[0]||void 0,S.propertyName2=P[1]||void 0,S.propertyName3=P[2]||void 0,S.propertyName4=P[3]||void 0,S.property1=P[0]?V(P[0],a,S,i):null,S.property2=P[1]?V(P[1],a,S,i):null,S.property3=P[2]?V(P[2],a,S,i):null,S.property4=P[3]?V(P[3],a,S,i):null,S}function me(a,i,e,s,t,n,r){return a.map(o=>He(o,i,e,s,t[o.file.path],n[o.file.path],r[o.file.path]))}function V(a,i,e,s){if(!a||a==="")return null;if(a==="file.path"||a==="file path")return e.folderPath||null;if(a==="tags"||a==="note.tags")return e.yamlTags.length>0?"tags":null;if(a==="file.tags"||a==="file tags")return e.tags.length>0?"tags":null;if(a==="file.ctime"||a==="created time")return new Date(e.ctime).toLocaleDateString();if(a==="file.mtime"||a==="modified time")return new Date(e.mtime).toLocaleDateString();let t=D(i,a);if(!t)return null;let n=t;if(!n)return null;if("date"in n&&n.date instanceof Date)return n.date.toLocaleDateString();let r=n.data;return r==null||r===""?null:Array.isArray(r)?r.length===0?null:r.map(o=>o&&typeof o=="object"&&"data"in o?String(o.data):String(o)).filter(o=>o&&o.trim()!=="").join(", "):typeof r=="string"||typeof r=="number"||typeof r=="boolean"?String(r):null}ne();function be(a){return/^https?:\/\//i.test(a)}function re(a){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(a)}function _e(a){let i=a.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return i?i[1].trim():a}function ve(a){let i=[],e=[];for(let s of a){let t=_e(s);t.length!==0&&(be(t)?(re(t)||!t.includes("."))&&e.push(t):re(t)&&i.push(t))}return{internalPaths:i,externalUrls:e}}async function we(a,i){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=i.metadataCache.getFileCache(a);if(!(s!=null&&s.embeds))return[];let t=[],n=[];for(let r of s.embeds){let o=r.link;if(be(o))(re(o)||!o.includes("."))&&n.push(o);else{let l=i.metadataCache.getFirstLinkpathDest(o,a.path);if(l&&e.includes(l.extension)){let c=i.vault.getResourcePath(l);t.push(c)}}}return[...t,...n]}var je=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function Ge(a){let i=new Map,e=0;return{text:a.replace(/\\(.)/g,(t,n)=>{let r=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return i.set(r,n),e++,r}),map:i}}function Ze(a,i){let e=a;return i.forEach((s,t)=>{e=e.split(t).join(s)}),e}function Ke(a){let i=a,e=!0;for(;e;){e=!1;let s=i.match(/^([`~]{3,})/m);if(!s)break;let t=s[1][0],n=s[1].length,r=s.index,o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`^${o}{${n}}\\s*$`,"m"),h=i.substring(r+s[1].length).match(l);if(h){let d=r+s[1].length+h.index+h[0].length;i=i.substring(0,r)+i.substring(d),e=!0}else{let f=i.indexOf(`
`,r);f===-1?i=i.substring(0,r):i=i.substring(0,r)+i.substring(f+1),e=!0}}return i}function Qe(a){if(!a||a.trim().length===0)return"";a=a.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),a=a.replace(/^>\s?/gm,"");let{text:i,map:e}=Ge(a),s=Ke(i);return je.forEach(t=>{s=s.replace(t,(n,...r)=>{if(n.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return r[1]||"";if(r.length>0&&r[0]!==void 0){for(let o=0;o<r.length-2;o++)if(typeof r[o]=="string")return r[o]}return""})}),s=Ze(s,e),s}function Xe(a,i=!1,e,s){let t=a.replace(/^---[\s\S]*?---/,"").trim(),n=Qe(t),r=n.indexOf(`
`),o=(r!==-1?n.substring(0,r):n).trim();(i||e&&o===e||s&&o===s)&&(n=r!==-1?n.substring(r+1).trim():"");let l=n.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(f=>f).join(" ").trim().replace(/\.{2,}/g,f=>f.replace(/\./g,"\u2024")),c=l.length>500,h=l.substring(0,500);return c&&(h+="\u2026"),h}async function Te(a,i,e,s,t,n){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(s.fallbackToContent){let o=await i.vault.cachedRead(a);return Xe(o,s.omitFirstLine,t,n)}return""}var G={minimal:{maxWidth:100,maxHeight:100,quality:.6},small:{maxWidth:200,maxHeight:200,quality:.7},balanced:{maxWidth:400,maxHeight:400,quality:.8},large:{maxWidth:800,maxHeight:800,quality:.9},unlimited:{maxWidth:1/0,maxHeight:1/0,quality:1}};function Se(a,i,e){if(e==="unlimited")return G.unlimited;let s=G[e];if(i==="cover"){let t=Math.ceil(a*2);return{maxWidth:Math.min(t,s.maxWidth),maxHeight:Math.min(t,s.maxHeight),quality:s.quality}}if(i==="thumbnail"){let n=a/250,r=Math.ceil(80*n*2);return{maxWidth:Math.min(r,s.maxWidth),maxHeight:Math.min(r,s.maxHeight),quality:s.quality}}return s}async function Ee(a,i,e,s){try{if(e==="unlimited"&&!s)return i.vault.getResourcePath(a);let t=s||G[e],n=await i.vault.readBinary(a),r=new Blob([n]),o=URL.createObjectURL(r);return new Promise((l,c)=>{let h=new Image;h.onload=()=>{try{let f=h.width,d=h.height;if(f>t.maxWidth||d>t.maxHeight){let g=f/d;f>d?(f=Math.min(f,t.maxWidth),d=f/g):(d=Math.min(d,t.maxHeight),f=d*g)}let p=document.createElement("canvas");p.width=f,p.height=d;let u=p.getContext("2d");if(!u){URL.revokeObjectURL(o),l(null);return}u.drawImage(h,0,0,f,d);let m=p.toDataURL("image/jpeg",t.quality);URL.revokeObjectURL(o),l(m)}catch(f){URL.revokeObjectURL(o),c(f)}},h.onerror=()=>{URL.revokeObjectURL(o),l(null)},h.src=o})}catch(t){return console.error(`Failed to generate thumbnail for ${a.path}:`,t),null}}async function xe(a,i,e){try{if(i==="unlimited"&&!e)return a;let s=e||G[i];return new Promise((t,n)=>{let r=new Image;r.crossOrigin="anonymous",r.onload=()=>{try{let o=r.width,l=r.height;if(o>s.maxWidth||l>s.maxHeight){let d=o/l;o>l?(o=Math.min(o,s.maxWidth),l=o/d):(l=Math.min(l,s.maxHeight),o=l*d)}let c=document.createElement("canvas");c.width=o,c.height=l;let h=c.getContext("2d");if(!h){t(null);return}h.drawImage(r,0,0,o,l);let f=c.toDataURL("image/jpeg",s.quality);t(f)}catch(o){n(o)}},r.onerror=()=>{t(null)},r.src=a})}catch(s){return console.error(`Failed to generate thumbnail from URL ${a}:`,s),null}}async function oe(a,i,e,s,t,n="balanced",r,o){for(let l of a)if(!(l.path in s))try{let{internalPaths:c,externalUrls:h}=ve(l.imagePropertyValues),f=[],d=["avif","bmp","gif","jpeg","jpg","png","svg","webp"];for(let b of c){let E=e.metadataCache.getFirstLinkpathDest(b,l.path);E&&d.includes(E.extension)&&f.push(E)}let p=[],u=r!==void 0&&o!==void 0?Se(r,o,n):void 0;for(let b of f)p.push(Ee(b,e,n,u));for(let b of h)p.push(xe(b,n,u));let g=(await Promise.all(p)).filter(b=>b!==null);g.length>0?(s[l.path]=g.length>1?g:g[0],t[l.path]=!0):i&&(t[l.path]=!1)}catch(c){console.error(`Failed to load image for ${l.path}:`,c)}}async function Pe(a,i,e,s){await Promise.all(a.map(async t=>{if(!(t.path in e||s[t.path]))try{let n=await we(t.file,i);n.length>0&&(e[t.path]=n.length>1?n:n[0],s[t.path]=!0)}catch(n){console.error(`Failed to load embed images for ${t.path}:`,n)}}))}async function ke(a,i,e,s,t){await Promise.all(a.map(async n=>{if(!(n.path in t))try{n.file.extension==="md"?t[n.path]=await Te(n.file,s,n.descriptionData,{fallbackToContent:i,omitFirstLine:e},n.fileName,n.titleString):t[n.path]=""}catch(r){console.error(`Failed to load snippet for ${n.path}:`,r),t[n.path]=""}}))}var q=require("obsidian");var Z=class{constructor(i,e,s,t,n,r){this.app=i;this.plugin=e;this.propertyObservers=s;this.updateLayoutRef=t;this.basesConfig=n,this.basesController=r}renderCard(i,e,s,t,n,r,o,l){let c=i.createDiv("card bases-cms-card");t.imageFormat==="cover"?c.classList.add("image-format-cover"):t.imageFormat==="thumbnail"&&c.classList.add("image-format-thumbnail"),c.setAttribute("data-path",e.path),c.setAttribute("data-href",e.path),c.style.cursor="pointer";let h=c.createDiv("bases-cms-select-checkbox"),f=h.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(f.checked=r,f.addEventListener("change",d=>{d.stopPropagation(),d.stopImmediatePropagation(),o(e.path,f.checked)}),f.addEventListener("click",d=>{d.stopPropagation(),d.stopImmediatePropagation()}),t.showDraftStatus&&t.draftStatusProperty&&t.imageFormat!=="cover"){let d=D(s,t.draftStatusProperty);if(d){let p=d;if(p&&"data"in p&&typeof p.data=="boolean"){let u=p.data,m=t.draftStatusReverse?!u:u,g=c.createDiv("card-status-badge");m?(g.addClass("status-draft"),g.appendText("Draft")):(g.addClass("status-published"),g.appendText("Published")),l&&(g.style.cursor="pointer",g.addEventListener("click",async b=>{b.stopPropagation();let E=!u,w=t.draftStatusProperty.startsWith("note.")?t.draftStatusProperty.substring(5):t.draftStatusProperty;await l(e.path,w,E)}))}}}if(c.addEventListener("click",d=>{let p=d.target;if(h.contains(p)||p.tagName==="INPUT"||p.closest("input")||p.closest(".bases-cms-property")||p.closest(".card-status-badge"))return;let u=d.metaKey||d.ctrlKey;this.app.workspace.openLinkText(e.path,"",u)}),c.addEventListener("contextmenu",d=>{let p=d.target;if(h.contains(p)||p.tagName==="INPUT"||p.closest("input")||p.closest(".bases-cms-property")||p.closest(".card-status-badge"))return;let u=this.app.vault.getAbstractFileByPath(e.path);if(u&&u instanceof q.TFile){d.stopPropagation();let m=new q.Menu;this.app.workspace.trigger("file-menu",m,u,"bases"),m.showAtMouseEvent(d)}}),t.showTitle&&c.createDiv("card-title").appendText(e.title),t.showDate&&t.dateProperty){let d=D(s,t.dateProperty);if(d){let p=d,u="";if(p&&"date"in p&&p.date instanceof Date)u=p.date.toLocaleDateString();else if(p&&"data"in p&&p.data){let m=p.data;if(m instanceof Date)u=m.toLocaleDateString();else if(typeof m=="string"||typeof m=="number"){let g=new Date(m);isNaN(g.getTime())?u=String(m):u=g.toLocaleDateString()}}u&&c.createDiv("card-date").appendText(u)}}if(t.showTextPreview&&e.snippet||t.showTags&&e.displayTags&&e.displayTags.length>0||t.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||t.imageFormat==="cover"){let d=c.createDiv("card-content");if(t.imageFormat==="thumbnail"){let p=d.createDiv("card-text-wrapper");if(t.showTextPreview&&e.snippet&&p.createDiv({cls:"card-text-preview",text:e.snippet}),t.showTags&&e.displayTags&&e.displayTags.length>0){let u=p.createDiv("card-tags"),m=3,g=e.displayTags.slice(0,m),b=e.displayTags.length-m;g.forEach(E=>{u.createSpan("card-tag").appendText(E)}),b>0&&u.createSpan("card-tag-more").appendText(`+${b} more`)}}else if(t.showTextPreview&&e.snippet&&d.createDiv({cls:"card-text-preview",text:e.snippet}),t.showTags&&e.displayTags&&e.displayTags.length>0){let p=d.createDiv("card-tags"),u=3,m=e.displayTags.slice(0,u),g=e.displayTags.length-u;m.forEach(b=>{p.createSpan("card-tag").appendText(b)}),g>0&&p.createSpan("card-tag-more").appendText(`+${g} more`)}if(t.imageFormat!=="none"&&e.imageUrl){let u=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(b=>b&&typeof b=="string"&&b.trim().length>0),m=t.imageFormat==="cover"?"card-cover":"card-thumbnail",g=d.createDiv(m);if(t.showDraftStatus&&t.draftStatusProperty&&t.imageFormat==="cover"){let b=D(s,t.draftStatusProperty);if(b){let E=b;if(E&&"data"in E&&typeof E.data=="boolean"){let w=E.data,S=t.draftStatusReverse?!w:w,T=g.createDiv("card-status-badge");S?(T.addClass("status-draft"),T.appendText("Draft")):(T.addClass("status-published"),T.appendText("Published")),l&&(T.style.cursor="pointer",T.addEventListener("click",async x=>{x.stopPropagation();let P=!w,y=t.draftStatusProperty.startsWith("note.")?t.draftStatusProperty.substring(5):t.draftStatusProperty;await l(e.path,y,P)}))}}}if(u.length>0){let b=g.createDiv("image-embed"),E=b.createEl("img",{attr:{alt:"",decoding:"async",sizes:t.imageFormat==="cover"?"100vw":"80px"}});return b.style.setProperty("--cover-image-url",`url("${u[0]}")`),{img:E,src:u[0]}}}else if(t.imageFormat!=="none"){let p=t.imageFormat==="cover"?"card-cover-placeholder":"card-thumbnail-placeholder";d.createDiv(p)}}return this.renderProperties(c,e,s,t,l),null}renderProperties(i,e,s,t,n){let r=[t.propertyDisplay1,t.propertyDisplay2,t.propertyDisplay3,t.propertyDisplay4],o=new Set,l=r.map(p=>!p||p===""||o.has(p)?"":(o.add(p),p)),c=l.map(p=>p?V(p,s,e,t):null),h=l[0]!==""||l[1]!=="",f=l[2]!==""||l[3]!=="";if(!h&&!f)return;let d=i.createDiv("card-properties properties-4field");if(h){let p=d.createDiv("property-row property-row-1");t.propertyLayout12SideBySide&&p.addClass("property-row-side-by-side");let u=p.createDiv("property-field property-field-1");l[0]&&this.renderPropertyContent(u,l[0],c[0],e,s,t,n);let m=p.createDiv("property-field property-field-2");l[1]&&this.renderPropertyContent(m,l[1],c[1],e,s,t,n)}if(f){let p=d.createDiv("property-row property-row-2");t.propertyLayout34SideBySide&&p.addClass("property-row-side-by-side");let u=p.createDiv("property-field property-field-3");l[2]&&this.renderPropertyContent(u,l[2],c[2],e,s,t,n);let m=p.createDiv("property-field property-field-4");l[3]&&this.renderPropertyContent(m,l[3],c[3],e,s,t,n)}}renderPropertyContent(i,e,s,t,n,r,o){if(e===""||!s&&r.propertyLabels==="hide"||r.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&t.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&t.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&t.folderPath.length===0))return;let l=fe(e,this.app,this.basesConfig,this.basesController),c=l.toLowerCase()!==e.toLowerCase();if(r.propertyLabels==="above"){let d=i.createDiv("property-label");c&&d.addClass("property-label-custom"),d.textContent=l}let h=i.createDiv("property-content");if(r.propertyLabels==="inline"){let d=h.createSpan("property-label-inline");d.textContent=l+": "}if(!s){h.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")h.createSpan().appendText(s);else if((e==="tags"||e==="note.tags")&&t.yamlTags.length>0){let d=h.createDiv("tags-wrapper");t.yamlTags.forEach(p=>{d.createEl("a",{cls:"tag",text:p,href:"#"}).addEventListener("click",m=>{var b,E,w;m.preventDefault();let g=(E=(b=this.app.internalPlugins)==null?void 0:b.plugins)==null?void 0:E["global-search"];(w=g==null?void 0:g.instance)!=null&&w.openGlobalSearch&&g.instance.openGlobalSearch("tag:"+p)})})}else if((e==="file.tags"||e==="file tags")&&t.tags.length>0){let d=h.createDiv("tags-wrapper");t.tags.forEach(p=>{d.createEl("a",{cls:"tag",text:p,href:"#"}).addEventListener("click",m=>{var b,E,w;m.preventDefault();let g=(E=(b=this.app.internalPlugins)==null?void 0:b.plugins)==null?void 0:E["global-search"];(w=g==null?void 0:g.instance)!=null&&w.openGlobalSearch&&g.instance.openGlobalSearch("tag:"+p)})})}else if((e==="file.path"||e==="path"||e==="file path")&&t.path.length>0){let d=h.createDiv("path-wrapper"),p=t.path.split("/").filter(u=>u);p.forEach((u,m)=>{let g=d.createSpan(),b=m===p.length-1,E=b?"path-segment filename-segment":"path-segment file-path-segment";g.createSpan({cls:E,text:u}).addEventListener("click",S=>{if(S.stopPropagation(),b){let T=this.app.vault.getAbstractFileByPath(t.path);T instanceof q.TFile&&this.app.workspace.getLeaf(!1).openFile(T)}}),m<p.length-1&&g.createSpan({cls:"path-separator",text:"/"})})}else{let d=this.app.metadataCache,u=((typeof d.getAllPropertyInfos=="function"?d.getAllPropertyInfos():{})||{})[e.toLowerCase()],m=n.getValue(e);if(((u==null?void 0:u.widget)==="checkbox"||m&&"data"in m&&typeof m.data=="boolean")&&o){let b=h.createEl("input",{type:"checkbox",cls:"checkbox-input"});b.checked=m&&"data"in m?Boolean(m.data):!1;let E=e.startsWith("note.")?e.substring(5):e;h.createSpan({cls:"checkbox-label",text:E}),b.addEventListener("click",w=>{w.stopPropagation()}),b.addEventListener("change",async w=>{w.stopPropagation();try{let S=e.startsWith("note.")?e.substring(5):e;await o(t.path,S,b.checked)}catch(S){console.error("Error toggling property:",S),b.checked=!b.checked}})}else h.createDiv("text-wrapper").appendText(s)}(!h.textContent||h.textContent.trim().length===0)&&h.remove()}};var M=require("obsidian");async function le(a,i,e,s){await a.fileManager.processFrontMatter(i,t=>{for(let[n,r]of e){if(n==="tags"&&!t.hasOwnProperty("tags")&&!Array.isArray(r.data)){t[n]=[r.data];continue}if(!t[n]||s){t[n]=r.data;continue}let o=r.type,l=t[n],c=Array.isArray(l)?"list":typeof l=="number"?"number":typeof l=="boolean"?"checkbox":"text";if(Ye(o,c)){if(t[n]===r.data||!r.data)continue;let h=Je(t[n],r.data);t[n]=h;continue}else{t[n]=r.data;continue}}})}async function Ce(a,i,e){await a.fileManager.processFrontMatter(i,s=>{for(let t of e)s[t]=void 0})}function Ye(a,i){let e=["number","date","datetime","checkbox"];return!(e.includes(a)||e.includes(i))}function Je(...a){let e=a.map(t=>Array.isArray(t)?t:[t]).flat();return[...new Set(e)]}var F=class{constructor(i){this.app=i}async setDraft(i,e){await this.batchProcessFiles(i,async s=>{await this.app.fileManager.processFrontMatter(s,t=>{t.draft=e})}),new M.Notice(`Set ${i.length} file${i.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(i,e){let s=new Map;s.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(i,async t=>{await le(this.app,t,s,!1)}),new M.Notice(`Added tags to ${i.length} file${i.length!==1?"s":""}`)}async removeTags(i,e){await this.batchProcessFiles(i,async s=>{let t=this.app.metadataCache.getFileCache(s),n=t==null?void 0:t.frontmatter;if(n!=null&&n.tags){let o=(Array.isArray(n.tags)?n.tags:[n.tags]).filter(l=>!e.includes(l));await this.app.fileManager.processFrontMatter(s,l=>{o.length>0?l.tags=o:l.tags=void 0})}}),new M.Notice(`Removed tags from ${i.length} file${i.length!==1?"s":""}`)}async setProperty(i,e,s,t="text"){let n=e.startsWith("note.")?e.substring(5):e,r=new Map;r.set(n,{type:t,data:s,overwrite:!0,delimiter:","}),await this.batchProcessFiles(i,async o=>{await le(this.app,o,r,!0)}),new M.Notice(`Set ${n} on ${i.length} file${i.length!==1?"s":""}`)}async removeProperty(i,e){let s=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(i,async t=>{await Ce(this.app,t,[s])}),new M.Notice(`Removed ${s} from ${i.length} file${i.length!==1?"s":""}`)}async batchProcessFiles(i,e){let s=0,t=i.length;for(let n of i){let r=this.app.vault.getAbstractFileByPath(n);if(r instanceof M.TFile)try{await e(r),s++}catch(o){console.error(`Error processing ${n}:`,o)}}s<t&&new M.Notice(`Processed ${s} of ${t} files`)}};var $=require("obsidian");var K=class extends $.Modal{constructor(e,s){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=s,this.bulkOps=new F(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Manage Tags"}),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new $.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated)").addText(l=>{l.setPlaceholder("tag1, tag2, tag3").onChange(c=>{this.tagsToAdd=c})}),e.createEl("h3",{text:"Remove tags"});let s=e.createDiv(),t=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof $.TFile){let h=this.app.metadataCache.getFileCache(c),f=h==null?void 0:h.frontmatter;f!=null&&f.tags&&(Array.isArray(f.tags)?f.tags:[f.tags]).forEach(p=>t.add(p))}}for(let l of Array.from(t).sort())new $.Setting(s).setName(l).addToggle(c=>{c.setValue(this.tagsToRemove.has(l)).onChange(h=>{h?this.tagsToRemove.add(l):this.tagsToRemove.delete(l)})});let n=e.createDiv();n.style.display="flex",n.style.gap="0.5rem",n.style.justifyContent="flex-end",n.style.marginTop="1rem";let r=n.createEl("button");r.setText("Cancel"),r.addEventListener("click",()=>this.close());let o=n.createEl("button");o.setText("Apply"),o.addClass("mod-cta"),o.addEventListener("click",async()=>{await this.applyChanges(),this.close()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(s=>s.trim()).filter(s=>s.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var z=require("obsidian");var Q=class extends z.Modal{constructor(e,s){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=s,this.bulkOps=new F(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Set Property"}),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new z.Setting(e).setName("Property name").setDesc("Enter the property name to set").addText(r=>{r.setPlaceholder("e.g., status, category, priority").onChange(o=>{this.propertyName=o})}),new z.Setting(e).setName("Property type").setDesc("Select the property type").addDropdown(r=>{r.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(o=>{this.propertyType=o})}),new z.Setting(e).setName("Property value").setDesc("Enter the property value").addText(r=>{r.setPlaceholder("Enter value").onChange(o=>{this.propertyValue=o})});let s=e.createDiv();s.style.display="flex",s.style.gap="0.5rem",s.style.justifyContent="flex-end",s.style.marginTop="1rem";let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let n=s.createEl("button");n.setText("Apply"),n.addClass("mod-cta"),n.addEventListener("click",async()=>{this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close())})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var N=require("obsidian");var X=class extends N.Modal{constructor(e,s){super(e);this.propertiesToRemove=new Set;this.files=s,this.bulkOps=new F(e)}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Remove Property"}),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let s=new Set;for(let l of this.files){let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof N.TFile){let h=this.app.metadataCache.getFileCache(c),f=h==null?void 0:h.frontmatter;if(f)for(let d in f)d!=="tags"&&d!=="title"&&s.add(d)}}let t=e.createDiv();for(let l of Array.from(s).sort())new N.Setting(t).setName(l).addToggle(c=>{c.setValue(this.propertiesToRemove.has(l)).onChange(h=>{h?this.propertiesToRemove.add(l):this.propertiesToRemove.delete(l)})});s.size===0&&e.createEl("p",{text:"No properties found in selected files."});let n=e.createDiv();n.style.display="flex",n.style.gap="0.5rem",n.style.justifyContent="flex-end",n.style.marginTop="1rem";let r=n.createEl("button");r.setText("Cancel"),r.addEventListener("click",()=>this.close());let o=n.createEl("button");o.setText("Apply"),o.addClass("mod-cta"),o.addEventListener("click",async()=>{this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close())})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var Me=require("obsidian");var I=require("obsidian");var U=require("obsidian");function De(a,i){let e=[],s=a.vault.getAbstractFileByPath(i.path);if(s instanceof U.TFile){let t=a.metadataCache.getFileCache(s),n=(t==null?void 0:t.embeds)||[];for(let r of n){let o=a.metadataCache.getFirstLinkpathDest(r.link,i.path);o instanceof U.TFile&&e.push(o)}}return e}function Fe(a,i){let e=[];for(let s of i.children)s instanceof U.TFile&&s.extension==="md"?e.push(...De(a,s)):s instanceof U.TFolder&&e.push(...Fe(a,s));return e}async function et(a,i,e,s){let t=a.vault.getMarkdownFiles().filter(l=>l.path!==e.path),n=i.path,r=i.name,o=i.basename;for(let l of t){if(s&&l.path.startsWith(s.path+"/"))continue;let c=await a.vault.read(l);if(c.includes(n)||c.includes(r)||c.includes(o)||c.includes(`![[${r}]]`)||c.includes(`[[${r}]]`)||c.includes(`(${r})`)||c.includes(`(${n})`))return!0}return!1}async function Ae(a,i,e){let s=[];s.push(...De(a,i)),e&&s.push(...Fe(a,e));let t=Array.from(new Set(s.map(r=>r.path))).map(r=>a.vault.getAbstractFileByPath(r)).filter(r=>r instanceof U.TFile),n=[];for(let r of t)await et(a,r,i,e)||n.push(r);return n}function tt(a,i){let e=i.deleteParentFolderFilename||"index";return a.basename===e&&a.parent!==null}function Le(a,i){return i.deleteParentFolder&&tt(a,i)}async function ce(a,i,e){let s=[],t=[],n=[];for(let l of i){let c=a.vault.getAbstractFileByPath(l);if(c instanceof I.TFile){if(Le(c,e)){let h=c.parent;if(h&&!t.includes(h)){t.push(h);let f=h.children.filter(d=>d instanceof I.TFile);s.push(...f)}}else s.push(c);if(e.deleteUniqueAttachments){let h=Le(c,e)&&c.parent||void 0,f=await Ae(a,c,h);n.push(...f)}}}let r=Array.from(new Set(s.map(l=>l.path))).map(l=>a.vault.getAbstractFileByPath(l)).filter(l=>l instanceof I.TFile),o=Array.from(new Set(n.map(l=>l.path))).map(l=>a.vault.getAbstractFileByPath(l)).filter(l=>l instanceof I.TFile);return{filesToDelete:r,foldersToDelete:Array.from(new Set(t)),attachmentsToDelete:o}}async function Y(a,i){let e=0,s=0;for(let t of i.filesToDelete)try{await a.vault.delete(t),e++}catch(n){console.error(`Error deleting file ${t.path}:`,n),s++}for(let t of i.attachmentsToDelete)try{await a.vault.delete(t),e++}catch(n){console.error(`Error deleting attachment ${t.path}:`,n),s++}for(let t of i.foldersToDelete)try{await a.vault.delete(t,!0),e++}catch(n){console.error(`Error deleting folder ${t.path}:`,n),s++}s>0?new I.Notice(`Deleted ${e} items, ${s} errors occurred`):new I.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var J=class extends Me.Modal{constructor(e,s,t){super(e);this.preview=s,this.onConfirm=t}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Confirm Deletion"}),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let r=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let o of this.preview.filesToDelete.slice(0,20))r.createEl("li").setText(o.path);this.preview.filesToDelete.length>20&&r.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let r=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let o of this.preview.foldersToDelete)r.createEl("li").setText(o.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let r=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let o of this.preview.attachmentsToDelete.slice(0,20))r.createEl("li").setText(o.path);this.preview.attachmentsToDelete.length>20&&r.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"\u26A0\uFE0F This action cannot be undone!",cls:"bases-cms-deletion-warning"});let s=e.createDiv();s.style.display="flex",s.style.gap="0.5rem",s.style.justifyContent="flex-end",s.style.marginTop="1rem";let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let n=s.createEl("button");n.setText("Delete"),n.addClass("mod-cta"),n.addClass("destructive"),n.addEventListener("click",async()=>{await Y(this.app,this.preview),this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var Be=require("obsidian"),_=class extends Be.Modal{constructor(e,s,t,n){super(e);this.files=s,this.operation=t,this.onConfirm=n}onOpen(){let{contentEl:e}=this;e.empty();let s=this.operation==="draft"?"mark as draft":"mark as published";if(e.createEl("h2",{text:`Confirm ${s.charAt(0).toUpperCase()+s.slice(1)}`}),e.createEl("p",{text:`Are you sure you want to ${s} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let o=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let l of this.files.slice(0,20))o.createEl("li").setText(l);this.files.length>20&&o.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let t=e.createDiv();t.style.display="flex",t.style.gap="0.5rem",t.style.justifyContent="flex-end",t.style.marginTop="1rem";let n=t.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=t.createEl("button");r.setText("Confirm"),r.addClass("mod-cta"),r.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var ee=class{constructor(i,e,s,t,n,r,o){this.app=i;this.plugin=e;this.container=s;this.getSelectedFiles=t;this.clearSelection=n;this.refreshView=r;this.toolbarEl=null;this.countEl=null;this.bulkOps=new F(i),this.selectAllCallback=o,this.createToolbar()}createToolbar(){this.toolbarEl=this.container.createDiv("bases-cms-bulk-toolbar"),this.toolbarEl.style.display="none",this.countEl=this.toolbarEl.createDiv("selected-count"),this.countEl.setText("0 items selected");let i=this.toolbarEl.createDiv();i.style.display="flex",i.style.gap="0.5rem",i.style.marginLeft="auto",i.style.flexWrap="wrap",i.style.minWidth="0",i.style.flex="1 1 auto",i.style.justifyContent="flex-end";let e=i.createEl("button");e.setText("Select all"),e.addEventListener("click",()=>this.handleSelectAll());let s=i.createEl("button");s.setText("Clear selection"),s.addEventListener("click",()=>this.clearSelection());let t=i.createDiv();t.style.width="1px",t.style.height="20px",t.style.backgroundColor="var(--background-modifier-border)",t.style.margin="0 0.25rem";let n=i.createEl("button");n.setText("Mark draft"),n.addEventListener("click",()=>this.handleSetDraft());let r=i.createEl("button");r.setText("Mark published"),r.addEventListener("click",()=>this.handlePublish());let o=i.createEl("button");o.setText("Manage tags"),o.addEventListener("click",()=>this.handleManageTags());let l=i.createEl("button");l.setText("Set property"),l.addEventListener("click",()=>this.handleSetProperty());let c=i.createEl("button");c.setText("Remove property"),c.addEventListener("click",()=>this.handleRemoveProperty());let h=i.createEl("button");h.setText("Delete"),h.addClass("destructive"),h.addEventListener("click",()=>this.handleDelete())}updateCount(i){this.countEl&&this.countEl.setText(`${i} item${i!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){this.toolbarEl&&(this.toolbarEl.style.display="flex")}hide(){this.toolbarEl&&(this.toolbarEl.style.display="none")}async handleSetDraft(){let i=this.getSelectedFiles();i.length!==0&&(this.plugin.settings.confirmBulkOperations?new _(this.app,i,"draft",async()=>{await this.bulkOps.setDraft(i,!0),this.refreshView()}).open():(await this.bulkOps.setDraft(i,!0),this.refreshView()))}async handlePublish(){let i=this.getSelectedFiles();i.length!==0&&(this.plugin.settings.confirmBulkOperations?new _(this.app,i,"publish",async()=>{await this.bulkOps.setDraft(i,!1),this.refreshView()}).open():(await this.bulkOps.setDraft(i,!1),this.refreshView()))}async handleManageTags(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new K(this.app,i);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleSetProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new Q(this.app,i);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleRemoveProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new X(this.app,i);e.onClose=()=>{this.show(),this.refreshView()},e.open()}async handleDelete(){let i=this.getSelectedFiles();if(i.length!==0)if(this.plugin.settings.confirmDeletions){let e=await ce(this.app,i,this.plugin.settings);new J(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await ce(this.app,i,this.plugin.settings);await Y(this.app,e),this.clearSelection(),this.refreshView()}}destroy(){this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};var te="bases-cms",se=class extends W.BasesView{constructor(e,s,t){super(e);this.type=te;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.displayedCount=50;this.isLoading=!1;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.containerEl=s,this.plugin=t,this.cardRenderer=new Z(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container"),this.containerEl.style.overflowY="auto",this.containerEl.style.overflowX="hidden",this.containerEl.style.height="100%";let n=this.app.isMobile;this.displayedCount=n?25:50,this.setupNewNoteInterceptor()}setupNewNoteInterceptor(){let e=async r=>{var p,u,m,g,b;let o=r.target,l=o.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!l||o.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;console.log("[CMS View] New button clicked!",l);let c=this.app.workspace.getLeavesOfType(te).find(E=>{let w=E.view;return w&&w.containerEl===this.containerEl}),h=this.app.workspace.activeLeaf;if(!(c&&h&&c===h)){console.log("[CMS View] Not our active view, skipping. Active leaf:",h,"Our leaf:",c);return}let d=R(this.config,this.plugin.settings);if(console.log("[CMS View] Settings:",{customizeNewButton:d.customizeNewButton,newNoteLocation:d.newNoteLocation}),d.customizeNewButton){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();let E=((p=d.newNoteLocation)==null?void 0:p.trim())||"";if(E===""){console.log("[CMS View] Using Obsidian default new note location");let w=((m=(u=this.app.vault)==null?void 0:u.getConfig)==null?void 0:m.call(u,"newFileLocation"))||"folder",S=((b=(g=this.app.vault)==null?void 0:g.getConfig)==null?void 0:b.call(g,"newFileFolderPath"))||"",T=w==="folder"&&S?S:"";if(T){let x=await this.app.vault.create(`${T}/Untitled.md`,"");await this.app.workspace.openLinkText(x.path,"",!1)}else{let x=await this.app.vault.create("Untitled.md","");await this.app.workspace.openLinkText(x.path,"",!1)}return}if(E==="/"){console.log("[CMS View] Creating note in vault root");try{let w=await this.app.vault.create("Untitled.md","");await this.app.workspace.openLinkText(w.path,"",!1)}catch(w){console.error("[CMS View] Error creating new note:",w)}return}console.log("[CMS View] Intercepting and creating note in:",E);try{let w=E.replace(/^\/+|\/+$/g,"");console.log("[CMS View] Folder path:",w);let S=this.app.vault.getAbstractFileByPath(w);if((!S||!("children"in S))&&(console.log("[CMS View] Folder does not exist, creating:",w),await this.app.vault.createFolder(w),S=this.app.vault.getAbstractFileByPath(w)),S&&"children"in S){let T=await this.app.vault.create(`${w}/Untitled.md`,"");console.log("[CMS View] Created new file:",T.path),await this.app.workspace.openLinkText(T.path,"",!1)}else console.error("[CMS View] Failed to create or access folder:",w)}catch(w){console.error("[CMS View] Error creating new note:",w)}}else console.log("[CMS View] Custom new button not enabled")},s=r=>{let o=r.target,l=o.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!l||o.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let c=this.app.workspace.activeLeaf,h=c==null?void 0:c.view,f=c==null?void 0:c.containerEl;if(!(h&&(h.containerEl===this.containerEl||h===this||l.closest(".workspace-leaf")===f)))return;let p=R(this.config,this.plugin.settings);p.customizeNewButton&&(r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),(async()=>{var b,E,w;let u=((b=p.newNoteLocation)==null?void 0:b.trim())||"";if(u===""){let S=this.app.vault,T=((E=S.getConfig)==null?void 0:E.call(S,"newFileLocation"))||"folder",x=((w=S.getConfig)==null?void 0:w.call(S,"newFileFolderPath"))||"",P=T==="folder"&&x?x:"";if(P){let y=await this.app.vault.create(`${P}/Untitled.md`,"");await this.app.workspace.openLinkText(y.path,"",!1)}else{let y=await this.app.vault.create("Untitled.md","");await this.app.workspace.openLinkText(y.path,"",!1)}return}if(u==="/"){let S=await this.app.vault.create("Untitled.md","");await this.app.workspace.openLinkText(S.path,"",!1);return}let m=u.replace(/^\/+|\/+$/g,""),g=this.app.vault.getAbstractFileByPath(m);if((!g||!("children"in g))&&(await this.app.vault.createFolder(m),g=this.app.vault.getAbstractFileByPath(m)),g&&"children"in g){let S=await this.app.vault.create(`${m}/Untitled.md`,"");await this.app.workspace.openLinkText(S.path,"",!1)}})())};document.addEventListener("click",s,!0),new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(o=>{o.__cmsIntercepted||(o.__cmsIntercepted=!0,o.addEventListener("click",s,!0))})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(r=>{r.__cmsIntercepted||(r.__cmsIntercepted=!0,r.addEventListener("click",s,!0))})}onDataUpdated(){(async()=>{var S;let e=this.data.groupedData,s=this.data.data;this.cardRenderer.basesConfig=this.config;let t=R(this.config,this.plugin.settings),n=this.containerEl.clientWidth,r=t.cardSize,o=1,l=8,c=Math.max(o,Math.floor((n+l)/(r+l))),h=(n-l*(c-1))/c;this.containerEl.style.setProperty("--card-min-width",`${h}px`),this.containerEl.style.setProperty("--grid-columns",String(c)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(t.imageAspectRatio));let f=this.containerEl.scrollTop,d=this.getSortMethod(),p=e.map(T=>({group:T,entries:[...T.entries]})),u=[],m=this.displayedCount;for(let T of p){if(m<=0)break;let x=Math.min(T.entries.length,m);u.push(...T.entries.slice(0,x)),m-=x}if(t.imageFormat!=="none"){let T=s.filter(y=>!(y.file.path in this.images)).map(y=>{let k=this.app.vault.getAbstractFileByPath(y.file.path);if(!(k instanceof W.TFile))return null;let v=ge(y,t.imageProperty);return{path:y.file.path,file:k,imagePropertyValues:v}}).filter(y=>y!==null),x=T.filter(y=>u.some(k=>k.file.path===y.path)),P=T.filter(y=>!u.some(k=>k.file.path===y.path));if(x.length>0&&await oe(x,t.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable,t.thumbnailCacheSize,t.cardSize,t.imageFormat),P.length>0&&oe(P,t.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable,t.thumbnailCacheSize,t.cardSize,t.imageFormat),t.fallbackToEmbeds){let y=T.filter(k=>!(k.path in this.images)&&!this.hasImageAvailable[k.path]);y.length>0&&Pe(y,this.app,this.images,this.hasImageAvailable).then(()=>{y.forEach(k=>{var v;if(k.path in this.images){let A=this.containerEl.querySelector(`.card[data-path="${k.path}"]`);if(A){let O=this.images[k.path],L=Array.isArray(O)?O[0]:O;if(L){let H=A.querySelector("img");if(H){if(H.src!==L){H.src=L;let B=H.parentElement;B&&B.classList.contains("image-embed")&&B.style.setProperty("--cover-image-url",`url("${L}")`)}}else{let B=A.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(B){let $e=B.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",pe=(v=B.parentElement)==null?void 0:v.createDiv($e);if(pe){let he=pe.createDiv("image-embed");H=he.createEl("img",{attr:{src:L,alt:"",decoding:"async"}}),he.style.setProperty("--cover-image-url",`url("${L}")`),B.remove()}}}}}}})})}}if(t.showTextPreview){let T=u.filter(x=>!(x.file.path in this.snippets)).map(x=>{let P=this.app.vault.getAbstractFileByPath(x.file.path);if(!(P instanceof W.TFile))return null;let y=D(x,t.descriptionProperty);return{path:x.file.path,file:P,descriptionData:y==null?void 0:y.data}}).filter(x=>x!==null);ke(T,t.fallbackToContent,!1,this.app,this.snippets)}let g=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let T=this.containerEl.querySelector(".bases-cms-bulk-toolbar");T&&(g=T,g.remove())}this.containerEl.empty(),this.propertyObservers.forEach(T=>T.disconnect()),this.propertyObservers=[];let b=this.containerEl.createDiv("bases-cms-grid"),E=0,w=[];for(let T of p){if(E>=this.displayedCount)break;let x=Math.min(T.entries.length,this.displayedCount-E);if(x===0)continue;let P=T.entries.slice(0,x),y=b.createDiv("bases-cms-group");if(T.group.hasKey()){let A=y.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),O=((S=T.group.key)==null?void 0:S.toString())||"";A.setText(O)}let k=me(P,t,d,!1,this.snippets,this.images,this.hasImageAvailable);for(let v=0;v<k.length;v++){let A=k[v],O=P[v],L=this.renderCard(y,A,O,E+v,t);L&&w.push(L)}E+=x}w.length>0&&requestAnimationFrame(()=>{for(let{img:T,src:x}of w)T.src=x}),f>0&&(this.containerEl.scrollTop=f),this.setupInfiniteScroll(s.length),this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>{let T=this.containerEl.clientWidth,x=R(this.config,this.plugin.settings),P=x.cardSize,y=1,k=8,v=Math.max(y,Math.floor((T+k)/(P+k))),A=(T-k*(v-1))/v;this.containerEl.style.setProperty("--card-min-width",`${A}px`),this.containerEl.style.setProperty("--grid-columns",String(v)),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(x.imageAspectRatio))}),this.resizeObserver.observe(this.containerEl)),g&&this.bulkToolbar&&(this.containerEl.appendChild(g),this.bulkToolbar.toolbarEl=g),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(x=>{let P=x.getAttribute("data-path"),y=x.querySelector('input[type="checkbox"].selection-checkbox');if(P){let k=this.selectedFiles.has(P);k?x.addClass("selected"):x.removeClass("selected"),y&&(y.checked=k)}}),g&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.isLoading=!1})()}renderCard(e,s,t,n,r){let o=this.selectedFiles.has(s.path);return this.cardRenderer.renderCard(e,s,t,r,this,o,(l,c)=>{this.handleSelectionChange(l,c)},(l,c,h)=>{this.handlePropertyToggle(l,c,h)})}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let s=e[0],t=s.property,n=s.direction.toLowerCase();if(t.includes("ctime"))return`ctime-${n}`;if(t.includes("mtime"))return`mtime-${n}`}return"mtime-desc"}setupInfiniteScroll(e){this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=e)&&(this.scrollListener=()=>{if(this.scrollThrottleTimeout!==null||this.isLoading)return;let s=this.containerEl.scrollTop,t=this.containerEl.scrollHeight,n=this.containerEl.clientHeight,r=t-(s+n),l=this.app.isMobile?1:2,c=n*l;if(r<c&&this.displayedCount<e){this.isLoading=!0;let h=50;this.displayedCount=Math.min(this.displayedCount+h,e),this.onDataUpdated()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.register(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}handleSelectionChange(e,s){s?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI()}async handlePropertyToggle(e,s,t){try{let n=this.app.vault.getAbstractFileByPath(e);if(!(n instanceof W.TFile))return;let r=s.startsWith("note.")?s.substring(5):s;await this.app.fileManager.processFrontMatter(n,o=>{o[r]=t}),requestAnimationFrame(()=>{setTimeout(()=>{try{this.onDataUpdated()}catch(o){console.error("Error refreshing view after property toggle:",o)}},100)})}catch(n){console.error("Error toggling property:",n)}}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(s=>{let t=s.getAttribute("data-path");t&&this.selectedFiles.add(t)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}updateSelectionUI(){this.containerEl.querySelectorAll(".card").forEach(s=>{let t=s.getAttribute("data-path"),n=s.querySelector('input[type="checkbox"].selection-checkbox');if(t){let r=this.selectedFiles.has(t);r?s.addClass("selected"):s.removeClass("selected"),n&&(n.checked=r)}}),this.selectedFiles.size>0?(this.bulkToolbar||(this.bulkToolbar=new ee(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let s=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&s.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),setTimeout(()=>{s.forEach(t=>{this.app.vault.getAbstractFileByPath(t)&&this.selectedFiles.add(t)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()})),this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()):this.bulkToolbar&&this.bulkToolbar.hide()}onClose(){this.resizeObserver&&this.resizeObserver.disconnect(),this.propertyObservers.forEach(e=>e.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy()}async onNew(){let e=R(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let s=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),t=this.app.vault.getAbstractFileByPath(s);if((!t||!("children"in t))&&(await this.app.vault.createFolder(s),t=this.app.vault.getAbstractFileByPath(s)),t&&"children"in t){let n=await this.app.vault.create(`${s}/Untitled.md`,"");return await this.app.workspace.openLinkText(n.path,"",!1),!0}}catch(s){console.error("[CMS View] Error creating new note:",s)}return!1}};var Oe={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,thumbnailCacheSize:"balanced"};var ie=class extends Re.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new j(this.app,this));try{this.registerBasesView(te,{name:"CMS",icon:this.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(e,s)=>new se(e,s,this),options:this.getCMSViewOptions()})}catch(e){console.log("Bases CMS: Base plugin not available")}}onunload(){}async loadSettings(){this.settings=Object.assign({},Oe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getCMSViewOptions(){let{getCMSViewOptions:e}=(ne(),ue(ye));return e}};
